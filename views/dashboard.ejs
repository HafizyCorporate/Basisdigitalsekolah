<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Portal - Elegant Edition</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #1e293b; }
        .sidebar { background: #0f172a; }
        .card-elegant { background: white; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); transition: all 0.3s ease; }
        
        @keyframes shimmer { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .loading-state { animation: shimmer 1.5s infinite; }

        .alert-elegant {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
            color: white; padding: 1rem 2rem; border-radius: 1rem;
            border-left: 4px solid #6366f1; transform: translateX(120%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .alert-show { transform: translateX(0); }
        
        #teacher-cam { transform: scaleX(-1); object-fit: cover; }
        .scroll-custom::-webkit-scrollbar { width: 4px; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        /* --- TAMBAHAN UNTUK TAMPILAN HP --- */
        @media (max-width: 1023px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            aside { width: 100% !important; height: auto !important; padding: 1rem !important; position: sticky; top: 0; z-index: 100; }
            .sidebar-hide-mobile { display: none; }
            aside h1 { font-size: 1.25rem; }
            main { padding: 1.25rem !important; height: auto !important; overflow: visible !important; }
            header { flex-direction: column; align-items: flex-start !important; gap: 1rem; margin-bottom: 2rem !important; }
            #chat-panel { width: 90% !important; right: 5% !important; top: 15% !important; }
            .card-elegant { padding: 1.5rem !important; }
            #result-container { padding: 1.5rem !important; border-radius: 2rem !important; }
            #empty-state { height: 300px !important; }
            #teacher-cam-container { height: 80px !important; width: 120px !important; margin-bottom: 0 !important; }
            .sidebar-header { flex-direction: row !important; align-items: center; justify-content: space-between; width: 100%; }
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="customAlert" class="alert-elegant flex items-center gap-3">
        <span id="alertIcon">‚ú®</span>
        <span id="alertMsg" class="font-bold text-sm"></span>
    </div>

    <aside class="w-64 sidebar h-full text-white flex flex-col p-6 shadow-2xl">
        <div class="sidebar-header flex flex-col">
            <div class="mb-4 lg:mb-10">
                <h1 class="text-xl font-extrabold text-indigo-400 tracking-tighter italic">GLOBAL AI</h1>
                <p class="text-[9px] text-slate-500 font-mono tracking-widest mt-1 sidebar-hide-mobile">GURU PANEL v2.0</p>
            </div>

            <div class="mb-6 p-4 rounded-2xl bg-white/5 border border-white/10 sidebar-hide-mobile">
                <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-1">Pengajar</p>
                <h3 class="text-sm font-bold truncate"><%= nama_guru %></h3>
            </div>
            
            <div id="teacher-cam-container" class="mb-6 overflow-hidden rounded-2xl bg-slate-800 h-32 border border-white/10 relative">
                <video id="teacher-cam" class="w-full h-full absolute inset-0 bg-black" autoplay playsinline></video>
                <div class="absolute bottom-2 left-2 flex items-center gap-1">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <span class="text-[8px] font-bold uppercase tracking-widest">Live Cam</span>
                </div>
            </div>
        </div>

        <div class="mb-6 flex-1 flex flex-col min-h-0 sidebar-hide-mobile">
            <div class="flex justify-between items-center mb-3">
                <p class="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Absensi Hadir</p>
                <span id="count-absen" class="bg-emerald-500 text-[9px] px-2 py-0.5 rounded-full text-white">0</span>
            </div>
            <div class="flex-1 bg-white/5 border border-white/10 rounded-2xl p-3 overflow-hidden flex flex-col">
                <ul id="list-absen" class="space-y-2 overflow-y-auto scroll-custom text-[11px] font-bold text-slate-400 max-h-40">
                    <li class="italic text-slate-600 font-normal">Menunggu kelas...</li>
                </ul>
                
                <div class="mt-4 pt-4 border-t border-white/10 grid grid-cols-3 gap-1">
                    <button onclick="exportLaporan('pdf')" class="p-2 bg-slate-800 hover:bg-red-500/20 text-[8px] rounded-lg transition-all" title="Download PDF">PDF</button>
                    <button onclick="exportLaporan('excel')" class="p-2 bg-slate-800 hover:bg-emerald-500/20 text-[8px] rounded-lg transition-all" title="Download Excel">XLS</button>
                    <button onclick="exportLaporan('word')" class="p-2 bg-slate-800 hover:bg-blue-500/20 text-[8px] rounded-lg transition-all" title="Download Word">DOC</button>
                </div>
            </div>
        </div>
        
        <div class="pt-6 border-t border-slate-800 sidebar-hide-mobile">
            <a href="/logout" class="text-xs font-bold text-red-400 flex items-center gap-2 hover:opacity-70 transition-all">
                üö™ LOGOUT
            </a>
        </div>
    </aside>

    <main class="flex-1 h-full overflow-y-auto p-8 lg:p-12 relative">
        <div id="chat-panel" class="hidden absolute right-8 top-32 w-80 bg-white border border-slate-200 rounded-3xl shadow-2xl z-50 flex flex-col overflow-hidden animate-pop">
            <div class="p-4 bg-indigo-600 text-white font-bold text-xs flex justify-between items-center">
                <span>CHAT KELAS LIVE</span>
                <button onclick="toggleChat()">‚úï</button>
            </div>
            <div id="chat-box" class="h-80 overflow-y-auto p-4 space-y-3 text-[11px]"></div>
            <div class="p-3 border-t border-slate-100 flex gap-2">
                <input id="chat-input" type="text" placeholder="Ketik pesan..." class="flex-1 bg-slate-50 p-2 rounded-xl text-xs outline-none focus:ring-1 focus:ring-indigo-500">
                <button onclick="sendChat()" class="text-lg">üöÄ</button>
            </div>
        </div>

        <header class="flex justify-between items-end mb-12">
            <div>
                <h2 class="text-2xl lg:text-3xl font-extrabold text-slate-800 leading-tight">Halo, Guru <%= nama_guru %>!</h2>
                <p class="text-slate-500 text-[10px] lg:text-sm mt-1 uppercase tracking-widest font-bold">üè´ <%= instansi %> ‚Ä¢ ID: <%= kode %></p>
            </div>
            <div>
                <div class="card-elegant px-4 py-2 rounded-2xl flex items-center gap-4 bg-white border-indigo-100">
                    <div class="flex flex-col">
                        <span class="text-[8px] font-black text-indigo-400 uppercase">Ruang Kelas</span>
                        <select id="select-kelas" onchange="pindahKelas()" class="text-[11px] font-bold text-slate-700 bg-transparent outline-none">
                            <option value="">-- Pilih Kelas --</option>
                        </select>
                    </div>
                    <button onclick="tambahKelas()" class="w-8 h-8 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-all">Ôºã</button>
                </div>
            </div>
        </header>

        <section class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            <div class="lg:col-span-4">
                <div class="card-elegant p-8 rounded-[2rem]">
                    <div class="flex items-center gap-2 mb-6">
                        <div class="w-1 h-6 bg-indigo-500 rounded-full"></div>
                        <h3 class="font-black text-slate-700 uppercase text-xs tracking-widest">Instruksi AI</h3>
                    </div>
                    <textarea id="prompt" class="w-full h-40 lg:h-56 bg-slate-50 border border-slate-200 rounded-2xl p-5 focus:ring-4 focus:ring-indigo-500/10 outline-none text-slate-700 transition-all resize-none" placeholder="Contoh: Buatkan materi sejarah kemerdekaan RI..."></textarea>
                    
                    <button id="btnGen" onclick="generate()" class="w-full mt-6 bg-slate-900 text-white py-5 rounded-2xl font-black shadow-xl shadow-slate-200 transition-all hover:scale-[1.02] active:scale-95 flex justify-center items-center gap-3">
                        <span id="btnIcon">üöÄ</span> <span id="btnText">PRODUKSI SEKARANG</span>
                    </button>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div id="preview-area" class="hidden">
                    <div class="flex flex-col lg:flex-row justify-between lg:items-center mb-6 gap-3">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em]">Materi Terbuat</span>
                        <div class="flex gap-2">
                            <button id="btnPublish" onclick="publishToStudents()" class="flex-1 lg:flex-none bg-indigo-600 text-white px-6 py-3 rounded-full text-[9px] lg:text-[10px] font-black hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-200 uppercase">Kirim Materi</button>
                            <button id="btnQuiz" onclick="publishQuiz()" class="flex-1 lg:flex-none bg-amber-500 text-white px-6 py-3 rounded-full text-[9px] lg:text-[10px] font-black hover:bg-amber-400 transition-all shadow-lg shadow-amber-200 uppercase flex items-center justify-center gap-1">üéØ Kuis Live</button>
                        </div>
                    </div>
                    <div id="result-container" class="card-elegant p-12 rounded-[3rem] prose prose-slate max-w-none border-t-8 border-indigo-500 overflow-x-auto">
                        <h1 id="res-judul" class="text-slate-800 font-extrabold text-xl lg:text-3xl"></h1>
                        <div id="res-html" class="text-slate-600 leading-relaxed text-sm lg:text-base"></div>
                    </div>
                </div>

                <div id="empty-state" class="card-elegant h-[500px] rounded-[3rem] flex flex-col items-center justify-center border-dashed border-2 border-slate-200 opacity-60">
                    <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center text-3xl mb-4">‚úçÔ∏è</div>
                    <p class="text-slate-400 font-bold uppercase text-xs tracking-widest text-center px-4">Menunggu Input Instruksi Guru</p>
                </div>
            </div>
        </section>

        <button onclick="toggleChat()" class="lg:hidden fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-2xl flex items-center justify-center text-xl z-50">üí¨</button>
    </main>

    <script>
        // --- LOGIKA TIDAK DIRUBAH ---
        const socket = io();
        const namaGuru = "<%= nama_guru %>";
        const kodeSekolah = "<%= kode %>";
        const instansi = "<%= instansi %>";
        let lastGeneratedData = null;
        let currentRoom = null;
        let currentAbsen = [];

        socket.on('update-absen', (daftarMurid) => {
            currentAbsen = daftarMurid;
            const list = document.getElementById('list-absen');
            const count = document.getElementById('count-absen');
            count.innerText = daftarMurid.length;
            list.innerHTML = "";
            if (daftarMurid.length === 0) {
                list.innerHTML = '<li class="italic text-slate-600 font-normal">Belum ada murid hadir.</li>';
                return;
            }
            daftarMurid.forEach(nama => {
                list.innerHTML += `<li class="flex items-center gap-2 text-white/80 animate-pop"><div class="w-1.5 h-1.5 bg-emerald-500 rounded-full shadow-[0_0_8px_#10b981]"></div>${nama}</li>`;
            });
        });

        function exportLaporan(tipe) {
            if(currentAbsen.length === 0) return showAlert("Belum ada data murid!", "‚ö†Ô∏è");
            const timestamp = new Date().toLocaleString('id-ID');
            const dataHeader = [["No", "Nama Siswa", "Waktu Absen"]];
            const dataBody = currentAbsen.map((nama, i) => [i + 1, nama, timestamp]);
            if (tipe === 'excel') {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([[`LAPORAN ABSENSI - ${instansi}`], [`Kelas: ${document.getElementById('select-kelas').value || 'Umum'}`], [], ...dataHeader, ...dataBody]);
                XLSX.utils.book_append_sheet(wb, ws, "Absensi");
                XLSX.writeFile(wb, `Absensi_${new Date().getTime()}.xlsx`);
            } else if (tipe === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text(`LAPORAN ABSENSI - ${instansi}`, 14, 15);
                doc.autoTable({ head: dataHeader, body: dataBody, startY: 30 });
                doc.save(`Absensi_${new Date().getTime()}.pdf`);
            } else if (tipe === 'word') {
                let content = `LAPORAN ABSENSI - ${instansi}\n\n`;
                currentAbsen.forEach((n, i) => content += `${i+1}. ${n}\n`);
                const blob = new Blob([content], {type: 'application/msword'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Absensi_${new Date().getTime()}.doc`;
                link.click();
            }
            showAlert(`Laporan ${tipe.toUpperCase()} berhasil diunduh!`, 'üìÑ');
        }

        socket.emit('join-room', kodeSekolah);

        async function loadKelas() {
            try {
                const res = await fetch(`/api/kelas/${kodeSekolah}`);
                const data = await res.json();
                const select = document.getElementById('select-kelas');
                select.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                data.forEach(k => { select.innerHTML += `<option value="${k.nama_kelas}">${k.nama_kelas}</option>`; });
            } catch (e) { console.error("Gagal memuat kelas"); }
        }

        async function tambahKelas() {
            const nama = prompt("Masukkan Nama Kelas:");
            if(nama) {
                await fetch('/api/kelas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ kode_sekolah: kodeSekolah, nama_kelas: nama })
                });
                loadKelas();
                showAlert(`Kelas ${nama} Berhasil Dibuat!`, 'üè´');
            }
        }

        function pindahKelas() {
            const kelasSelected = document.getElementById('select-kelas').value;
            const newRoom = kelasSelected ? `${kodeSekolah}-${kelasSelected}` : kodeSekolah;
            socket.emit('switch-room', { oldRoom: currentRoom || kodeSekolah, newRoom: newRoom });
            currentRoom = newRoom;
            document.getElementById('chat-box').innerHTML = '';
            showAlert(`Masuk ke Kelas: ${kelasSelected || 'Umum'}`, 'üì°');
        }

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('teacher-cam').srcObject = stream;
            } catch (err) { console.log("Kamera off"); }
        }
        
        window.onload = () => { initCamera(); loadKelas(); };

        async function generate() {
            const btn = document.getElementById('btnGen');
            const btnText = document.getElementById('btnText');
            const prompt = document.getElementById('prompt').value;
            if(!prompt) { showAlert('Harap isi instruksi dulu!', '‚ö†Ô∏è'); return; }
            btn.disabled = true;
            btnText.innerText = "MERACIK...";
            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ instruksi: prompt })
                });
                const data = await res.json();
                lastGeneratedData = data; 
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('preview-area').classList.remove('hidden');
                document.getElementById('res-judul').innerText = data.judul;
                document.getElementById('res-html').innerHTML = data.html;
                showAlert('Materi Selesai!', '‚úÖ');
            } catch (e) { showAlert('Gagal AI.', '‚ùå'); } finally {
                btn.disabled = false;
                btnText.innerText = "PRODUKSI SEKARANG";
            }
        }

        function publishToStudents() {
            if(!lastGeneratedData) return;
            socket.emit('new-materi', { ...lastGeneratedData, room: currentRoom || kodeSekolah });
            showAlert('Materi Terkirim!', 'üöÄ');
        }

        function publishQuiz() {
            if(!lastGeneratedData) return;
            socket.emit('start-quiz', { room: currentRoom || kodeSekolah, judul: lastGeneratedData.judul, soal: lastGeneratedData.soal });
            showAlert('Kuis Dimulai!', 'üéØ');
        }

        function toggleChat() { document.getElementById('chat-panel').classList.toggle('hidden'); }

        function sendChat() {
            const input = document.getElementById('chat-input');
            if(input.value.trim()) {
                socket.emit('chat-message', { user: namaGuru, msg: input.value, room: currentRoom || kodeSekolah, role: 'Guru' });
                input.value = '';
            }
        }

        socket.on('chat-message', (data) => {
            const chatBox = document.getElementById('chat-box');
            const isMe = data.user === namaGuru;
            chatBox.innerHTML += `<div class="${isMe ? 'text-right' : 'text-left'} mb-2"><span class="font-black text-[9px] block text-slate-400 uppercase">${data.user}</span><div class="inline-block p-2 rounded-2xl ${isMe ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-700'} mt-1">${data.msg}</div></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        function showAlert(msg, icon = '‚ú®') {
            const alert = document.getElementById('customAlert');
            document.getElementById('alertMsg').innerText = msg;
            document.getElementById('alertIcon').innerText = icon;
            alert.classList.add('alert-show');
            setTimeout(() => alert.classList.remove('alert-show'), 3000);
        }
    </script>
</body>
</html>
