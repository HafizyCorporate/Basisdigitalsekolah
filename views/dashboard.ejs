<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Teacher Studio - Pro Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- GLOBAL STYLE & SCROLLING --- */
        body { 
            background: #0f172a; /* Slate 900 */
            color: white; 
            font-family: 'Plus Jakarta Sans', sans-serif;
            height: 100vh;
            overflow: hidden; /* Default hidden, nanti di-handle layout */
        }

        /* LAYOUT DENGAN SCROLL */
        .app-layout { 
            display: grid; 
            grid-template-columns: 300px 1fr; 
            height: 100vh; 
            width: 100vw; 
            transition: all 0.3s ease;
        }
        
        body.sidebar-closed .app-layout { grid-template-columns: 0px 1fr; }

        /* SIDEBAR */
        .sidebar { 
            background: #1e293b; 
            border-right: 1px solid #334155; 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; 
            z-index: 50; 
        }

        /* MAIN AREA (SCROLLABLE) */
        .main-content {
            background: #020617;
            overflow-y: auto; /* SCROLL AKTIF DISINI */
            display: flex;
            flex-direction: column;
            position: relative;
            padding: 20px;
            gap: 20px;
        }

        /* HEADER BAR (HAMBURGER DISINI) */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        /* VIDEO WRAPPER */
        .video-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: black;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #334155;
            transition: all 0.3s;
        }
        
        .video-container.pip-mode {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 240px;
            z-index: 100;
            border: 2px solid #fbbf24;
        }

        /* GRID SISWA */
        #student-grid-view { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 10px; 
            margin-bottom: 20px;
        }
        
        .student-card { 
            background: #1e293b; 
            border-radius: 10px; 
            overflow: hidden; 
            position: relative; 
            aspect-ratio: 4/3; 
            border: 1px solid #475569; 
        }
        .student-card video { width: 100%; height: 100%; object-fit: cover; }
        .student-label { 
            position: absolute; bottom: 5px; left: 5px; 
            background: rgba(0,0,0,0.7); padding: 2px 8px; 
            border-radius: 4px; font-size: 10px; font-weight: bold; 
            color: white; backdrop-filter: blur(4px);
        }

        /* CHAT SECTION (DI BAWAH VIDEO) */
        .chat-section {
            background: #1e293b;
            border-radius: 16px;
            border: 1px solid #334155;
            display: flex;
            flex-direction: column;
            height: 350px; /* Tinggi tetap agar tidak terlalu panjang */
            overflow: hidden;
        }

        /* OVERLAYS */
        #presentation-stage { 
            position: absolute; inset: 0; background: white; color: #1e293b; 
            display: none; flex-direction: column; z-index: 20; 
        }
        #presentation-stage.active { display: flex; }

        /* CONTROLS */
        .control-bar {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 50px;
            display: flex;
            gap: 15px;
            border: 1px solid #475569;
            margin: 0 auto;
            width: fit-content;
            position: sticky;
            bottom: 20px;
            z-index: 40;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .ctrl-btn { font-size: 1.1rem; color: #cbd5e1; cursor: pointer; transition: 0.2s; padding: 10px; border-radius: 50%; }
        .ctrl-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .ctrl-btn.active { color: #ef4444; background: rgba(239,68,68,0.1); }
        .ctrl-btn.active-green { color: #10b981; background: rgba(16,185,129,0.1); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar { position: fixed; inset: 0; transform: translateX(-100%); transition: transform 0.3s; z-index: 200; }
            .sidebar.open { transform: translateX(0); }
            body.sidebar-closed .app-layout { grid-template-columns: 1fr; }
        }
        
        #customAlert { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); transition: top 0.5s; z-index: 9999; background: white; color: black; padding: 10px 20px; rounded-full; font-weight: bold; display: flex; items-center; gap: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="sidebar-closed"> 

    <div id="customAlert">
        <span id="alertIcon" class="text-xl"></span>
        <span id="alertMsg">Info</span>
    </div>

    <div class="app-layout">
        
        <aside id="sidebar" class="sidebar">
            <div class="p-5 border-b border-slate-700 flex justify-between items-center sticky top-0 bg-[#1e293b] z-10">
                <div>
                    <h1 class="font-bold text-white text-sm">Teacher Studio</h1>
                    <p class="text-[10px] text-slate-400"><%= nama_guru %></p>
                </div>
                <button onclick="toggleSidebar()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="p-5 space-y-6">
                <div class="bg-slate-800 p-3 rounded-xl border border-slate-700">
                    <label class="text-[10px] font-bold text-amber-400 block mb-1">KELAS AKTIF</label>
                    <div class="flex gap-2">
                        <input type="text" id="nama-kelas" list="list-kelas-guru" onchange="pilihKelasExisting()" class="flex-1 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs text-white" placeholder="Pilih Kelas...">
                        <button onclick="simpanKelasBaru()" class="bg-amber-500 text-slate-900 px-2 rounded hover:bg-amber-400"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <datalist id="list-kelas-guru"></datalist>
                    <div class="mt-2 text-[10px] text-slate-400" id="status-kelas-info">Menunggu...</div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Siswa Online (<span id="count-badge">0</span>)</label>
                    </div>
                    <ul id="mini-list-siswa" class="space-y-1 text-xs text-slate-300 max-h-60 overflow-y-auto">
                        <li class="italic opacity-50 text-center py-2">Belum ada siswa</li>
                    </ul>
                </div>

                <div class="pt-4 border-t border-slate-700 space-y-2">
                    <button onclick="distributeQuiz('PG')" class="w-full py-2 bg-blue-600/20 text-blue-400 border border-blue-600/50 rounded-lg text-xs font-bold hover:bg-blue-600/30">Kirim Soal PG</button>
                    <button onclick="distributeQuiz('ESSAY')" class="w-full py-2 bg-purple-600/20 text-purple-400 border border-purple-600/50 rounded-lg text-xs font-bold hover:bg-purple-600/30">Kirim Soal Essay</button>
                </div>
            </div>
        </aside>

        <main class="main-content">
            
            <div class="header-bar">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="w-10 h-10 bg-slate-800 rounded-full text-white hover:bg-slate-700 transition flex items-center justify-center border border-slate-700">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <div id="live-status" class="px-3 py-1 bg-slate-800 rounded-full text-[10px] font-bold text-slate-400 border border-slate-700 flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-slate-500"></div> OFF AIR
                    </div>
                </div>
                <div class="text-xs font-bold text-slate-400"><%= nama_guru %></div>
            </div>

            <div id="guru-video-wrapper" class="video-container">
                <video id="guru-cam" class="w-full h-full object-cover transform -scale-x-100" autoplay playsinline muted></video>
                <div class="absolute bottom-4 left-4 bg-black/50 px-3 py-1 rounded text-white text-xs backdrop-blur-sm">
                    Kamera Anda
                </div>
            </div>

            <div id="presentation-stage">
                <div class="bg-amber-400 p-3 flex justify-between items-center">
                    <h2 id="slide-judul-besar" class="font-bold text-sm uppercase">Materi Pembelajaran</h2>
                    <div class="flex gap-2">
                        <button onclick="prevSlide()" class="p-1 bg-white rounded"><i class="fa-solid fa-chevron-left"></i></button>
                        <button onclick="nextSlide()" class="p-1 bg-white rounded"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="flex-1 p-8 overflow-y-auto flex flex-col items-center">
                    <img id="slide-img" class="w-full max-w-2xl h-64 object-cover rounded-xl mb-4 shadow-lg" src="">
                    <h1 id="slide-subjudul" class="text-2xl font-bold mb-2">Sub Judul</h1>
                    <div id="slide-konten" class="prose max-w-none text-sm"></div>
                </div>
            </div>

            <div class="control-bar">
                <i class="fa-solid fa-play ctrl-btn active-green" onclick="toggleLive()" id="btn-start" title="Mulai Live"></i>
                <div class="w-[1px] h-6 bg-slate-600 my-auto"></div>
                <i class="fa-solid fa-microphone ctrl-btn" id="btn-mic" onclick="toggleMuteSelf()"></i>
                <i class="fa-solid fa-video ctrl-btn" id="btn-cam" onclick="toggleCamSelf()"></i>
                <div class="w-[1px] h-6 bg-slate-600 my-auto"></div>
                <i class="fa-solid fa-book-open ctrl-btn" onclick="toggleMateriView()" title="Review Materi"></i>
            </div>

            <div>
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">Video Siswa</h3>
                <div id="student-grid-view">
                    </div>
            </div>

            <div class="chat-section">
                <div class="p-3 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-300 uppercase"><i class="fa-solid fa-comments mr-2"></i> Diskusi Kelas</span>
                    <button onclick="togglePinChat()" id="btn-pin" class="text-slate-500 hover:text-amber-400"><i class="fa-solid fa-thumbtack"></i></button>
                </div>
                
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-2 text-xs">
                    <div class="text-center text-slate-600 italic py-4">Belum ada percakapan.</div>
                </div>

                <div class="p-3 bg-slate-800 border-t border-slate-700">
                    <form onsubmit="kirimChat(event)" class="flex gap-2">
                        <input type="text" id="chat-input" class="flex-1 bg-slate-900 border border-slate-600 text-white rounded-lg px-3 py-2 text-xs outline-none focus:border-amber-500" placeholder="Ketik pesan..." autocomplete="off">
                        <button type="submit" class="bg-blue-600 text-white w-9 rounded-lg hover:bg-blue-500 flex items-center justify-center"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                    </form>
                </div>
            </div>

            <div class="bg-slate-800 rounded-xl p-4 border border-slate-700 mt-4">
                <h3 class="text-xs font-bold text-amber-400 uppercase mb-3"><i class="fa-solid fa-trophy mr-2"></i> Nilai Masuk (Live)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs text-slate-300">
                        <thead class="text-slate-500 uppercase border-b border-slate-700">
                            <tr><th class="py-2">Waktu</th><th class="py-2">Nama</th><th class="py-2">Skor</th></tr>
                        </thead>
                        <tbody id="history-table-body">
                            <tr><td colspan="3" class="py-4 text-center italic text-slate-600">Belum ada data.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        const socket = io();
        const namaGuru = "<%= nama_guru %>";
        const kodeSekolah = "<%= kode %>";
        
        let activeRoom = kodeSekolah; 
        let isLive = false;
        let isMutedSelf = false;
        let isCamSelfOff = false;
        let localStream;
        let peers = {}; 
        let studentMap = {}; // MAP NAMA SISWA (ID -> NAMA)
        let lastGeneratedData = null;
        let isChatPinned = false;
        let activeView = 'normal';

        // WEBRTC CONFIG
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // --- 1. SETUP AWAL ---
        async function muatDaftarKelas() {
            try {
                const res = await fetch(`/api/kelas/${kodeSekolah}`);
                const data = await res.json();
                document.getElementById('list-kelas-guru').innerHTML = data.map(k => `<option value="${k.nama_kelas}">`).join('');
                
                const lastClass = localStorage.getItem('lastClass_<%= kode %>');
                if(lastClass) {
                    document.getElementById('nama-kelas').value = lastClass;
                    pilihKelasExisting();
                }
            } catch(e){}
        }

        function pilihKelasExisting() {
            const namaKelas = document.getElementById('nama-kelas').value.trim();
            if(!namaKelas) return;

            activeRoom = `${kodeSekolah}-${namaKelas}`;
            localStorage.setItem('lastClass_<%= kode %>', namaKelas);
            
            // RESET
            Object.keys(peers).forEach(key => { peers[key].close(); delete peers[key]; });
            document.getElementById('student-grid-view').innerHTML = '';
            document.getElementById('mini-list-siswa').innerHTML = '';
            studentMap = {}; // Reset map siswa

            // JOIN
            socket.emit('join-room', { roomID: activeRoom, userName: namaGuru, role: 'Guru' });
            
            document.getElementById('status-kelas-info').innerText = "Aktif: " + namaKelas;
            document.getElementById('status-kelas-info').className = "mt-2 text-[10px] text-green-400 font-bold";
            showAlert(`Pindah ke ${namaKelas}`, "door-open");

            if(isLive) socket.emit('teacher-ready', { room: activeRoom });
        }

        // --- 2. LOGIKA WEBRTC (VIDEO & NAMA BENAR) ---
        
        async function startCamera() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('guru-cam').srcObject = localStream;
                socket.emit('teacher-ready', { room: activeRoom });
            } catch (e) { showAlert("Gagal Kamera", "‚ùå"); }
        }

        function stopCamera() {
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            Object.keys(peers).forEach(key => { peers[key].close(); delete peers[key]; });
        }

        // EVENT: SISWA JOIN (Simpan Nama ke Map)
        socket.on('user-joined', (user) => {
            if(user.role === 'Siswa') {
                studentMap[user.id] = user.name; // SIMPAN NAMA ASLI
                updateAbsensiList(user.id, user.name);
                showAlert(`${user.name} masuk`, "user-plus");
            }
        });

        socket.on('user-left', (data) => {
            if(document.getElementById(`card-${data.id}`)) document.getElementById(`card-${data.id}`).remove();
            if(document.getElementById(`li-${data.id}`)) document.getElementById(`li-${data.id}`).remove();
            if(peers[data.id]) { peers[data.id].close(); delete peers[data.id]; }
            delete studentMap[data.id];
            updateCount();
        });

        // WEBRTC SIGNALING
        socket.on('student-signal', async (data) => {
            // Kita dapat senderId, offer/answer
            // Ambil nama dari map jika ada, atau gunakan default
            const studentName = studentMap[data.senderId] || `Siswa ${data.senderId.substr(0,4)}`;
            
            await handlePeerSignal(data.senderId, data.signal, studentName);
        });

        async function handlePeerSignal(studentId, signal, studentName) {
            let pc = peers[studentId];
            
            if (!pc) {
                pc = new RTCPeerConnection(rtcConfig);
                peers[studentId] = pc;

                if (localStream) {
                    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                }

                pc.ontrack = (event) => {
                    addStudentVideo(studentId, event.streams[0], studentName);
                };

                pc.onicecandidate = (event) => {
                    if (event.candidate) socket.emit('teacher-signal', { targetId: studentId, signal: { candidate: event.candidate } });
                };
            }

            if (signal.type === 'offer') {
                await pc.setRemoteDescription(new RTCSessionDescription(signal));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit('teacher-signal', { targetId: studentId, signal: answer });
            } else if (signal.candidate) {
                try { await pc.addIceCandidate(new RTCIceCandidate(signal.candidate)); } catch(e){}
            }
        }

        // FUNGSI RENDER VIDEO SISWA DENGAN NAMA BENAR
        function addStudentVideo(id, stream, name) {
            const grid = document.getElementById('student-grid-view');
            let card = document.getElementById(`card-${id}`);
            
            if(!card) {
                card = document.createElement('div');
                card.id = `card-${id}`;
                card.className = "student-card";
                card.innerHTML = `
                    <video id="vid-${id}" autoplay playsinline></video>
                    <div class="student-label">${name}</div>
                `;
                grid.appendChild(card);
            }
            const vid = document.getElementById(`vid-${id}`);
            if(vid) vid.srcObject = stream;
        }

        // FUNGSI ABSENSI SIDEBAR
        function updateAbsensiList(id, name) {
            const list = document.getElementById('mini-list-siswa');
            if(list.innerHTML.includes('Belum ada')) list.innerHTML = '';
            
            if(!document.getElementById(`li-${id}`)) {
                list.innerHTML += `
                    <li id="li-${id}" class="flex items-center gap-2 p-2 bg-slate-800 rounded border border-slate-700">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="font-bold text-slate-300">${name}</span>
                    </li>`;
                updateCount();
            }
        }

        function updateCount() {
            const list = document.getElementById('mini-list-siswa');
            document.getElementById('count-badge').innerText = list.children.length;
        }

        // --- 3. LIVE & CONTROLS ---
        function toggleLive() {
            const status = document.getElementById('live-status');
            const btn = document.getElementById('btn-start');
            
            if (!isLive) {
                if(activeRoom === kodeSekolah) return showAlert("Pilih Kelas Dulu!", "‚ö†Ô∏è");
                startCamera();
                isLive = true;
                status.innerHTML = `<div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div> ON AIR`;
                status.classList.replace('text-slate-400', 'text-red-400');
                btn.classList.replace('active-green', 'active'); // Jadi Merah
                btn.className = "fa-solid fa-stop ctrl-btn active";
                showAlert("Live Dimulai", "üì°");
            } else {
                stopCamera();
                isLive = false;
                status.innerHTML = `<div class="w-2 h-2 rounded-full bg-slate-500"></div> OFF AIR`;
                status.classList.replace('text-red-400', 'text-slate-400');
                btn.className = "fa-solid fa-play ctrl-btn active-green";
                showAlert("Live Berhenti", "üõë");
            }
        }

        function toggleMuteSelf() {
            isMutedSelf = !isMutedSelf;
            if(localStream) localStream.getAudioTracks()[0].enabled = !isMutedSelf;
            const btn = document.getElementById('btn-mic');
            btn.className = isMutedSelf ? "fa-solid fa-microphone-slash ctrl-btn active" : "fa-solid fa-microphone ctrl-btn";
        }

        function toggleCamSelf() {
            isCamSelfOff = !isCamSelfOff;
            if(localStream) localStream.getVideoTracks()[0].enabled = !isCamSelfOff;
            const btn = document.getElementById('btn-cam');
            btn.className = isCamSelfOff ? "fa-solid fa-video-slash ctrl-btn active" : "fa-solid fa-video ctrl-btn";
        }

        function toggleMateriView() {
            if(!lastGeneratedData) return showAlert("Generate materi dulu!", "‚ö†Ô∏è");
            
            const stage = document.getElementById('presentation-stage');
            const videoWrapper = document.getElementById('guru-video-wrapper');
            
            if (activeView === 'normal') {
                stage.classList.add('active');
                videoWrapper.classList.remove('default-mode');
                videoWrapper.classList.add('pip-mode'); // Video mengecil ke pojok
                activeView = 'materi';
                renderSlide();
            } else {
                stage.classList.remove('active');
                videoWrapper.classList.add('default-mode');
                videoWrapper.classList.remove('pip-mode');
                activeView = 'normal';
            }
        }

        // --- 4. CHAT ---
        function kirimChat(e) {
            e.preventDefault();
            const inp = document.getElementById('chat-input');
            const msg = inp.value.trim();
            if(!msg) return;
            
            socket.emit('chat-message', { room: activeRoom, user: namaGuru, msg: msg, role: 'Guru', isPinned: isChatPinned });
            inp.value = '';
        }

        socket.on('chat-message', (data) => {
            const box = document.getElementById('chat-container');
            if(box.innerText.includes('Belum ada')) box.innerHTML = '';
            
            const isMe = data.user === namaGuru;
            const bg = isMe ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300';
            const align = isMe ? 'items-end' : 'items-start';
            
            box.innerHTML += `
                <div class="flex flex-col ${align}">
                    <span class="text-[10px] text-slate-500 font-bold mb-1">${data.user} ${data.isPinned?'üìå':''}</span>
                    <div class="${bg} px-3 py-2 rounded-xl text-xs max-w-[85%] shadow-sm leading-relaxed ${data.isPinned ? 'border border-amber-400':''}">${data.msg}</div>
                </div>`;
            box.scrollTop = box.scrollHeight;
        });

        // --- 5. SCOREBOARD & EXPORT ---
        socket.on('score-updated-live', (data) => {
            const tbody = document.getElementById('history-table-body');
            if(tbody.innerText.includes('Belum ada')) tbody.innerHTML = '';
            
            tbody.innerHTML = `
                <tr class="border-b border-slate-700 animate-pulse">
                    <td class="py-2 text-slate-400">${data.waktu}</td>
                    <td class="py-2 font-bold text-white">${data.nama_siswa}</td>
                    <td class="py-2 font-black text-emerald-400">${data.skor}</td>
                </tr>` + tbody.innerHTML;
        });

        // --- GENERATE MATERI & QUIZ ---
        async function generate() {
            const btn = document.getElementById('btnGen');
            const prompt = document.getElementById('prompt').value;
            if(!prompt) return showAlert("Isi topik materi!", "‚úçÔ∏è");

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';
            
            try {
                const res = await fetch('/api/generate', { 
                    method: 'POST', 
                    headers: {'Content-Type':'application/json'}, 
                    body: JSON.stringify({instruksi: prompt}) 
                });
                const data = await res.json();
                lastGeneratedData = data;
                
                if(data.slides && data.slides.length > 0) {
                    currentSlides = data.slides;
                    currentSlideIndex = 0;
                    document.getElementById('slide-judul-besar').innerText = data.judul_besar;
                    renderSlide();
                    document.getElementById('quiz-controller').style.display = 'block';
                    showAlert("Materi Siap!", "‚úÖ");
                    toggleMateriView(); // Auto buka mode materi
                }
            } catch(e) { showAlert("Gagal Generate", "‚ùå"); }
            btn.innerHTML = 'Buat Materi';
        }

        // Render Slide Logic
        function renderSlide() {
            if(!currentSlides.length) return;
            const s = currentSlides[currentSlideIndex];
            document.getElementById('slide-subjudul').innerText = s.judul_slide;
            document.getElementById('slide-konten').innerHTML = s.konten_html;
            document.getElementById('slide-img').src = `https://image.pollinations.ai/prompt/${encodeURIComponent(s.keyword_gambar)}?width=800&height=400&nologo=true`;
            
            if(activeRoom !== kodeSekolah) {
                socket.emit('change-slide', { room: activeRoom, slideIndex: currentSlideIndex });
            }
        }
        function nextSlide() { if(currentSlideIndex < currentSlides.length-1) { currentSlideIndex++; renderSlide(); } }
        function prevSlide() { if(currentSlideIndex > 0) { currentSlideIndex--; renderSlide(); } }

        function distributeQuiz(type) {
            if (!lastGeneratedData) return showAlert("Belum ada materi!", "‚ö†Ô∏è");
            if (activeRoom === kodeSekolah) return showAlert("Pilih kelas dulu!", "‚ö†Ô∏è");

            let dataToSend = {
                room: activeRoom, 
                type: type,
                materi_judul: lastGeneratedData.judul_besar || lastGeneratedData.judul
            };
            if (type === 'PG') dataToSend.soal_pg = lastGeneratedData.soal_pg;
            if (type === 'ESSAY') dataToSend.soal_essay = lastGeneratedData.soal_essay;

            socket.emit('start-quiz', dataToSend);
            showAlert(`Soal ${type} Terkirim!`, "üöÄ");
        }

        // Utils
        function toggleSidebar() { document.body.classList.toggle('sidebar-closed'); }
        function togglePinChat() { isChatPinned = !isChatPinned; document.getElementById('btn-pin').classList.toggle('text-amber-400'); }
        function showAlert(msg, icon) {
            const el = document.getElementById('customAlert');
            document.getElementById('alertMsg').innerText = msg;
            document.getElementById('alertIcon').innerText = icon;
            el.style.top = "20px";
            setTimeout(() => el.style.top = "-100px", 3000);
        }
        async function simpanKelasBaru() {
            const nama = document.getElementById('nama-kelas').value;
            if(nama) {
                await fetch('/api/tambah-kelas', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({kode_sekolah:"<%= kode %>", nama_kelas:nama})});
                muatDaftarKelas();
                pilihKelasExisting();
            }
        }

        muatDaftarKelas();
    </script>
</body>
</html>
