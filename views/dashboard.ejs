<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Teacher Studio - Pro Live</title>
    
     <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' },
                        dark: { 800: '#0f172a', 900: '#020617' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background: #020617; overflow: hidden; height: 100vh; touch-action: none; color: white; }
        .app-layout { display: grid; grid-template-columns: 340px 1fr; height: 100vh; width: 100vw; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        body.sidebar-closed .app-layout { grid-template-columns: 0px 1fr; }
        .sidebar { background: #ffffff; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; white-space: nowrap; position: relative; z-index: 50; }
        
        /* Main Stage & Background Kosmik */
        .main-stage { position: relative; background: radial-gradient(circle at 50% 0%, #1e1b4b 0%, #020617 80%); display: flex; align-items: center; justify-content: center; overflow: hidden; width: 100%; height: 100%; flex-direction: column; }
        
         /* Container Studio (Kamera + Chat) */
        .studio-container { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; max-width: 900px; transition: all 0.5s ease; z-index: 50; height: 80%; justify-content: center; pointer-events: none; }
        .studio-container > * { pointer-events: auto; }
        
         /* VIDEO WRAPPER PREMIUM */
        .video-wrapper { position: relative; transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.7); background: #000; z-index: 10; }
        .video-wrapper.default-mode { width: 100%; height: 60%; border-radius: 24px; border: 2px solid rgba(255,255,255,0.1); }
        .video-wrapper.full-mode { position: fixed; inset: 0; width: 100vw; height: 100vh; border-radius: 0; border: none; z-index: 100; }
        
        /* PIP MODE: Kamera ke kanan bawah, posisinya DINAIKKAN (bottom: 110px) agar tidak tertabrak control bar */
        .video-wrapper.pip-mode { position: fixed; bottom: 110px; right: 20px; width: 280px; height: 160px; z-index: 150; border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.8); border: 2px solid rgba(16, 185, 129, 0.8); }
        
        /* TRIK VISUAL: Paksa Control Bar lepas dari kamera saat PiP dan diam di tengah bawah */
        .video-wrapper.pip-mode #main-control-bar { position: fixed !important; bottom: 30px !important; left: 50% !important; transform: translateX(-50%) !important; z-index: 200 !important; width: max-content !important; }

        /* Ruang kosong di bawah agar Control Bar tidak menghalangi materi/grid */
        #student-grid-view, #presentation-stage { padding-bottom: 140px !important; }




        /* INTEGRATED CHAT (Di Bawah Kamera) */
        .integrated-chat { width: 100%; height: 35%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border-radius: 24px; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; overflow: hidden; box-shadow: inset 0 2px 20px rgba(0,0,0,0.5); transition: opacity 0.3s, transform 0.3s; }
        .integrated-chat.hidden-mode { opacity: 0; pointer-events: none; transform: translateY(20px) scale(0.95); position: absolute; z-index: -1; }
        
        .stage-overlay { position: absolute; inset: 0; z-index: 40; background: #0f172a; display: none; opacity: 0; transition: opacity 0.3s; }
        .stage-overlay.active { display: block; opacity: 1; }
        
        #student-grid-view { display: none; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; padding: 30px; align-content: start; overflow-y: auto; background: radial-gradient(circle at top, #1e293b, #020617); }
        #student-grid-view.active { display: grid; }

        #presentation-stage { padding: 0; overflow: hidden; background: #ffffff; display: none; flex-direction: column; z-index: 40; }
        #presentation-stage.active { display: flex; }
        
        /* Top Status Bar (Mewah) */
        .top-status-bar { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 70; pointer-events: none; }
        .status-pill { background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); padding: 8px 20px; border-radius: 99px; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: all 0.3s; }
        
        /* Control Bar Super Premium */
        .control-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(25px); padding: 12px 20px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.15); display: flex; align-items: center; gap: 10px; z-index: 70; box-shadow: 0 25px 50px rgba(0,0,0,0.8); white-space: nowrap; transition: all 0.3s; }
        .control-bar:hover { border-color: rgba(255,255,255,0.3); }
        .ctrl-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 60px; height: 60px; border-radius: 16px; color: #94a3b8; cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); gap: 6px; background: rgba(255,255,255,0.03); border: 1px solid transparent; }
        .ctrl-btn:hover { background: rgba(255,255,255,0.1); color: white; transform: translateY(-3px); border-color: rgba(255,255,255,0.1); }
        .ctrl-btn.active { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; box-shadow: 0 8px 20px rgba(37, 99, 235, 0.5); border: none; }
        .ctrl-btn.danger { background: rgba(239, 68, 68, 0.1); color: #f87171; }
        .ctrl-btn.danger:hover { background: rgba(239, 68, 68, 0.2); transform: translateY(-3px); }
        .ctrl-btn.danger.active { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.5); }
        .ctrl-icon { font-size: 20px; }
        .ctrl-label { font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .divider { width: 2px; height: 36px; background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.1), transparent); margin: 0 6px; }

        /* Custom Alert */
        #customAlert { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); transition: top 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 100; background: linear-gradient(to right, #ffffff, #f8fafc); color: #0f172a; padding: 14px 28px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; border-radius: 99px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); font-weight: 700; font-size: 14px; }
        
        .student-card { background: #1e293b; border-radius: 16px; overflow: hidden; position: relative; aspect-ratio: 16/9; border: 1px solid #334155; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .student-card video { width: 100%; height: 100%; object-fit: cover; }
        .student-label { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); color: white; padding: 4px 12px; border-radius: 8px; font-size: 11px; font-weight: bold; border: 1px solid rgba(255,255,255,0.1); }

        @media (max-width: 1024px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar { position: fixed; inset: 0; width: 100%; transform: translateX(-100%); transition: transform 0.3s; z-index: 100;}
            .sidebar.open { transform: translateX(0); }
            body.sidebar-closed .app-layout { grid-template-columns: 1fr; }
            .control-bar { bottom: 20px; padding: 10px; width: 95%; max-width: 500px; justify-content: space-between; gap: 2px;}
            .ctrl-btn { width: 50px; height: 50px; }
            .ctrl-icon { font-size: 16px; }
            .ctrl-label { font-size: 8px; }
            .studio-container { height: 85%; }
        }
        
    </style>
</head>
<body class="sidebar-closed"> 

    <div id="customAlert">
        <span id="alertIcon" class="text-xl"></span>
        <span id="alertMsg">Info</span>
    </div>

    <div class="app-layout">
                <aside id="sidebar" class="sidebar shadow-2xl">
            <div class="bg-gradient-to-r from-emerald-600 to-teal-800 text-white text-[10px] font-bold text-center py-2 flex items-center justify-center gap-2 tracking-widest shadow-md">
                <i class="fa-solid fa-moon text-yellow-300"></i>
                ‚ú® SEMANGAT RAMADHAN, SEMANGAT PUASA 2026 üïå
            </div>
            <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-white sticky top-0 z-10">

                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-brand-100 text-brand-600 flex items-center justify-center font-bold">
                        <i class="fa-solid fa-chalkboard-user"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-slate-800 text-sm leading-tight">Teacher Studio</h1>
                        <p class="text-[10px] text-slate-500 font-medium"><%= nama_guru %></p>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="w-8 h-8 rounded-full bg-slate-50 border border-slate-200 text-slate-500 hover:bg-red-50 hover:text-red-500 hover:border-red-100 flex items-center justify-center transition" title="Tutup / Kembali">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-5 space-y-6">
      
                <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles text-brand-500 text-xs"></i>
                        <label class="text-[11px] font-bold text-slate-700 uppercase tracking-wide">AI Materi Generator</label>
                    </div>
                    <div class="bg-slate-50 p-1 rounded-2xl border border-slate-200 focus-within:ring-2 focus-within:ring-brand-100 transition">
                        <textarea id="prompt" class="w-full bg-transparent border-none p-3 text-xs text-slate-700 h-20 resize-none outline-none placeholder:text-slate-400" placeholder="Topik materi (cth: Perang Dunia II)..."></textarea>
                    </div>
                    <button onclick="generate()" id="btnGen" class="w-full py-2.5 bg-slate-900 text-white rounded-xl text-xs font-bold hover:bg-brand-600 hover:shadow-lg transition flex items-center justify-center gap-2">
                        <span>Buat Materi & Soal</span> <i class="fa-solid fa-bolt"></i>
                    </button>

                    <div id="quiz-controller">
                        <label class="text-[9px] font-bold text-slate-500 uppercase block mb-2 text-center">Distribusi Soal ke Siswa</label>
                        <div class="grid grid-cols-1 gap-2">
                            <button onclick="distributeQuiz('PG')" class="py-2 bg-blue-100 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-200 transition text-left px-3 flex justify-between items-center">
                                <span><i class="fa-solid fa-list-check mr-2"></i>Kirim 15 Soal PG</span>
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                            <button onclick="distributeQuiz('ESSAY')" class="py-2 bg-purple-100 text-purple-700 rounded-lg text-xs font-bold hover:bg-purple-200 transition text-left px-3 flex justify-between items-center">
                                <span><i class="fa-solid fa-pen-nib mr-2"></i>Kirim 5 Soal Essay</span>
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                            <button onclick="distributeQuiz('QUIZ')" class="py-2 bg-orange-100 text-orange-700 rounded-lg text-xs font-bold hover:bg-orange-200 transition text-left px-3 flex justify-between items-center">
                                <span><i class="fa-solid fa-stopwatch mr-2"></i>Kirim 10 Flash Quiz</span>
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="border-t border-slate-100"></div>

                <div class="space-y-3">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fa-solid fa-file-export text-green-600 text-xs"></i>
                        <label class="text-[11px] font-bold text-slate-700 uppercase tracking-wide">Pusat Unduhan</label>
                    </div>

                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div class="text-[10px] font-bold text-slate-500 mb-2">Materi Pembelajaran</div>
                        <div class="flex gap-2">
                             <button onclick="exportData('Materi', 'PDF')" class="flex-1 py-1.5 bg-red-50 text-red-600 border border-red-100 rounded-lg text-xs hover:bg-red-100 transition" title="Unduh PDF"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                             <button onclick="exportData('Materi', 'Excel')" class="flex-1 py-1.5 bg-green-50 text-green-600 border border-green-100 rounded-lg text-xs hover:bg-green-100 transition" title="Unduh Excel"><i class="fa-solid fa-file-excel"></i> XLSX</button>
                             <button onclick="exportData('Materi', 'Word')" class="flex-1 py-1.5 bg-blue-50 text-blue-600 border border-blue-100 rounded-lg text-xs hover:bg-blue-100 transition" title="Unduh Word"><i class="fa-solid fa-file-word"></i> Word</button>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div class="text-[10px] font-bold text-slate-500 mb-2">Nilai / Live Score</div>
                        <div class="flex flex-col gap-2">
                            <div class="flex gap-2">
                                <button onclick="exportData('Nilai', 'PDF')" class="flex-1 py-1.5 bg-red-50 text-red-600 border border-red-100 rounded-lg text-xs hover:bg-red-100 transition"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                                <button onclick="exportData('Nilai', 'Excel')" class="flex-1 py-1.5 bg-green-50 text-green-600 border border-green-100 rounded-lg text-xs hover:bg-green-100 transition"><i class="fa-solid fa-file-excel"></i> XLSX</button>
                                <button onclick="exportData('Nilai', 'Word')" class="flex-1 py-1.5 bg-blue-50 text-blue-600 border border-blue-100 rounded-lg text-xs hover:bg-blue-100 transition"><i class="fa-solid fa-file-word"></i> Word</button>
                            </div>
                            <button onclick="toggleHistoryModal()" class="w-full py-2 bg-slate-800 text-white border border-slate-900 rounded-lg text-xs font-bold hover:bg-slate-700 transition flex items-center justify-center gap-2">
                                <i class="fa-solid fa-clock-rotate-left"></i> Lihat Log & Riwayat
                            </button>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div class="text-[10px] font-bold text-slate-500 mb-2">Absensi Kehadiran</div>
                        <div class="flex gap-2">
                            <button onclick="exportData('Absen', 'PDF')" class="flex-1 py-1.5 bg-red-50 text-red-600 border border-red-100 rounded-lg text-xs hover:bg-red-100 transition"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                            <button onclick="exportData('Absen', 'Word')" class="flex-1 py-1.5 bg-blue-50 text-blue-600 border border-blue-100 rounded-lg text-xs hover:bg-blue-100 transition"><i class="fa-solid fa-file-word"></i> Word</button>
                            <button onclick="exportData('Absen', 'Excel')" class="flex-1 py-1.5 bg-green-50 text-green-600 border border-green-100 rounded-lg text-xs hover:bg-green-100 transition"><i class="fa-solid fa-file-excel"></i> Excel</button>
                        </div>
                    </div>
                </div>

                <div class="border-t border-slate-100"></div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-users text-slate-400 text-xs"></i>
                            <label class="text-[11px] font-bold text-slate-700 uppercase tracking-wide">Siswa Online</label>
                        </div>
                        <span id="count-badge" class="bg-green-100 text-green-700 px-2 py-0.5 rounded-md text-[9px] font-bold">0</span>
                    </div>
                    <ul id="mini-list-siswa" class="space-y-1">
                        <li class="text-[11px] text-slate-400 italic text-center py-4 bg-slate-50 rounded-lg">Menunggu siswa di kelas...</li>
                    </ul>
                </div>
            </div>
        </aside>

            <main class="main-stage">
            <div class="absolute top-10 left-10 text-4xl animate-bounce drop-shadow-2xl z-0 opacity-40">üèÆ</div>
            <div class="absolute top-16 right-24 text-6xl opacity-30 z-0 drop-shadow-[0_0_20px_rgba(253,224,71,0.8)]">üåô</div>
            <div class="absolute bottom-20 left-1/4 text-3xl animate-pulse drop-shadow-2xl z-0 opacity-30">üèÆ</div>

               
<div id="start-overlay" class="start-overlay flex flex-col items-center justify-center" style="background: radial-gradient(circle at 50% 50%, #0f172a 0%, #000000 100%); overflow: hidden; position: absolute; inset:0; z-index:80; transition:opacity 0.4s;">

                <div class="absolute top-0 left-1/4 w-96 h-96 bg-brand-600/20 rounded-full mix-blend-screen filter blur-[100px] animate-pulse pointer-events-none"></div>
                <div class="absolute bottom-0 right-1/4 w-96 h-96 bg-indigo-600/20 rounded-full mix-blend-screen filter blur-[100px] animate-pulse pointer-events-none" style="animation-delay: 2s;"></div>

                <div class="text-center scale-95 relative z-10 w-full max-w-md px-6 animate-[fadeInUp_0.6s_ease-out_forwards]">
                    <div class="w-24 h-24 bg-gradient-to-tr from-brand-600 to-indigo-600 rounded-[2rem] flex items-center justify-center shadow-[0_0_40px_rgba(37,99,235,0.4)] mb-6 mx-auto border border-white/20">
                        <i class="fa-solid fa-chalkboard-user text-5xl text-white drop-shadow-lg"></i>
                    </div>
                    <h2 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-300 mb-2 tracking-tight drop-shadow-sm">Teacher Studio</h2>
                    <p class="text-slate-400 text-sm mb-8">Pilih atau buat kelas terlebih dahulu</p>
                    
                    <div class="bg-white/10 backdrop-blur-xl border border-white/20 p-5 rounded-2xl shadow-2xl mb-8 text-left relative z-20">
                        <label class="text-xs font-bold text-slate-300 uppercase tracking-wider block mb-3"><i class="fa-solid fa-school text-brand-400 mr-2"></i>Daftar Kelas</label>
                        <div class="flex gap-2">
                            <input type="text" id="nama-kelas" list="list-kelas-guru" onchange="pilihKelasExisting()" class="flex-1 bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-3 text-sm font-bold text-white focus:outline-none focus:ring-2 focus:ring-brand-500 placeholder:text-slate-500 transition" placeholder="Ketik nama kelas...">
                            <button onclick="simpanKelasBaru()" class="bg-brand-600 text-white px-4 py-3 rounded-xl hover:bg-brand-500 transition flex items-center justify-center gap-2"><i class="fa-solid fa-floppy-disk"></i> <span class="hidden sm:inline text-xs font-bold">Simpan</span></button>
                        </div>
                        <datalist id="list-kelas-guru"></datalist>
                        <div class="mt-3 flex items-center gap-2">
                            <i class="fa-solid fa-circle-info text-slate-500 text-[10px]" id="status-kelas-icon"></i>
                            <p class="text-[11px] text-slate-400 font-medium" id="status-kelas-info">Menunggu Anda memilih kelas...</p>
                        </div>
                    </div>
                    <button onclick="toggleLive()" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-2xl font-bold text-lg shadow-[0_10px_30px_rgba(16,185,129,0.3)] hover:-translate-y-1 transition flex items-center justify-center gap-3 border border-white/20">
                        <i class="fa-solid fa-video text-xl"></i> MULAI LIVE
                    </button>
                </div>
            </div>

                                <div id="studio-container" class="studio-container">
                
                           <div id="top-header-bar" class="w-full flex justify-between items-center z-[150] px-2 transition-all duration-300" style="max-width: 900px;">
                    <div class="bg-black/50 backdrop-blur-md border border-emerald-500/40 px-4 py-2.5 rounded-2xl flex items-center gap-3 shadow-[0_0_20px_rgba(16,185,129,0.2)]">                    
                        <i class="fa-solid fa-graduation-cap text-emerald-400 text-xl drop-shadow-[0_0_8px_rgba(52,211,153,0.8)]"></i>
                        <div class="w-[1px] h-5 bg-white/20"></div>
                        <div id="status-dot" class="w-2 h-2 rounded-full bg-yellow-500 shadow-[0_0_10px_rgba(234,179,8,0.8)]"></div>
                        <span id="status-text" class="text-[10px] font-black tracking-widest text-white uppercase">STANDBY</span>
                    </div>

                    <button onclick="toggleSidebar()" class="w-12 h-12 bg-black/50 backdrop-blur-md border border-white/20 text-white rounded-2xl flex items-center justify-center hover:bg-emerald-600 hover:border-emerald-400 transition-all duration-300 shadow-lg" title="Buka Menu">
                        <i class="fa-solid fa-bars-staggered text-lg"></i>
                    </button>
                </div>

                                      
                                                      <div id="guru-video-wrapper" class="video-wrapper default-mode relative group">
                    <video id="guru-cam" class="w-full h-full object-cover transform -scale-x-100" autoplay playsinline muted></video>
                
                    <div id="main-control-bar" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/70 backdrop-blur-2xl px-6 py-3 rounded-[2rem] border border-white/20 flex items-center gap-1 z-[200] shadow-[0_20px_50px_rgba(0,0,0,0.9)] w-[95%] sm:w-auto justify-between transition-all duration-300">
                        <div class="ctrl-btn" onclick="toggleLive()" id="btn-start" title="Mulai / Jeda Live">
                            <i class="fa-solid fa-power-off ctrl-icon"></i> <span class="ctrl-label">Live</span>
                        </div>
                        <div class="divider"></div>
                        <div class="ctrl-btn" onclick="toggleMuteSelf()" id="btn-mic" title="Matikan/Hidupkan Mic">
                            <i class="fa-solid fa-microphone ctrl-icon"></i> <span class="ctrl-label">Mic</span>
                        </div>
                        <div class="ctrl-btn" onclick="toggleCamSelf()" id="btn-cam" title="Matikan/Hidupkan Kamera">
                            <i class="fa-solid fa-video ctrl-icon"></i> <span class="ctrl-label">Cam</span>
                        </div>
                        <div class="ctrl-btn" onclick="toggleScreenSize()" id="btn-screen" title="Ubah Layar">
                            <i class="fa-solid fa-expand ctrl-icon"></i> <span class="ctrl-label">Layar</span>
                        </div>
                        <div class="divider"></div>
                        <div class="ctrl-btn" onclick="toggleGridView()" id="btn-grid-murid" title="Tampilkan Semua Siswa">
                            <i class="fa-solid fa-users-viewfinder ctrl-icon"></i> <span class="ctrl-label">Siswa</span>
                        </div>
                        <div class="ctrl-btn" onclick="toggleMateriView()" id="btn-grid-materi" title="Tampilkan Materi">
                            <i class="fa-solid fa-chalkboard ctrl-icon"></i> <span class="ctrl-label">Materi</span>
                        </div>
                        <div class="divider hidden sm:block"></div>
                        <div class="ctrl-btn danger hidden sm:flex" onclick="muteAllStudents()" title="Bisukan Siswa">
                            <i class="fa-solid fa-volume-xmark ctrl-icon"></i> <span class="ctrl-label">Mute All</span>
                        </div>
                    </div>
                </div> <div id="integrated-chat" class="integrated-chat">

                                      
                    <div class="bg-black/40 p-3 border-b border-white/10 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-messages text-brand-400 animate-bounce"></i>
                            <span class="text-xs font-black text-white uppercase tracking-wider">Live Chat Siswa</span>
                        </div>
                        <span class="text-[10px] bg-brand-600/30 text-brand-300 px-2 py-1 rounded font-bold">Aktif</span>
                    </div>
                    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-hide text-sm">
                        <div class="text-center text-xs text-slate-400 italic py-6">Ruang obrolan kelas siap digunakan...</div>
                    </div>
                    <div class="p-2 bg-black/40 border-t border-white/10">
                       <form onsubmit="kirimChat(event)" class="flex gap-2">
                            <input type="text" id="chat-input" class="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-2 text-xs text-white outline-none focus:border-brand-500 transition" placeholder="Sapa siswa Anda..." autocomplete="off">
                            <button type="submit" class="bg-brand-600 text-white rounded-xl w-12 h-10 flex items-center justify-center hover:bg-brand-500 transition shadow-lg"><i class="fa-solid fa-paper-plane"></i></button>
                        </form>
                    </div> 
                </div> 
            </div> <div id="student-grid-view" class="stage-overlay"></div>

                
            <div id="presentation-stage" class="stage-overlay flex flex-col h-full bg-slate-50 text-slate-800 p-0 overflow-hidden">
                <div class="bg-slate-900 p-4 flex justify-between items-center shadow-lg z-10 border-b-4 border-brand-500">
                    <h1 id="slide-judul-besar" class="text-lg font-black text-white tracking-wide truncate max-w-[50%] flex items-center gap-3"><i class="fa-solid fa-book-open-reader text-brand-400"></i> Materi</h1>
                    <div class="flex gap-2 items-center">
                        <button onclick="prevSlide()" class="w-10 h-10 bg-slate-800 text-white rounded-xl flex items-center justify-center hover:bg-brand-600 transition shadow border border-slate-700"><i class="fa-solid fa-chevron-left"></i></button>
                        <span id="page-indicator" class="bg-black/50 text-brand-400 px-4 py-2 rounded-xl font-bold text-xs border border-slate-700">1 / 1</span>
                        <button onclick="nextSlide()" class="w-10 h-10 bg-slate-800 text-white rounded-xl flex items-center justify-center hover:bg-brand-600 transition shadow border border-slate-700"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-6 md:p-10 relative scrollbar-hide">
                    <div class="mb-6 rounded-3xl overflow-hidden h-48 md:h-72 bg-slate-200 relative group shadow-2xl border border-slate-300">
                        <img id="slide-img" src="" class="w-full h-full object-cover transition duration-700 group-hover:scale-105">
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent p-4 text-left">
                            <p id="slide-keyword" class="text-brand-300 text-[10px] uppercase font-black tracking-widest"><i class="fa-solid fa-image mr-1"></i> Visual: ...</p>
                        </div>
                    </div>
                    <h2 id="slide-subjudul" class="text-3xl font-black text-slate-900 mb-4 border-l-4 border-brand-500 pl-4">Sub Judul</h2>
                    <div id="slide-konten" class="prose prose-lg max-w-none text-slate-700 leading-relaxed font-medium"></div>
                </div>
            </div>

            </div>
        </main>
    </div>

    <div id="history-modal" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden transform scale-95 transition-transform duration-300" id="history-content">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h2 class="text-xl font-bold text-slate-800"><i class="fa-solid fa-trophy text-yellow-500 mr-2"></i>Live Scoreboard & Riwayat</h2>
                    <p class="text-xs text-slate-500 mt-1">Mencatat nilai yang masuk secara real-time sesi ini.</p>
                </div>
                <button onclick="toggleHistoryModal()" class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 hover:text-red-500 hover:bg-red-50 flex items-center justify-center transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex-1 overflow-auto p-0">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 sticky top-0 z-10">
                        <tr>
                            <th class="p-4 text-[10px] font-black uppercase text-slate-400 tracking-wider">Waktu Submit</th>
                            <th class="p-4 text-[10px] font-black uppercase text-slate-400 tracking-wider">Nama Siswa</th>
                            <th class="p-4 text-[10px] font-black uppercase text-slate-400 tracking-wider">Tipe Soal</th>
                            <th class="p-4 text-[10px] font-black uppercase text-slate-400 tracking-wider text-right">Skor</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="text-sm text-slate-700 divide-y divide-slate-100">
                        <tr id="empty-history">
                            <td colspan="4" class="p-10 text-center text-slate-400 italic text-xs">Belum ada data nilai masuk sesi ini.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 text-right">
                <button onclick="toggleHistoryModal()" class="px-6 py-2 bg-slate-900 text-white text-xs font-bold rounded-lg hover:bg-slate-800">Tutup</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const namaGuru = "<%= nama_guru %>";
        const kodeSekolah = "<%= kode %>";
        
        let activeRoom = kodeSekolah; 
        let isLive = false;
        let isMutedSelf = false;
        let isCamSelfOff = false;
        let isFullScreen = false; 
        let activeView = 'normal'; 
        let isChatPinned = false;
        
        // --- DATA STATE UNTUK EXPORT ---
        let lastGeneratedData = null; 
        let currentSlideIndex = 0;
        let attendanceData = []; 
        let scoresData = [];     
        
        // --- WEBRTC GLOBALS ---
        let localStream;
        let peers = {};
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        function toggleSidebar() {
            const body = document.body;
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth <= 1024) { sidebar.classList.toggle('open'); } 
            else { body.classList.toggle('sidebar-closed'); }
        }

        // --- GANTI FUNGSI generate() SESUAI INSTRUKSI ---
              async function generate() {
            const topic = document.getElementById('prompt').value.trim();
            if(!topic) return showAlert("Masukkan topik materi dulu!", "‚ö†Ô∏è");
            
            const btn = document.getElementById('btnGen');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Generating...`;
            btn.disabled = true;

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instruksi: topic })
                });

                const result = await response.json();

                if (result.error) throw new Error(result.error);

                // PENYESUAIAN: Sesuaikan dengan key bahasa Indonesia dari ai.js
                lastGeneratedData = {
                    topic: result.judul_besar || topic, 
                    slides: result.slides || [],
                    pg: result.soal_pg || [],       // Diubah dari result.pg
                    essay: result.soal_essay || [], // Diubah dari result.essay
                    quiz: result.soal_quiz || []    // Diubah dari result.quiz
                };

                document.getElementById('quiz-controller').style.display = 'block';
                
                socket.emit('broadcast-materi', { room: activeRoom, slides: lastGeneratedData.slides });
                
                currentSlideIndex = 0;
                renderSlide();

                showAlert(`Sukses! Materi "${topic}" Siap.`, "‚ú®");

            } catch (error) {
                console.error(error);
                showAlert("Gagal: " + error.message, "‚ùå");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function distributeQuiz(type) {
            if(!lastGeneratedData) return showAlert("Belum ada materi! Generate dulu.", "‚ö†Ô∏è");
            let payload = {};
            let msg = "";

            if(type === 'PG') {
                payload = { type: 'PG', data: lastGeneratedData.pg, limit: 15 };
                msg = "15 Soal PG Dikirim ke Siswa!";
            } else if (type === 'ESSAY') {
                payload = { type: 'ESSAY', data: lastGeneratedData.essay, limit: 5 };
                msg = "5 Soal Essay Dikirim ke Siswa!";
            } else if (type === 'QUIZ') {
                payload = { type: 'QUIZ', data: lastGeneratedData.quiz, limit: 10 };
                msg = "10 Flash Quiz Dikirim ke Siswa!";
            }
            socket.emit('start-exam', { room: activeRoom, content: payload });
            showAlert(msg, "üöÄ");
        }

        function exportData(dataType, format) {
            let dataToExport = [];
            let fileName = "";

            if(dataType === 'Nilai') {
                dataToExport = scoresData.length > 0 ? scoresData : [{ Waktu: 'N/A', Nama: 'N/A', Tipe: 'N/A', Skor: 0 }];
                fileName = `Rekap_Nilai_${namaGuru}`;
            } else if (dataType === 'Absen') {
                dataToExport = attendanceData.length > 0 ? attendanceData : [{ Tanggal: 'N/A', Waktu: 'N/A', Nama: 'N/A', Status: 'N/A' }];
                fileName = `Absensi_Kelas`;
            } else if (dataType === 'Materi') {
                if(!lastGeneratedData) return showAlert("Belum ada materi untuk diunduh.", "‚ùå");
                dataToExport = lastGeneratedData.slides.map(s => ({ Judul: s.title, Isi: s.content }));
                fileName = `Materi_${lastGeneratedData.topic}`;
            }

            if (format === 'Excel') {
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, `${fileName}.xlsx`);
            } 
            else if (format === 'PDF') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(14);
                doc.text(`Laporan ${dataType} - Teacher Studio`, 14, 20);
                doc.setFontSize(10);
                doc.text(`Guru: ${namaGuru} | Tanggal: ${new Date().toLocaleDateString()}`, 14, 28);

                if (dataType !== 'Materi') {
                    const headers = Object.keys(dataToExport[0]);
                    const body = dataToExport.map(obj => Object.values(obj));
                    doc.autoTable({ head: [headers], body: body, startY: 35 });
                } else {
                    let yPos = 40;
                    dataToExport.forEach((item, i) => {
                        if(yPos > 270) { doc.addPage(); yPos = 20; }
                        doc.setFontSize(12); doc.setFont("helvetica", "bold");
                        doc.text(item.Judul, 14, yPos); yPos += 7;
                        doc.setFontSize(10); doc.setFont("helvetica", "normal");
                        const splitText = doc.splitTextToSize(item.Isi, 180);
                        doc.text(splitText, 14, yPos);
                        yPos += (splitText.length * 5) + 10;
                    });
                }
                doc.save(`${fileName}.pdf`);
            }
            else if (format === 'Word') {
                let htmlBody = `<h2>Laporan ${dataType}</h2><p>Guru: ${namaGuru}</p><table border="1" style="border-collapse:collapse; width:100%">`;
                if(dataToExport.length > 0) {
                    htmlBody += "<thead><tr>";
                    Object.keys(dataToExport[0]).forEach(k => htmlBody += `<th style="padding:8px; background:#eee">${k}</th>`);
                    htmlBody += "</tr></thead><tbody>";
                    dataToExport.forEach(row => {
                        htmlBody += "<tr>";
                        Object.values(row).forEach(val => htmlBody += `<td style="padding:8px">${val}</td>`);
                        htmlBody += "</tr>";
                    });
                    htmlBody += "</tbody></table>";
                }
                const blob = new Blob(['<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>' + htmlBody + '</body></html>'], { type: 'application/msword' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${fileName}.doc`;
                link.click();
            }
            
             // Tambahkan animasi loading pura-pura biar terlihat PRO
            showAlert(`Memproses Ekspor ${dataType}...`, "‚è≥");
            
            setTimeout(() => {
                showAlert(`Berhasil ekspor ${dataType} ke ${format}`, "‚úÖ");
            }, 1500); // Jeda 1.5 detik
        }


            

             function renderSlide() {
            if(!lastGeneratedData || !lastGeneratedData.slides.length) return;
            const slide = lastGeneratedData.slides[currentSlideIndex];
            
            document.getElementById('slide-judul-besar').innerText = lastGeneratedData.topic;
            
            let rawKeyword = slide.keyword_gambar || "Materi";
            // Ambil kata kunci pertama agar gampang digambar AI
            let cleanKeyword = rawKeyword.split(',')[0].trim(); 
            
            const imgEl = document.getElementById('slide-img');
            
            // 1. Teks Loading
            imgEl.src = `https://placehold.co/800x400/2563eb/ffffff?text=Melukis+Visual...`;
            
            // 2. URL AI YANG BENAR (image.pollinations.ai/prompt)
            const finalPrompt = encodeURIComponent(cleanKeyword + ", historical realistic illustration, highly detailed");
            const targetUrl = `https://image.pollinations.ai/prompt/${finalPrompt}?width=800&height=400&nologo=true`;
            
            let imgTemp = new Image();
            imgTemp.src = targetUrl;
            
            imgTemp.onload = function() {
                // Gambar berhasil dibuat AI
                imgEl.src = this.src;
            };
            
            imgTemp.onerror = function() {
                // Kalau AI beneran diblokir, kita pakai foto bernuansa gelap estetik (Bukan kucing lagi!)
                const randomSeed = encodeURIComponent(cleanKeyword.replace(/\s/g, ''));
                imgEl.src = `https://picsum.photos/seed/${randomSeed}/800/400?grayscale`;
            };
            
            document.getElementById('slide-keyword').innerText = `Visual: ${slide.keyword_gambar || 'Umum'}`;
            document.getElementById('slide-subjudul').innerText = slide.judul_slide; 
            document.getElementById('slide-konten').innerHTML = slide.konten_html;   
            document.getElementById('page-indicator').innerText = `${currentSlideIndex + 1} / ${lastGeneratedData.slides.length}`;
        }

                     
        function nextSlide() {
            if(!lastGeneratedData || currentSlideIndex >= lastGeneratedData.slides.length - 1) return;
            currentSlideIndex++; renderSlide();
        }
        function prevSlide() {
            if(!lastGeneratedData || currentSlideIndex <= 0) return;
            currentSlideIndex--; renderSlide();
        }

        async function muatDaftarKelas() {
    try {
        const res = await fetch(`/api/kelas/<%= kode %>`); // Gunakan template literal yang benar
        const data = await res.json();
        const datalist = document.getElementById('list-kelas-guru');
        datalist.innerHTML = data.map(k => `<option value="${escapeHtml(k.nama_kelas)}">`).join('');
    } catch (e) { 
        console.error("Gagal muat kelas", e); 
    }
}

async function simpanKelasBaru() { 
    const namaKelas = document.getElementById('nama-kelas').value.trim(); 
    if (!namaKelas) return showAlert("Ketik nama kelas!", "‚ö†Ô∏è"); 
    
    try {
        await fetch('/api/tambah-kelas', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ kode_sekolah: "<%= kode %>", nama_kelas: namaKelas }) 
        }); 
        
        await muatDaftarKelas(); // Tunggu daftar kelas dimuat ulang
        
        // Opsional: Set value input nama-kelas agar pilihKelasExisting otomatis menggunakan nama ini
        document.getElementById('nama-kelas').value = namaKelas; 
        
        pilihKelasExisting(); 
    } catch (e) {
        console.error("Gagal menyimpan kelas", e);
        showAlert("Gagal menyimpan kelas", "‚ùå");
    }
}

        
        
        function pilihKelasExisting() {
            const namaKelas = document.getElementById('nama-kelas').value.trim();
            if(!namaKelas) return;
            activeRoom = `${kodeSekolah}-${namaKelas}`;
            Object.keys(peers).forEach(key => { peers[key].close(); delete peers[key]; });
            socket.emit('join-room', { roomID: activeRoom, userName: namaGuru, role: 'Guru' });
            document.getElementById('status-kelas-info').innerText = `Aktif di: ${namaKelas}`;
            document.getElementById('status-kelas-info').className = "text-[9px] text-green-600 mt-1 font-bold";
            showAlert(`Masuk ke Kelas ${namaKelas}`, "door-open");
            if(isLive) { socket.emit('teacher-ready', { room: activeRoom }); }
            document.getElementById('mini-list-siswa').innerHTML = '<li class="text-[11px] text-slate-400 italic text-center py-4 bg-slate-50 rounded-lg">Menunggu siswa di kelas baru...</li>';
            document.getElementById('student-grid-view').innerHTML = '';
            document.getElementById('count-badge').innerText = '0';
            attendanceData = [];
            scoresData = [];
            document.getElementById('history-table-body').innerHTML = '<tr id="empty-history"><td colspan="4" class="p-10 text-center text-slate-400 italic text-xs">Belum ada data nilai masuk sesi ini.</td></tr>';
        }

        async function startCamera() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('guru-cam').srcObject = localStream;
                socket.emit('teacher-ready', { room: activeRoom });
            } catch (e) {
                console.error(e);
                showAlert("Akses kamera/mic ditolak!", "‚ùå");
                if(isLive) toggleLive();
            }
        }

        function stopCamera() {
            const video = document.getElementById('guru-cam');
            if(video.srcObject) { video.srcObject.getTracks().forEach(track => track.stop()); video.srcObject = null; }
            Object.keys(peers).forEach(key => { peers[key].close(); delete peers[key]; });
        }

        socket.on('student-signal', async (data) => { await createPeerConnection(data.senderId, data.signal); });
        socket.on('student-ice-candidate', async (data) => {
            const pc = peers[data.senderId];
            if (pc && data.candidate) { try { await pc.addIceCandidate(data.candidate); } catch(e){} }
        });

        socket.on('user-joined', (user) => {
            if(user.role === 'Siswa') {
                addStudentToList(user.id, user.name);
                attendanceData.push({
                    Tanggal: new Date().toLocaleDateString(),
                    Waktu: new Date().toLocaleTimeString(),
                    Nama: user.name,
                    Status: 'Hadir Online'
                });
            }
        });
        
                // --- TAMBAHKAN KODE INI UNTUK MENERIMA PESAN DARI SISWA ---
        socket.on('receive-chat', (data) => {
            const chatContainer = document.getElementById('chat-container');
            
            // Hapus tulisan default jika masih ada
            if (chatContainer.innerHTML.includes('italic py-6')) {
                chatContainer.innerHTML = ''; 
            }
            
            // Tambahkan balon pesan siswa ke layar (Warna gelap, di sebelah kiri)
            chatContainer.innerHTML += `
                <div class="flex justify-start mb-2 animate-[fadeIn_0.3s_ease-out]">
                    <div class="bg-slate-800 border border-slate-700 text-white px-3 py-2 rounded-xl rounded-tl-sm max-w-[80%] text-xs shadow-md">
                        <div class="font-bold text-[9px] text-brand-400 mb-1 flex justify-between gap-3">${escapeHtml(data.sender)} <span>${new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}</span></div>
                        ${escapeHtml(data.message)}
                    </div>
                </div>
            `;
            
            // Scroll otomatis ke bawah
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });
        // -----------------------------------------------------------


        // --- UBAH NAMA EVENT DI DASHBOARD GURU SESUAI INSTRUKSI ---
        socket.on('score-updated-live', (data) => {
            const scoreEntry = {
                name: data.nama_siswa,
                score: data.skor,
                type: 'Kuis', 
                time: data.waktu
            };

            scoresData.push(scoreEntry);
            
            const tbody = document.getElementById('history-table-body');
            const emptyRow = document.getElementById('empty-history');
            if(emptyRow) emptyRow.style.display = 'none';

            const tr = document.createElement('tr');
            tr.className = "border-b border-slate-50 hover:bg-slate-50 transition";
            tr.innerHTML = `
                <td class="p-4 font-mono text-xs text-slate-500">${scoreEntry.time}</td>
                <td class="p-4 font-bold text-slate-700">${scoreEntry.name}</td>
                <td class="p-4"><span class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-[10px] font-bold">Kuis</span></td>
                <td class="p-4 text-right font-black text-slate-800">${scoreEntry.score}</td>
            `;
            tbody.prepend(tr);
            showAlert(`${scoreEntry.name} selesai mengerjakan!`, "bell");
        });

        async function createPeerConnection(studentId, offerSignal) {
            const pc = new RTCPeerConnection(rtcConfig);
            peers[studentId] = pc;
            if(localStream) { localStream.getTracks().forEach(track => pc.addTrack(track, localStream)); }
            pc.ontrack = (event) => {
                const safeId = studentId.replace(/[^a-zA-Z0-9]/g, '');
                const grid = document.getElementById('student-grid-view');
                let card = document.getElementById(`card-${safeId}`);
                if(!card) {
                    card = document.createElement('div');
                    card.id = `card-${safeId}`;
                    card.className = "student-card";
                    card.innerHTML = `<video id="vid-${safeId}" autoplay playsinline class="w-full h-full object-cover"></video><div class="student-label">Siswa</div>`;
                    grid.appendChild(card);
                }
                const videoEl = document.getElementById(`vid-${safeId}`);
                if(videoEl && event.streams[0]) { videoEl.srcObject = event.streams[0]; }
            };
            pc.onicecandidate = (event) => {
                if(event.candidate) { socket.emit('teacher-signal', { targetId: studentId, signal: { candidate: event.candidate } }); }
            };
            if(offerSignal.type === 'offer') {
                await pc.setRemoteDescription(new RTCSessionDescription(offerSignal));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit('teacher-signal', { targetId: studentId, signal: answer });
            }
        }

        function addStudentToList(id, name) {
            const list = document.getElementById('mini-list-siswa');
            if(list.innerText.includes('Menunggu')) list.innerHTML = '';
            if(!document.getElementById(`li-${id}`)) {
                list.innerHTML += `
                    <li id="li-${id}" class="p-2 bg-white border border-slate-100 rounded-lg flex items-center justify-between shadow-sm animate-[fadeIn_0.5s]">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <span class="text-xs font-bold text-slate-700">${name}</span>
                        </div>
                        <i class="fa-solid fa-video text-[10px] text-green-500"></i>
                    </li>`;
                document.getElementById('count-badge').innerText = list.children.length;
            }
        }

        socket.on('user-left', (data) => {
            const safeId = data.id.replace(/[^a-zA-Z0-9]/g, '');
            const card = document.getElementById(`card-${safeId}`); if(card) card.remove();
            const li = document.getElementById(`li-${data.id}`); if(li) li.remove();
            const list = document.getElementById('mini-list-siswa');
            document.getElementById('count-badge').innerText = list.children.length;
            if(peers[data.id]) { peers[data.id].close(); delete peers[data.id]; }
        });

                        function toggleLive() {
            const overlay = document.getElementById('start-overlay');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const btnStart = document.getElementById('btn-start');
            const iconStart = btnStart.querySelector('i');
            const labelStart = btnStart.querySelector('span');
            if (!isLive) {
                startCamera(); isLive = true; 
                overlay.style.display = 'none'; // PERUBAHAN: Paksa sembunyikan layar awal
                statusDot.className = "w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse shadow-[0_0_10px_rgba(239,68,68,0.6)]";
                statusText.innerText = "SIAP MENGAJAR, <%= nama_guru %>".toUpperCase(); iconStart.className = "fa-solid fa-pause ctrl-icon"; labelStart.innerText = "Pause"; btnStart.classList.add('active');
                showAlert(`Anda Live di ${activeRoom.includes('-') ? 'Kelas ' + activeRoom.split('-')[1] : 'Lobi Utama'}`, "üì°");
            } else {
                stopCamera(); isLive = false; 
                overlay.style.display = 'flex'; // PERUBAHAN: Paksa munculkan lagi jika dimatikan
                statusDot.className = "w-2.5 h-2.5 rounded-full bg-yellow-500 shadow-[0_0_10px_rgba(234,179,8,0.5)]";
                statusText.innerText = "PAUSED"; iconStart.className = "fa-solid fa-play ctrl-icon"; labelStart.innerText = "Start"; btnStart.classList.remove('active');
                showAlert("Live Dijeda", "‚è∏Ô∏è");
            }
        }

        
        function toggleMuteSelf() { isMutedSelf = !isMutedSelf; if(localStream) { localStream.getAudioTracks()[0].enabled = !isMutedSelf; } updateBtnUI('btn-mic', isMutedSelf, 'fa-microphone-slash', 'fa-microphone', 'Unmute', 'Mic'); }   
        function muteAllStudents() {
        if (!activeRoom || !isLive) return showAlert("Anda belum Live di kelas!", "‚ö†Ô∏è");
            
            // Mengirim perintah ke server agar semua siswa di-mute
            socket.emit('mute-all-students', { room: activeRoom });
            showAlert("Semua mikrofon siswa dinonaktifkan!", "üîá");
        }
        function toggleCamSelf() { isCamSelfOff = !isCamSelfOff; if(localStream) { localStream.getVideoTracks()[0].enabled = !isCamSelfOff; } updateBtnUI('btn-cam', isCamSelfOff, 'fa-video-slash', 'fa-video', 'Cam On', 'Cam'); }
        function updateBtnUI(id, active, iconOn, iconOff, textOn, textOff) {
            const btn = document.getElementById(id); const icon = btn.querySelector('i'); const label = btn.querySelector('span');
            if(active) { btn.classList.add('danger', 'active'); icon.className = `fa-solid ${iconOn} ctrl-icon`; label.innerText = textOn; } 
            else { btn.classList.remove('danger', 'active'); icon.className = `fa-solid ${iconOff} ctrl-icon`; label.innerText = textOff; }
        }

                          function toggleScreenSize() {
            const wrapper = document.getElementById('guru-video-wrapper'); const btn = document.getElementById('btn-screen'); const icon = btn.querySelector('i'); const label = btn.querySelector('span');
            const chat = document.getElementById('integrated-chat');
            const header = document.getElementById('top-header-bar');
            const controlBar = document.getElementById('main-control-bar');
            
            isFullScreen = !isFullScreen;
            if (isFullScreen) { 
                wrapper.classList.remove('default-mode'); wrapper.classList.add('full-mode'); 
                icon.className = "fa-solid fa-compress ctrl-icon"; label.innerText = "Kecilkan"; btn.classList.add('active'); 
                chat.classList.add('hidden-mode'); // Sembunyikan Chat
                
                // Hilangkan Header (Logo & Hamburger) dan Besarkan Control Bar
                if(header) header.classList.add('hidden'); 
                controlBar.classList.replace('py-3', 'py-5');
                controlBar.classList.replace('bottom-4', 'bottom-10');
            } else { 
                wrapper.classList.remove('full-mode'); wrapper.classList.add('default-mode'); 
                icon.className = "fa-solid fa-expand ctrl-icon"; label.innerText = "Layar"; btn.classList.remove('active'); 
                if(activeView === 'normal') chat.classList.remove('hidden-mode'); // Munculkan Chat
                
                // Munculkan Header dan Kembalikan Ukuran Control Bar
                if(activeView === 'normal' && header) header.classList.remove('hidden');
                controlBar.classList.replace('py-5', 'py-3');
                controlBar.classList.replace('bottom-10', 'bottom-4');
            }
        }


        function toggleGridView() {

            const chat = document.getElementById('integrated-chat');
            const header = document.getElementById('top-header-bar');
            if (activeView === 'grid') { 
                resetViews(); activeView = 'normal'; 
                if(!isFullScreen) chat.classList.remove('hidden-mode');
            } else { 
                resetViews(); document.getElementById('student-grid-view').classList.add('active'); 
                const wrapper = document.getElementById('guru-video-wrapper'); 
                wrapper.classList.remove('default-mode', 'full-mode'); wrapper.classList.add('pip-mode'); 
                document.getElementById('btn-grid-murid').classList.add('active'); activeView = 'grid'; 
                chat.classList.add('hidden-mode'); // Sembunyikan Chat
                if(header) header.classList.add('hidden'); // Sembunyikan Logo & Menu
                showAlert("Mode Grid Siswa Aktif", "üë•"); 
            }
        }

        function toggleMateriView() {
            if(!lastGeneratedData) return showAlert("Belum ada materi untuk direview!", "‚ö†Ô∏è");
            const chat = document.getElementById('integrated-chat');
            const header = document.getElementById('top-header-bar');
            if (activeView === 'materi') { 
                resetViews(); activeView = 'normal'; 
                if(!isFullScreen) chat.classList.remove('hidden-mode');
            } else { 
                resetViews(); document.getElementById('presentation-stage').classList.add('active'); 
                const wrapper = document.getElementById('guru-video-wrapper'); 
                wrapper.classList.remove('default-mode', 'full-mode'); wrapper.classList.add('pip-mode'); 
                document.getElementById('btn-grid-materi').classList.add('active'); activeView = 'materi'; 
                chat.classList.add('hidden-mode'); // Sembunyikan Chat
                if(header) header.classList.add('hidden'); // Sembunyikan Logo & Menu
                renderSlide(); showAlert("Mode Materi Aktif", "üìñ"); 
            }
        }

        function resetViews() {
            document.getElementById('student-grid-view').classList.remove('active'); 
            document.getElementById('presentation-stage').classList.remove('active'); 
            const wrapper = document.getElementById('guru-video-wrapper'); 
            wrapper.classList.remove('pip-mode');
            if(!isFullScreen) wrapper.classList.add('default-mode');
            else wrapper.classList.add('full-mode');
            document.getElementById('btn-grid-murid').classList.remove('active'); 
            document.getElementById('btn-grid-materi').classList.remove('active');
            
            // Munculkan kembali Logo & Menu jika tidak Fullscreen
            const header = document.getElementById('top-header-bar');
            if(!isFullScreen && header) header.classList.remove('hidden');
        }
  


        function toggleHistoryModal() {
            const modal = document.getElementById('history-modal'); const content = document.getElementById('history-content');
            if (modal.classList.contains('hidden')) { modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('scale-95'); }, 10); } 
            else { modal.classList.add('opacity-0'); content.classList.add('scale-95'); setTimeout(() => modal.classList.add('hidden'), 300); }
        }

        function kirimChat(e) { 
            e.preventDefault(); 
            const inputEl = document.getElementById('chat-input');
            const pesan = inputEl.value.trim();

            if (pesan) {
                // Kirim pesan ke server
                socket.emit('send-chat', { room: activeRoom, sender: namaGuru, message: pesan });
                
                // --- BAGIAN YANG DIPERBAIKI (Diaktifkan) ---
                const chatContainer = document.getElementById('chat-container');
                
                // Hapus tulisan "Ruang obrolan kelas siap digunakan..." jika masih ada
                if (chatContainer.innerHTML.includes('italic py-6')) {
                    chatContainer.innerHTML = ''; 
                }
                
                // Tambahkan balon pesan sendiri ke layar (Warna biru, di sebelah kanan)
                chatContainer.innerHTML += `
                    <div class="flex justify-end mb-2">
                        <div class="bg-brand-600 text-white px-3 py-2 rounded-xl rounded-tr-sm max-w-[80%] text-xs shadow-md">
                            <div class="font-bold text-[9px] text-brand-200 mb-1 flex justify-between gap-3">Anda <span>${new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}</span></div>
                            ${escapeHtml(pesan)}
                        </div>
                    </div>
                `;
                
                // Scroll otomatis ke bawah agar pesan terbaru selalu terlihat
                chatContainer.scrollTop = chatContainer.scrollHeight;
                // ------------------------------------------
                
                inputEl.value = ''; // Kosongkan input setelah mengirim
            }
        }

        
        function escapeHtml(text) { if (!text) return text; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        function showAlert(msg, icon) { const el = document.getElementById('customAlert'); document.getElementById('alertMsg').innerText = msg; document.getElementById('alertIcon').innerText = icon || ""; el.style.top = "30px"; setTimeout(() => el.style.top = "-100px", 3000); }
      
        // Fungsi ini HARUS ada agar tombol simpan berfungsi
        async function simpanKelasBaru() { 
            const namaKelas = document.getElementById('nama-kelas').value.trim(); 
            if (!namaKelas) return showAlert("Ketik nama kelas!", "‚ö†Ô∏è"); 
            
            try {
                await fetch('/api/tambah-kelas', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ kode_sekolah: "<%= kode %>", nama_kelas: namaKelas }) 
                }); 
                
                await muatDaftarKelas(); // Tunggu daftar kelas dimuat ulang
                document.getElementById('nama-kelas').value = namaKelas; 
                pilihKelasExisting(); 
            } catch (e) {
                console.error("Gagal menyimpan kelas", e);
                showAlert("Gagal menyimpan kelas", "‚ùå");
            }
        }

        muatDaftarKelas();

    </script>
</body>
</html>
