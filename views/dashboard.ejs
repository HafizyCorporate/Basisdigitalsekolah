<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Portal - Elegant Edition</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #1e293b; }
        .sidebar { background: #0f172a; }
        .card-elegant { background: white; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); transition: all 0.3s ease; }
        
        @keyframes shimmer { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .loading-state { animation: shimmer 1.5s infinite; }

        .alert-elegant {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
            color: white; padding: 1rem 2rem; border-radius: 1rem;
            border-left: 4px solid #6366f1; transform: translateX(120%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .alert-show { transform: translateX(0); }
        
        /* Mirroring for Live Cam */
        #teacher-cam { transform: scaleX(-1); object-fit: cover; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="customAlert" class="alert-elegant flex items-center gap-3">
        <span id="alertIcon">‚ú®</span>
        <span id="alertMsg" class="font-bold text-sm"></span>
    </div>

    <aside class="w-64 sidebar h-full text-white flex flex-col p-6 shadow-2xl">
        <div class="mb-10">
            <h1 class="text-xl font-extrabold text-indigo-400 tracking-tighter italic">GLOBAL AI</h1>
            <p class="text-[9px] text-slate-500 font-mono tracking-widest mt-1">GURU PANEL v2.0</p>
        </div>
        
        <div class="mb-6 overflow-hidden rounded-2xl bg-slate-800 h-32 border border-white/10 relative">
            <video id="teacher-cam" class="w-full h-full absolute inset-0 bg-black" autoplay playsinline></video>
            <div class="absolute bottom-2 left-2 flex items-center gap-1">
                <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                <span class="text-[8px] font-bold uppercase tracking-widest">Live Cam</span>
            </div>
        </div>

        <nav class="flex-1 space-y-2">
            <button class="w-full flex items-center gap-3 p-4 rounded-2xl bg-indigo-500/10 text-indigo-300 font-bold border-r-4 border-indigo-400">
                <span>üìë</span> Produksi Materi
            </button>
            <button onclick="toggleChat()" class="w-full flex items-center gap-3 p-4 rounded-2xl text-slate-500 hover:bg-white/5 transition-all relative">
                <span>üí¨</span> Diskusi Kelas
                <span id="chat-notif" class="hidden absolute right-4 w-2 h-2 bg-indigo-500 rounded-full"></span>
            </button>
        </nav>
        
        <div class="pt-6 border-t border-slate-800">
            <a href="/logout" class="text-xs font-bold text-red-400 flex items-center gap-2 hover:opacity-70 transition-all">
                üö™ LOGOUT DARI SISTEM
            </a>
        </div>
    </aside>

    <main class="flex-1 h-full overflow-y-auto p-8 lg:p-12 relative">
        <div id="chat-panel" class="hidden absolute right-8 top-32 w-80 bg-white border border-slate-200 rounded-3xl shadow-2xl z-50 flex flex-col overflow-hidden animate-pop">
            <div class="p-4 bg-indigo-600 text-white font-bold text-xs flex justify-between items-center">
                <span>CHAT KELAS LIVE</span>
                <button onclick="toggleChat()">‚úï</button>
            </div>
            <div id="chat-box" class="h-80 overflow-y-auto p-4 space-y-3 text-[11px]"></div>
            <div class="p-3 border-t border-slate-100 flex gap-2">
                <input id="chat-input" type="text" placeholder="Ketik pesan..." class="flex-1 bg-slate-50 p-2 rounded-xl text-xs outline-none focus:ring-1 focus:ring-indigo-500">
                <button onclick="sendChat()" class="text-lg">üöÄ</button>
            </div>
        </div>

        <header class="flex justify-between items-end mb-12">
            <div>
                <h2 class="text-3xl font-extrabold text-slate-800">Ruang Kerja Guru</h2>
                <p class="text-slate-500 text-sm mt-1 uppercase tracking-widest font-bold">üè´ <%= instansi %></p>
            </div>
            <div class="hidden md:block">
                <div class="card-elegant px-6 py-3 rounded-2xl flex items-center gap-3 bg-slate-50">
                    <div id="status-dot" class="w-3 h-3 bg-emerald-500 rounded-full animate-ping"></div>
                    <span id="status-text" class="text-[10px] font-black text-slate-400 uppercase tracking-widest">System Ready</span>
                </div>
            </div>
        </header>

        <section class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            <div class="lg:col-span-4">
                <div class="card-elegant p-8 rounded-[2rem]">
                    <div class="flex items-center gap-2 mb-6">
                        <div class="w-1 h-6 bg-indigo-500 rounded-full"></div>
                        <h3 class="font-black text-slate-700 uppercase text-xs tracking-widest">Instruksi AI</h3>
                    </div>
                    <textarea id="prompt" class="w-full h-56 bg-slate-50 border border-slate-200 rounded-2xl p-5 focus:ring-4 focus:ring-indigo-500/10 outline-none text-slate-700 transition-all resize-none" placeholder="Contoh: Buatkan materi sejarah kemerdekaan RI..."></textarea>
                    
                    <button id="btnGen" onclick="generate()" class="w-full mt-6 bg-slate-900 text-white py-5 rounded-2xl font-black shadow-xl shadow-slate-200 transition-all hover:scale-[1.02] active:scale-95 flex justify-center items-center gap-3">
                        <span id="btnIcon">üöÄ</span> <span id="btnText">PRODUKSI SEKARANG</span>
                    </button>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div id="preview-area" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em]">Materi Terbuat</span>
                        <div class="flex gap-2">
                            <button id="btnPublish" onclick="publishToStudents()" class="bg-indigo-600 text-white px-8 py-3 rounded-full text-[10px] font-black hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-200 uppercase">Publikasikan Materi</button>
                            <button id="btnQuiz" onclick="publishQuiz()" class="bg-amber-500 text-white px-8 py-3 rounded-full text-[10px] font-black hover:bg-amber-400 transition-all shadow-lg shadow-amber-200 uppercase flex items-center gap-2">üéØ Mulai Kuis Live</button>
                        </div>
                    </div>
                    <div id="result-container" class="card-elegant p-12 rounded-[3rem] prose prose-slate max-w-none border-t-8 border-indigo-500">
                        <h1 id="res-judul" class="text-slate-800 font-extrabold"></h1>
                        <div id="res-html" class="text-slate-600 leading-relaxed"></div>
                    </div>
                </div>

                <div id="empty-state" class="card-elegant h-[500px] rounded-[3rem] flex flex-col items-center justify-center border-dashed border-2 border-slate-200 opacity-60">
                    <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center text-3xl mb-4">‚úçÔ∏è</div>
                    <p class="text-slate-400 font-bold uppercase text-xs tracking-widest">Menunggu Input Instruksi Guru</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        const socket = io();
        let lastGeneratedData = null;

        // --- 1. LOGIKA LIVE CAM ---
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('teacher-cam').srcObject = stream;
                showAlert('Kamera Aktif!', 'üìπ');
            } catch (err) {
                console.error("Gagal akses kamera:", err);
                showAlert('Kamera tidak terdeteksi.', '‚ö†Ô∏è');
            }
        }
        window.onload = initCamera;

        // --- 2. LOGIKA AI & PUBLIKASI ---
        async function generate() {
            const btn = document.getElementById('btnGen');
            const btnText = document.getElementById('btnText');
            const btnIcon = document.getElementById('btnIcon');
            const prompt = document.getElementById('prompt').value;

            if(!prompt) { showAlert('Harap isi instruksi dulu, Guru!', '‚ö†Ô∏è'); return; }

            btn.disabled = true;
            btnText.innerText = "MERACIK MATERI...";
            btnIcon.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ instruksi: prompt })
                });
                const data = await res.json();
                lastGeneratedData = data; // Simpan untuk dipublikasikan
                
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('preview-area').classList.remove('hidden');
                document.getElementById('res-judul').innerText = data.judul;
                document.getElementById('res-html').innerHTML = data.html;
                
                showAlert('Materi berhasil dibuat!', '‚úÖ');
            } catch (e) { 
                showAlert('Gagal menghubungi AI.', '‚ùå');
            } finally {
                btn.disabled = false;
                btnText.innerText = "PRODUKSI SEKARANG";
                btnIcon.innerText = "üöÄ";
            }
        }

        function publishToStudents() {
            if(!lastGeneratedData) return;
            // Kirim materi ke semua siswa via socket
            socket.emit('new-materi', lastGeneratedData);
            showAlert('Materi telah dikirim ke semua siswa!', 'üöÄ');
        }

        // --- TAMBAHAN: LOGIKA PUBLISH KUIS ---
        function publishQuiz() {
            if(!lastGeneratedData || !lastGeneratedData.soal) {
                showAlert('Buat materi dulu agar ada kuisnya!', '‚ö†Ô∏è');
                return;
            }
            // Kirim data kuis ke siswa via Socket
            socket.emit('start-quiz', { 
                judul: lastGeneratedData.judul, 
                soal: lastGeneratedData.soal 
            });
            showAlert('Kuis interaktif telah dikirim ke siswa!', 'üéØ');
            
            // Efek visual tombol sukses
            const btn = document.getElementById('btnQuiz');
            btn.classList.replace('bg-amber-500', 'bg-emerald-500');
            setTimeout(() => btn.classList.replace('bg-emerald-500', 'bg-amber-500'), 2000);
        }

        // --- 3. LOGIKA LIVE CHAT ---
        function toggleChat() {
            const panel = document.getElementById('chat-panel');
            panel.classList.toggle('hidden');
            document.getElementById('chat-notif').classList.add('hidden');
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            if(input.value.trim()) {
                socket.emit('chat-message', { user: 'Guru', msg: input.value });
                input.value = '';
            }
        }

        socket.on('chat-message', (data) => {
            const chatBox = document.getElementById('chat-box');
            const isMe = data.user === 'Guru';
            chatBox.innerHTML += `
                <div class="${isMe ? 'text-right' : 'text-left'}">
                    <span class="font-black text-[9px] block text-slate-400 uppercase">${data.user}</span>
                    <div class="inline-block p-2 rounded-2xl ${isMe ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-700'} mt-1">
                        ${data.msg}
                    </div>
                </div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
            if(document.getElementById('chat-panel').classList.contains('hidden')) {
                document.getElementById('chat-notif').classList.remove('hidden');
            }
        });

        function showAlert(msg, icon = '‚ú®') {
            const alert = document.getElementById('customAlert');
            document.getElementById('alertMsg').innerText = msg;
            document.getElementById('alertIcon').innerText = icon;
            alert.classList.add('alert-show');
            setTimeout(() => alert.classList.remove('alert-show'), 3000);
        }
    </script>
</body>
</html>
