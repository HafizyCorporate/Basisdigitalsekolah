<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Teacher Studio - Live Command</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            900: '#0B0F19', // Background utama (sangat gelap, agak biru)
                            800: '#151A25', // Sidebar / Panel
                            700: '#232936', // Border / Input
                            600: '#333B4D',
                        },
                        brand: {
                            500: '#6366f1', // Indigo lembut
                            600: '#4f46e5',
                            glow: 'rgba(99, 102, 241, 0.15)'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background: #0B0F19; color: #e2e8f0; overflow: hidden; height: 100vh; }
        
        /* Layout Grid */
        .app-layout { display: grid; grid-template-columns: 320px 1fr; height: 100vh; width: 100vw; }
        
        /* Sidebar (Kiri) */
        .sidebar { background: #151A25; border-right: 1px solid #232936; display: flex; flex-direction: column; z-index: 50; transition: transform 0.3s ease; }
        
        /* Main Stage (Kanan) */
        .main-stage { position: relative; background: radial-gradient(circle at center, #1a202e 0%, #0B0F19 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* Mobile Responsiveness */
        @media (max-width: 1024px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar { position: absolute; left: 0; top: 0; bottom: 0; z-index: 60; transform: translateX(-100%); width: 100%; max-width: 350px; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .sidebar-active { transform: translateX(0); }
            .control-bar { padding: 8px 15px; gap: 8px; width: 90%; }
        }

        /* --- STYLING KHUSUS --- */
        
        /* Tab Segment */
        .tab-segment { display: flex; background: #232936; border-radius: 12px; padding: 4px; margin: 15px; position: relative; gap: 4px; }
        .tab-btn { flex: 1; text-align: center; padding: 8px 0; font-size: 11px; font-weight: 700; color: #94a3b8; border-radius: 8px; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 0.5px; position: relative; z-index: 10; }
        .tab-btn.active { background: #333B4D; color: #818cf8; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .tab-btn:hover { color: white; }

        /* Panel */
        .panel-container { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .panel-content { flex: 1; overflow-y: auto; padding: 15px; display: none; flex-direction: column; }
        .panel-content.active { display: flex; }

        /* Input & Forms */
        .input-calm { background: #232936; border: 1px solid transparent; color: #f8fafc; border-radius: 10px; transition: 0.2s; outline: none; width: 100%; }
        .input-calm:focus { border-color: #6366f1; background: #28303f; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

        /* Chat */
        .chat-bubble { padding: 10px 14px; border-radius: 14px; font-size: 13px; line-height: 1.4; max-width: 85%; margin-bottom: 8px; word-wrap: break-word; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .chat-in { background: #333B4D; color: #e2e8f0; align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-out { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }

        /* Video Area */
        #video-container { width: 100%; height: 100%; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #guru-live-cam { width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); border-radius: 0px; } /* Clean, no border for video */
        
        /* Floating Control Dock (Bawah) */
        .control-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(21, 26, 37, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 10px 25px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.08);
            display: flex; align-items: center; gap: 20px; z-index: 40; box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        .ctrl-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 50px; height: 50px; border-radius: 16px; color: #94a3b8;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; font-size: 10px; font-weight: 600; gap: 6px;
        }
        .ctrl-btn:hover { background: rgba(255,255,255,0.05); color: #e2e8f0; transform: translateY(-4px); }
        .ctrl-btn.active { color: #818cf8; background: rgba(99, 102, 241, 0.15); }
        .ctrl-btn.danger { color: #f43f5e; }
        .ctrl-btn.danger:hover { background: rgba(244, 63, 94, 0.15); color: #fb7185; }
        .ctrl-btn i { font-size: 18px; }

        /* Live Badge (Atas) */
        .live-badge { 
            position: absolute; top: 25px; left: 25px; 
            background: rgba(220, 38, 38, 0.85); backdrop-filter: blur(4px);
            padding: 6px 14px; border-radius: 8px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px;
            display: flex; align-items: center; gap: 8px; z-index: 20; color: white;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        .blink-dot { width: 8px; height: 8px; background: white; border-radius: 50%; animation: blink 1.5s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333B4D; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Modal Slide Presentation */
        #presentation-stage { 
            position: absolute; inset: 20px; 
            background: #ffffff; color: #1e293b; z-index: 10; 
            padding: 50px 80px; overflow-y: auto; display: none; 
            border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Modal & Overlays */
        .modal-overlay { background: rgba(0,0,0,0.6); position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-active { display: flex !important; }

        /* Student Tiles */
        .student-grid-mini { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 0 5px; }
        .student-tile { aspect-ratio: 16/9; background: #0f1115; border-radius: 10px; overflow: hidden; position: relative; border: 1px solid #333B4D; transition: 0.2s; }
        .student-tile:hover { border-color: #6366f1; transform: scale(1.02); z-index: 2; }

        /* Button Gradient */
        .btn-gradient { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; transition: 0.3s; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); }
        .btn-gradient:hover { box-shadow: 0 8px 25px rgba(79, 70, 229, 0.5); transform: translateY(-2px); }
    </style>
</head>
<body>

    <div class="app-layout">
        <aside id="left-sidebar" class="sidebar">
            <div class="px-6 py-5 border-b border-dark-700 flex justify-between items-center">
                <div>
                    <h1 class="text-sm font-black text-white tracking-wide">TEACHER STUDIO</h1>
                    <p class="text-[10px] text-slate-400 font-medium mt-0.5">Control Center</p>
                </div>
                <button onclick="toggleSidebarMenu()" class="lg:hidden text-slate-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>

            <div class="tab-segment">
                <div class="tab-btn active" onclick="switchTab('ai', this)">‚ú® AI Studio</div>
                <div class="tab-btn" onclick="switchTab('participants', this)">üë• Absen</div>
                <div class="tab-btn" onclick="switchTab('chat', this)">üí¨ Chat</div>
            </div>

            <div class="panel-container">
                <div id="panel-ai" class="panel-content active">
                    <div class="bg-dark-600/30 p-4 rounded-2xl border border-dark-600 mb-5">
                        <div class="flex justify-between items-center mb-3">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Pilih Kelas</label>
                            <button onclick="tambahKelas()" class="text-[10px] text-brand-500 font-bold hover:text-brand-400">+ Buat Baru</button>
                        </div>
                        <select id="select-kelas" onchange="pindahKelas()" class="input-calm p-2 text-xs font-bold mb-1"></select>
                    </div>

                    <div class="mb-2">
                        <label class="text-[10px] font-bold text-brand-500 uppercase tracking-widest mb-2 block ml-1">AI Generator</label>
                        <textarea id="prompt" class="input-calm h-28 p-3 text-xs mb-3 resize-none font-medium leading-relaxed" placeholder="Ketik topik materi (contoh: Sejarah Kemerdekaan Indonesia...)"></textarea>
                        <button id="btnGen" onclick="generate()" class="w-full py-3 rounded-xl font-bold text-xs uppercase btn-gradient">
                            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Buat Materi & Soal
                        </button>
                    </div>

                    <div id="preview-actions" class="hidden space-y-3 mt-4 animate-[fadeIn_0.5s]">
                        <div class="p-3 bg-emerald-900/20 border border-emerald-500/20 rounded-xl flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-xs"><i class="fa-solid fa-check"></i></div>
                            <div class="flex-1 min-w-0">
                                <p class="text-[9px] text-emerald-400 font-bold uppercase">Materi Siap</p>
                                <h4 id="mini-judul" class="font-bold text-xs text-white truncate">...</h4>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="publishToStudents()" class="py-3 bg-dark-600 border border-dark-600 hover:border-brand-500 hover:bg-dark-700 rounded-xl text-[10px] font-bold uppercase text-slate-300 transition">üì° Siarkan Materi</button>
                            <button onclick="mulaiKuisAI()" class="py-3 bg-amber-600/20 text-amber-500 border border-amber-500/30 hover:bg-amber-600 hover:text-white rounded-xl text-[10px] font-bold uppercase transition">üöÄ Mulai Kuis</button>
                        </div>
                        <button onclick="switchDisplayMode()" class="w-full py-3 bg-transparent border border-brand-600 text-brand-500 rounded-xl text-[10px] font-bold uppercase hover:bg-brand-600 hover:text-white transition">üì∫ Tampilkan di Layar Utama</button>
                    </div>

                    <div class="mt-auto pt-6 border-t border-dark-600">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-xs font-black uppercase text-slate-400 tracking-wider">Live Score</span>
                            <button onclick="exportLaporan('excel')" class="text-[9px] bg-dark-600 hover:bg-brand-600 px-2 py-1 rounded text-slate-300 hover:text-white transition font-bold">Export XLS</button>
                        </div>
                        <div class="space-y-2 max-h-40 overflow-y-auto pr-1" id="live-score-body">
                            <div class="text-center text-[10px] text-slate-600 font-medium py-4">Belum ada nilai masuk</div>
                        </div>
                    </div>
                </div>

                <div id="panel-participants" class="panel-content">
                    <div class="flex justify-between items-center mb-4 sticky top-0 bg-[#151A25] pb-2 z-10">
                        <span class="text-xs font-bold text-slate-400">DAFTAR SISWA <span id="count-absen-badge" class="ml-1 bg-brand-600 text-white px-1.5 py-0.5 rounded text-[9px]">0</span></span>
                        <button onclick="exportAbsensi('pdf')" class="text-[9px] text-brand-500 hover:text-brand-400 font-bold">Download PDF</button>
                    </div>
                    <ul id="list-absen" class="space-y-2 mb-6">
                        <li class="text-center text-[10px] text-slate-600 italic mt-10">Menunggu siswa bergabung...</li>
                    </ul>
                    
                    <div class="border-t border-dark-600 pt-5 mt-auto">
                        <span class="text-[10px] font-bold text-slate-500 block mb-3 uppercase tracking-wider">Kamera Siswa</span>
                        <div id="students-live-grid" class="student-grid-mini"></div>
                    </div>
                </div>

                <div id="panel-chat" class="panel-content !p-0 h-full flex flex-col">
                    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-dark-600/10">
                        <div class="text-center text-[10px] text-slate-600 my-4 bg-dark-700/50 inline-block px-3 py-1 rounded-full mx-auto self-center">-- Awal Percakapan --</div>
                    </div>
                    <div class="p-3 bg-[#151A25] border-t border-dark-600 sticky bottom-0">
                        <form onsubmit="kirimChat(event)" class="flex gap-2 relative">
                            <input type="text" id="chat-input" class="input-calm py-3 pl-4 pr-10 text-xs shadow-none bg-dark-900 border-dark-700" placeholder="Tulis pesan..." autocomplete="off">
                            <button type="submit" class="absolute right-2 top-1.5 bottom-1.5 w-8 rounded-lg flex items-center justify-center text-brand-500 hover:bg-brand-500 hover:text-white transition">
                                <i class="fa-solid fa-paper-plane text-xs"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </aside>

        <main class="main-stage">
            <div class="live-badge shadow-lg">
                <div class="blink-dot"></div>
                <span>LIVE ‚Ä¢ <span id="current-room-label" class="opacity-90 font-medium">Umum</span></span>
            </div>

            <button onclick="toggleSidebarMenu()" class="lg:hidden absolute top-6 right-6 z-30 bg-dark-700 p-2 rounded-lg text-white shadow-lg">
                <i class="fa-solid fa-bars"></i>
            </button>

            <div id="video-container">
                <video id="guru-live-cam" autoplay playsinline muted class="shadow-2xl"></video>
                <img id="fokus-murid-view" class="hidden w-full h-full object-contain bg-black z-20 absolute inset-0">
                
                <div id="presentation-stage" class="prose max-w-none prose-slate prose-headings:font-bold prose-h1:text-brand-600">
                    <button onclick="switchDisplayMode()" class="absolute top-6 right-6 text-slate-400 hover:text-red-500 transition z-50 p-2 bg-slate-100 rounded-full w-10 h-10 flex items-center justify-center shadow-sm">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                    <h1 id="slide-judul" class="text-4xl font-black mb-8 border-b pb-6"></h1>
                    <div id="slide-konten" class="text-xl leading-relaxed text-slate-600 font-medium"></div>
                </div>
            </div>

            <div class="control-bar">
                <div class="ctrl-btn" onclick="toggleMute()" id="btn-mic">
                    <i class="fa-solid fa-microphone"></i>
                    <span>Mute</span>
                </div>
                <div class="ctrl-btn" onclick="toggleVideo()" id="btn-cam">
                    <i class="fa-solid fa-video"></i>
                    <span>Stop Cam</span>
                </div>
                
                <div class="w-px h-8 bg-slate-600/40 mx-1"></div>

                <div class="ctrl-btn" onclick="openSidebarTab('ai')">
                    <i class="fa-solid fa-wand-magic-sparkles text-brand-500"></i>
                    <span>Materi AI</span>
                </div>
                
                <div class="w-px h-8 bg-slate-600/40 mx-1"></div>

                <div class="ctrl-btn" onclick="toggleCleanFullScreen()">
                    <i class="fa-solid fa-expand"></i>
                    <span>Full</span>
                </div>
                <div class="ctrl-btn danger" onclick="muteAllStudents()">
                    <i class="fa-solid fa-volume-xmark"></i>
                    <span>Mute All</span>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-koreksi" class="modal-overlay">
        <div class="bg-[#1e293b] w-full max-w-md rounded-3xl p-8 text-white shadow-2xl animate-[slideIn_0.3s_ease-out] border border-dark-600">
            <h3 class="text-xl font-black mb-1">Koreksi Nilai</h3>
            <p id="koreksi-nama" class="text-brand-500 text-sm font-bold mb-6 uppercase tracking-wider"></p>
            
            <label class="block text-[10px] font-bold uppercase text-slate-400 mb-2">Skor Baru</label>
            <input type="number" id="input-skor-baru" class="input-calm p-4 font-bold text-xl mb-5 text-center bg-dark-900 border-dark-700">
            
            <label class="block text-[10px] font-bold uppercase text-slate-400 mb-2">Feedback Guru</label>
            <textarea id="input-catatan-baru" class="input-calm p-4 text-sm h-28 resize-none bg-dark-900 border-dark-700 mb-8"></textarea>
            
            <div class="flex gap-3">
                <button onclick="tutupKoreksi()" class="flex-1 py-3 text-slate-400 font-bold text-sm hover:bg-dark-700 rounded-xl transition">Batal</button>
                <button onclick="simpanKoreksi()" class="flex-1 py-3 bg-brand-600 text-white font-bold text-sm rounded-xl hover:bg-brand-500 shadow-lg transition">Simpan</button>
            </div>
        </div>
    </div>

    <div id="customAlert" class="fixed top-8 left-1/2 -translate-x-1/2 z-[2000] bg-dark-800 text-white pl-4 pr-6 py-3 rounded-full border border-dark-600 shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 pointer-events-none translate-y-[-20px]">
        <div id="alertIcon" class="text-lg animate-bounce">üí°</div>
        <div id="alertMsg" class="text-xs font-bold tracking-wide">Alert message</div>
    </div>

    <script>
        // --- JAVASCRIPT LOGIC (SAMA DENGAN SEBELUMNYA, HANYA PENYESUAIAN UI) ---
        const socket = io();
        const namaGuru = "<%= nama_guru %>";
        const kodeSekolah = "<%= kode %>";
        
        let currentRoom = kodeSekolah;
        let lastGeneratedData = null;
        let allScores = [];
        let isPresentationMode = false;
        let isMuted = false;
        let isCamOff = false;

        socket.on('connect', () => {
            socket.emit('join-room', { room: currentRoom, nama: namaGuru, role: 'Guru' });
            loadKelas();
        });

        socket.on('chat-message', (data) => {
            const container = document.getElementById('chat-container');
            const isMe = data.user === namaGuru;
            const align = isMe ? 'chat-out' : 'chat-in';
            const meta = isMe ? 'Anda' : data.user;
            
            if (!isMe && !document.getElementById('panel-chat').classList.contains('active')) {
                // Indikator chat masuk bisa ditambahkan di tab
                document.querySelectorAll('.tab-btn')[2].classList.add('text-brand-400', 'animate-pulse');
            }

            container.innerHTML += `
                <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} animate-[fadeIn_0.3s]">
                    <span class="text-[9px] text-slate-500 mb-1 ml-1 font-bold">${meta}</span>
                    <div class="chat-bubble ${align}">${data.msg}</div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
        });

        function kirimChat(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;
            
            socket.emit('chat-message', {
                room: currentRoom,
                user: namaGuru,
                msg: msg,
                role: 'Guru'
            });
            input.value = '';
        }

        socket.on('score-updated-live', (data) => {
            const ex = allScores.findIndex(s => s.name === data.nama_siswa);
            if(ex > -1) { allScores[ex] = { ...allScores[ex], ...data }; } 
            else { allScores.push({ name: data.nama_siswa, score: data.skor, feedback: data.umpan_balik }); }
            renderScoreboardMini();
            showAlert(`${data.nama_siswa} selesai! Skor: ${data.skor}`, "‚úÖ");
        });

        function renderScoreboardMini() {
            const container = document.getElementById('live-score-body');
            allScores.sort((a,b) => b.score - a.score);
            
            if(allScores.length === 0) {
                 container.innerHTML = '<div class="text-center text-[10px] text-slate-600 font-medium py-4">Belum ada nilai masuk</div>';
                 return;
            }

            container.innerHTML = allScores.map((s, i) => `
                <div class="bg-dark-700/50 p-2 rounded-xl flex items-center justify-between border border-transparent hover:border-brand-500/50 transition cursor-pointer mb-1" onclick="bukaKoreksi('${s.name}', ${s.score}, '${s.feedback}')">
                    <div class="flex items-center gap-3">
                        <span class="font-black text-slate-600 text-[10px] w-4">#${i+1}</span>
                        <div>
                            <div class="text-[11px] font-bold text-slate-200">${s.name}</div>
                            <div class="text-[9px] text-slate-500 truncate w-24">${s.feedback || '...'}</div>
                        </div>
                    </div>
                    <span class="bg-brand-600/20 text-brand-400 border border-brand-500/20 text-[10px] font-bold px-2 py-1 rounded-lg">${s.score}</span>
                </div>
            `).join('');
        }
        
        async function generate() {
            const btn = document.getElementById('btnGen');
            const promptVal = document.getElementById('prompt').value;
            if(!promptVal) return showAlert("Isi topik materi dulu!", "‚ö†Ô∏è");

            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Sedang Berpikir...'; btn.disabled = true;
            try {
                const res = await fetch('/api/generate', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ instruksi: promptVal }) 
                });
                lastGeneratedData = await res.json();
                
                document.getElementById('preview-actions').classList.remove('hidden');
                document.getElementById('mini-judul').innerText = lastGeneratedData.judul;
                document.getElementById('slide-judul').innerText = lastGeneratedData.judul;
                document.getElementById('slide-konten').innerHTML = lastGeneratedData.html;
                
                showAlert("Materi berhasil dibuat!", "‚ú®");
            } catch (e) { showAlert("Gagal membuat materi", "‚ùå"); }
            btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Buat Materi & Soal'; btn.disabled = false;
        }

        function mulaiKuisAI() {
            if (!lastGeneratedData) return showAlert("Buat materi dulu!", "‚ö†Ô∏è");
            socket.emit('start-quiz', { room: currentRoom, fullData: lastGeneratedData });
            allScores = []; renderScoreboardMini();
            showAlert("Kuis dikirim ke Siswa!", "üöÄ");
        }

        function publishToStudents() {
            if (!lastGeneratedData) return;
            socket.emit('new-materi', { ...lastGeneratedData, room: currentRoom });
            showAlert("Materi disiarkan!", "üì°");
        }

        // --- UI UTILITY ---
        function switchTab(panelName, btn) {
            // Remove active from all contents
            document.querySelectorAll('.panel-content').forEach(p => p.classList.remove('active'));
            // Remove active from all tabs
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            
            // Set active
            document.getElementById(`panel-${panelName}`).classList.add('active');
            btn.classList.add('active');
            
            // Remove notification pulse if opening chat
            if(panelName === 'chat') btn.classList.remove('text-brand-400', 'animate-pulse');
        }

        // Helper untuk tombol kontrol bawah membuka tab sidebar
        function openSidebarTab(panelName) {
            // Trigger click pada tab yang sesuai
            const tabs = document.querySelectorAll('.tab-btn');
            const map = {'ai': 0, 'participants': 1, 'chat': 2};
            if(tabs[map[panelName]]) tabs[map[panelName]].click();
            
            // Di mobile, buka sidebar
            if(window.innerWidth <= 1024) document.getElementById('left-sidebar').classList.add('sidebar-active');
        }

        function toggleSidebarMenu() {
            document.getElementById('left-sidebar').classList.toggle('sidebar-active');
        }

        function switchDisplayMode() {
            if(!lastGeneratedData) return showAlert("Belum ada materi!", "‚ö†Ô∏è");
            isPresentationMode = !isPresentationMode;
            const stage = document.getElementById('presentation-stage');
            const video = document.getElementById('guru-live-cam');
            if(isPresentationMode) { stage.style.display = 'block'; video.style.opacity = '0.05'; } 
            else { stage.style.display = 'none'; video.style.opacity = '1'; }
        }

        async function initCameras() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('guru-live-cam').srcObject = stream;
                
                const canvas = document.createElement('canvas'); 
                const ctx = canvas.getContext('2d');
                canvas.width = 480; canvas.height = 360;
                
                setInterval(() => {
                    if(!isCamOff) {
                        ctx.drawImage(document.getElementById('guru-live-cam'), 0, 0, canvas.width, canvas.height);
                        socket.emit('update-frame', { room: currentRoom, image: canvas.toDataURL('image/jpeg', 0.5) });
                    }
                }, 200);
            } catch (e) { showAlert("Kamera tidak terdeteksi", "‚ùå"); }
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('btn-mic');
            const track = document.getElementById('guru-live-cam').srcObject.getAudioTracks()[0];
            if(track) track.enabled = !isMuted;
            if(isMuted) { btn.classList.add('danger'); btn.querySelector('span').innerText = "Unmute"; btn.querySelector('i').className = "fa-solid fa-microphone-slash"; }
            else { btn.classList.remove('danger'); btn.querySelector('span').innerText = "Mute"; btn.querySelector('i').className = "fa-solid fa-microphone"; }
        }

        function toggleVideo() {
            isCamOff = !isCamOff;
            const btn = document.getElementById('btn-cam');
            const track = document.getElementById('guru-live-cam').srcObject.getVideoTracks()[0];
            if(track) track.enabled = !isCamOff;
            if(isCamOff) { btn.classList.add('danger'); btn.querySelector('span').innerText = "Start Cam"; btn.querySelector('i').className = "fa-solid fa-video-slash"; }
            else { btn.classList.remove('danger'); btn.querySelector('span').innerText = "Stop Cam"; btn.querySelector('i').className = "fa-solid fa-video"; }
        }

        async function loadKelas() {
            const res = await fetch(`/api/kelas/${kodeSekolah}`);
            const data = await res.json();
            const sel = document.getElementById('select-kelas');
            sel.innerHTML = '<option value="">UMUM (Semua)</option>';
            data.forEach(k => sel.innerHTML += `<option value="${k.nama_kelas}">${k.nama_kelas}</option>`);
        }

        function pindahKelas() {
            const k = document.getElementById('select-kelas').value;
            const newRoom = k ? `${kodeSekolah}-${k}` : kodeSekolah;
            socket.emit('switch-room', { oldRoom: currentRoom, newRoom: newRoom });
            currentRoom = newRoom;
            document.getElementById('current-room-label').innerText = k || "Umum";
            document.getElementById('chat-container').innerHTML = '<div class="text-center text-[10px] text-slate-600 my-4 bg-dark-700/50 inline-block px-3 py-1 rounded-full mx-auto self-center">-- Room Baru --</div>';
            allScores = []; renderScoreboardMini();
            showAlert(`Pindah ke ${k || 'Umum'}`, "üì°");
        }

        async function tambahKelas() {
            const n = prompt("Nama Kelas Baru:");
            if(!n) return;
            await fetch('/api/kelas', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ kode_sekolah: kodeSekolah, nama_kelas: n }) });
            loadKelas();
        }

        socket.on('update-attendance', (listSiswa) => {
            document.getElementById('count-absen-badge').innerText = listSiswa.length;
            const listUI = document.getElementById('list-absen');
            listUI.innerHTML = listSiswa.length === 0 ? '<li class="text-center text-[10px] text-slate-600 italic mt-10">Menunggu siswa bergabung...</li>' : "";
            listSiswa.forEach(s => {
                listUI.innerHTML += `
                    <li class="flex items-center gap-3 bg-dark-700/50 p-2.5 rounded-xl border border-transparent hover:border-brand-500/30 transition">
                        <div class="w-2 h-2 bg-emerald-500 rounded-full shadow-[0_0_8px_rgba(16,185,129,0.5)]"></div>
                        <span class="text-xs font-bold text-slate-300 tracking-wide">${s.name || s}</span>
                    </li>`;
            });
        });
        
        socket.on('join-live', (data) => {
            const grid = document.getElementById('students-live-grid');
            const safeId = data.name.replace(/\s+/g, '-');
            if (!document.getElementById(`tile-${safeId}`)) {
                const t = document.createElement('div');
                t.id = `tile-${safeId}`; t.className = "student-tile cursor-pointer";
                t.onclick = () => fokusKeMurid(data.image, data.name);
                t.innerHTML = `<img id="img-tile-${safeId}" class="w-full h-full object-cover opacity-90 hover:opacity-100 transition duration-300">
                               <div class="absolute bottom-1 left-1 bg-black/70 backdrop-blur-sm text-[8px] px-2 py-0.5 rounded-md text-white font-bold tracking-wide">${data.name}</div>`;
                grid.appendChild(t);
            }
        });
        
        socket.on('receive-frame', (data) => {
            const img = document.getElementById(`img-tile-${data.name.replace(/\s+/g, '-')}`);
            if (img) img.src = data.image;
        });

        function fokusKeMurid(img, nama) {
            const view = document.getElementById('fokus-murid-view');
            if(view.classList.contains('hidden')) {
                view.src = img || '';
                view.classList.remove('hidden');
                showAlert(`Memantau: ${nama}`, "üëÄ");
            } else { view.classList.add('hidden'); }
        }
        
        function showAlert(msg, icon = 'üí°') {
            const a = document.getElementById('customAlert');
            document.getElementById('alertMsg').innerText = msg;
            document.getElementById('alertIcon').innerText = icon;
            a.style.opacity = '1'; a.style.transform = 'translate(-50%, 0)';
            setTimeout(() => { a.style.opacity = '0'; a.style.transform = 'translate(-50%, -20px)'; }, 3000);
        }

        function toggleCleanFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        function muteAllStudents() { socket.emit('mute-all', { room: currentRoom }); showAlert("Semua mic siswa dimatikan", "üîá"); }
        function exportAbsensi(t) { showAlert("Mempersiapkan PDF...", "print"); }
        function exportLaporan(t) { showAlert("Mendownload Excel...", "print"); }
        
        let targetMuridKoreksi = "";
        function bukaKoreksi(n, s, f) { 
            targetMuridKoreksi = n; 
            document.getElementById('koreksi-nama').innerText = n; 
            document.getElementById('input-skor-baru').value = s; 
            document.getElementById('input-catatan-baru').value = f; 
            document.getElementById('modal-koreksi').classList.add('modal-active'); 
        }
        function tutupKoreksi() { document.getElementById('modal-koreksi').classList.remove('modal-active'); }
        function simpanKoreksi() {
            tutupKoreksi(); showAlert("Nilai berhasil diperbarui!", "‚úÖ");
        }

        window.onload = initCameras;
    </script>
</body>
</html>
