<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Teacher Studio - Live Command (Light Mode)</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6', // Biru Cerah
                            600: '#2563eb',
                            700: '#1d4ed8',
                        },
                        slate: {
                            50: '#f8fafc', // Background Utama
                            100: '#f1f5f9', // Panel Background
                            200: '#e2e8f0', // Border
                            800: '#1e293b', // Teks Utama
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background: #f8fafc; color: #1e293b; overflow: hidden; height: 100vh; }
        
        /* Layout Grid */
        /* Desktop: Sidebar Kiri (400px) | Main Stage Kanan (Sisa) */
        .app-layout { display: grid; grid-template-columns: 400px 1fr; height: 100vh; width: 100vw; }
        
        /* Sidebar (Kiri) - Light Theme */
        .sidebar { 
            background: #ffffff; 
            border-right: 1px solid #cbd5e1; 
            display: flex; flex-direction: column; z-index: 50; 
            transition: transform 0.3s ease; 
            box-shadow: 4px 0 24px rgba(0,0,0,0.05);
        }
        
        /* Main Stage (Kanan) - Light Theme */
        .main-stage { 
            position: relative; 
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }

        /* Mobile Responsiveness */
        @media (max-width: 1024px) {
            .app-layout { grid-template-columns: 1fr; }
            .sidebar { 
                position: absolute; left: 0; top: 0; bottom: 0; z-index: 60; 
                transform: translateX(-100%); width: 100%; max-width: 350px; 
                box-shadow: 10px 0 30px rgba(0,0,0,0.2); 
            }
            .sidebar-active { transform: translateX(0); }
            /* Pada mobile, kontrol bar lebih kecil */
            .control-bar { padding: 8px 15px; gap: 8px; width: 90%; }
        }

        /* --- STYLING KHUSUS (LIGHT MODE) --- */
        
        /* Greeting Header */
        .greeting-card {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white; padding: 20px 24px;
            display: flex; align-items: center; gap: 12px;
        }

        /* Tab Segment */
        .tab-segment { display: flex; background: #f1f5f9; border-radius: 12px; padding: 4px; margin: 15px; position: relative; gap: 4px; border: 1px solid #e2e8f0; }
        .tab-btn { flex: 1; text-align: center; padding: 8px 0; font-size: 11px; font-weight: 700; color: #64748b; border-radius: 8px; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 0.5px; position: relative; z-index: 10; }
        .tab-btn.active { background: #ffffff; color: #2563eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .tab-btn:hover { color: #2563eb; }

        /* Panel */
        .panel-container { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .panel-content { flex: 1; overflow-y: auto; padding: 15px; display: none; flex-direction: column; }
        .panel-content.active { display: flex; }

        /* Input & Forms (Light Mode) */
        .input-calm { 
            background: #ffffff; border: 1px solid #cbd5e1; color: #334155; 
            border-radius: 10px; transition: 0.2s; outline: none; width: 100%; 
        }
        .input-calm:focus { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        ::placeholder { color: #94a3b8; }

        /* Chat */
        .chat-bubble { padding: 10px 14px; border-radius: 14px; font-size: 13px; line-height: 1.4; max-width: 85%; margin-bottom: 8px; word-wrap: break-word; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .chat-in { background: #f1f5f9; color: #334155; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #e2e8f0; }
        .chat-out { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }

        /* Video Area */
        #video-container { width: 100%; height: 100%; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #guru-live-cam { 
            width: 95%; height: 90%; object-fit: contain; transform: scaleX(-1); 
            border-radius: 20px; box-shadow: 0 20px 50px -12px rgba(59, 130, 246, 0.25); border: 4px solid white;
        } 
        
        /* Floating Control Dock (Bawah) - Light Mode */
        .control-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 10px 25px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.5);
            display: flex; align-items: center; gap: 20px; z-index: 40; 
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1);
        }
        .ctrl-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 50px; height: 50px; border-radius: 16px; color: #64748b;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; font-size: 10px; font-weight: 600; gap: 6px;
        }
        .ctrl-btn:hover { background: #f1f5f9; color: #2563eb; transform: translateY(-4px); }
        .ctrl-btn.active { color: #2563eb; background: #eff6ff; }
        .ctrl-btn.danger { color: #ef4444; }
        .ctrl-btn.danger:hover { background: #fef2f2; color: #dc2626; }
        .ctrl-btn i { font-size: 18px; }

        /* Live Badge (Atas) */
        .live-badge { 
            position: absolute; top: 25px; left: 25px; 
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px);
            padding: 6px 14px; border-radius: 8px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px;
            display: flex; align-items: center; gap: 8px; z-index: 20; color: #ef4444;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border: 1px solid #fecaca;
        }
        .blink-dot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; animation: blink 1.5s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Modal Slide Presentation */
        #presentation-stage { 
            position: absolute; inset: 20px; 
            background: #ffffff; color: #1e293b; z-index: 10; 
            padding: 50px 80px; overflow-y: auto; display: none; 
            border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); border: 1px solid #e2e8f0;
        }

        /* Modal & Overlays */
        .modal-overlay { background: rgba(0,0,0,0.4); position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-active { display: flex !important; }

        /* Student Tiles */
        .student-grid-mini { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 0 5px; }
        .student-tile { aspect-ratio: 16/9; background: #f8fafc; border-radius: 10px; overflow: hidden; position: relative; border: 1px solid #e2e8f0; transition: 0.2s; }
        .student-tile:hover { border-color: #3b82f6; transform: scale(1.02); z-index: 2; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }

        /* Button Gradient */
        .btn-gradient { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; transition: 0.3s; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        .btn-gradient:hover { box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4); transform: translateY(-2px); }
        
        /* Mobile Toggle Button (Dark to fit light header) */
        .mobile-menu-btn {
             background: white; color: #334155; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <div class="app-layout">
        <aside id="left-sidebar" class="sidebar">
            
            <div class="greeting-card">
                <div class="bg-white/20 p-2 rounded-full backdrop-blur-sm">
                    <i class="fa-solid fa-chalkboard-user text-xl"></i>
                </div>
                <div>
                    <p class="text-[10px] font-medium opacity-90 uppercase tracking-widest">Selamat Mengajar</p>
                    <h1 class="text-sm font-bold truncate"><%= nama_guru %></h1>
                </div>
            </div>

            <div class="tab-segment">
                <div class="tab-btn active" onclick="switchTab('ai', this)">‚ú® Materi AI</div>
                <div class="tab-btn" onclick="switchTab('participants', this)">üë• Absen</div>
                <div class="tab-btn" onclick="switchTab('chat', this)">üí¨ Chat</div>
            </div>

            <div class="panel-container">
                <div id="panel-ai" class="panel-content active">
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 mb-5">
                        <div class="flex justify-between items-center mb-3">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Pilih Kelas</label>
                            <button onclick="tambahKelas()" class="text-[10px] text-brand-600 font-bold hover:text-brand-500">+ Buat Baru</button>
                        </div>
                        <select id="select-kelas" onchange="pindahKelas()" class="input-calm p-2 text-xs font-bold mb-1"></select>
                    </div>

                    <div class="mb-2">
                        <label class="text-[10px] font-bold text-brand-600 uppercase tracking-widest mb-2 block ml-1">AI Generator</label>
                        <textarea id="prompt" class="input-calm h-28 p-3 text-xs mb-3 resize-none font-medium leading-relaxed bg-white" placeholder="Ketik topik materi (contoh: Fotosintesis pada Tumbuhan...)"></textarea>
                        <button id="btnGen" onclick="generate()" class="w-full py-3 rounded-xl font-bold text-xs uppercase btn-gradient">
                            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Buat Materi & Soal
                        </button>
                    </div>

                    <div id="preview-actions" class="hidden space-y-3 mt-4 animate-[fadeIn_0.5s]">
                        <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-xl flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xs"><i class="fa-solid fa-check"></i></div>
                            <div class="flex-1 min-w-0">
                                <p class="text-[9px] text-emerald-600 font-bold uppercase">Materi Siap</p>
                                <h4 id="mini-judul" class="font-bold text-xs text-slate-700 truncate">...</h4>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="publishToStudents()" class="py-3 bg-slate-100 border border-slate-200 hover:border-brand-500 hover:bg-white rounded-xl text-[10px] font-bold uppercase text-slate-500 hover:text-brand-600 transition">üì° Siarkan Materi</button>
                            <button onclick="mulaiKuisAI()" class="py-3 bg-amber-50 text-amber-600 border border-amber-200 hover:bg-amber-100 rounded-xl text-[10px] font-bold uppercase transition">üöÄ Mulai Kuis</button>
                        </div>
                        <button onclick="switchDisplayMode()" class="w-full py-3 bg-transparent border border-brand-200 text-brand-600 rounded-xl text-[10px] font-bold uppercase hover:bg-brand-50 transition">üì∫ Tampilkan di Layar Utama</button>
                    </div>

                    <div class="mt-auto pt-6 border-t border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-xs font-black uppercase text-slate-400 tracking-wider">Live Scoreboard</span>
                            <button onclick="exportLaporan('excel')" class="text-[9px] bg-slate-100 hover:bg-brand-600 px-2 py-1 rounded text-slate-500 hover:text-white transition font-bold border border-slate-200">Export XLS</button>
                        </div>
                        <div class="space-y-2 max-h-40 overflow-y-auto pr-1" id="live-score-body">
                            <div class="text-center text-[10px] text-slate-400 font-medium py-4">Belum ada nilai masuk</div>
                        </div>
                    </div>
                </div>

                <div id="panel-participants" class="panel-content">
                    <div class="flex justify-between items-center mb-4 sticky top-0 bg-white pb-2 z-10 border-b border-slate-100">
                        <span class="text-xs font-bold text-slate-500">DAFTAR SISWA <span id="count-absen-badge" class="ml-1 bg-brand-100 text-brand-600 px-1.5 py-0.5 rounded text-[9px] border border-brand-200">0</span></span>
                        <button onclick="exportAbsensi('pdf')" class="text-[9px] text-brand-500 hover:text-brand-600 font-bold bg-brand-50 px-2 py-1 rounded">Download PDF</button>
                    </div>
                    <ul id="list-absen" class="space-y-2 mb-6">
                        <li class="text-center text-[10px] text-slate-400 italic mt-10">Menunggu siswa bergabung...</li>
                    </ul>
                    
                    <div class="border-t border-slate-200 pt-5 mt-auto">
                        <span class="text-[10px] font-bold text-slate-400 block mb-3 uppercase tracking-wider">Kamera Siswa</span>
                        <div id="students-live-grid" class="student-grid-mini"></div>
                    </div>
                </div>

                <div id="panel-chat" class="panel-content !p-0 h-full flex flex-col">
                    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                        <div class="text-center text-[10px] text-slate-400 my-4 bg-white border border-slate-200 inline-block px-3 py-1 rounded-full mx-auto self-center">-- Awal Percakapan --</div>
                    </div>
                    <div class="p-3 bg-white border-t border-slate-200 sticky bottom-0">
                        <form onsubmit="kirimChat(event)" class="flex gap-2 relative">
                            <input type="text" id="chat-input" class="input-calm py-3 pl-4 pr-10 text-xs shadow-sm bg-slate-50" placeholder="Tulis pesan..." autocomplete="off">
                            <button type="submit" class="absolute right-2 top-1.5 bottom-1.5 w-8 rounded-lg flex items-center justify-center text-brand-500 hover:bg-brand-500 hover:text-white transition">
                                <i class="fa-solid fa-paper-plane text-xs"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </aside>

        <main class="main-stage">
            <div class="live-badge shadow-sm">
                <div class="blink-dot"></div>
                <span>LIVE ‚Ä¢ <span id="current-room-label" class="opacity-90 font-medium">Umum</span></span>
            </div>

            <button onclick="toggleSidebarMenu()" class="lg:hidden absolute top-6 right-6 z-30 mobile-menu-btn p-2 rounded-lg shadow-lg border border-slate-100">
                <i class="fa-solid fa-bars"></i>
            </button>

            <div id="video-container">
                <video id="guru-live-cam" autoplay playsinline muted></video>
                <img id="fokus-murid-view" class="hidden w-full h-full object-contain bg-black z-20 absolute inset-0">
                
                <div id="presentation-stage" class="prose max-w-none prose-slate prose-headings:font-bold prose-h1:text-brand-600">
                    <button onclick="switchDisplayMode()" class="absolute top-6 right-6 text-slate-400 hover:text-red-500 transition z-50 p-2 bg-slate-100 rounded-full w-10 h-10 flex items-center justify-center shadow-sm">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                    <h1 id="slide-judul" class="text-4xl font-black mb-8 border-b pb-6"></h1>
                    <div id="slide-konten" class="text-xl leading-relaxed text-slate-600 font-medium"></div>
                </div>
            </div>

            <div class="control-bar">
                <div class="ctrl-btn" onclick="toggleMute()" id="btn-mic">
                    <i class="fa-solid fa-microphone"></i>
                    <span>Mute</span>
                </div>
                <div class="ctrl-btn" onclick="toggleVideo()" id="btn-cam">
                    <i class="fa-solid fa-video"></i>
                    <span>Cam Off</span>
                </div>
                
                <div class="w-px h-8 bg-slate-300 mx-1"></div>

                <div class="ctrl-btn lg:hidden" onclick="openSidebarTab('ai')">
                    <i class="fa-solid fa-wand-magic-sparkles text-brand-500"></i>
                    <span>Materi AI</span>
                </div>
                
                <div class="ctrl-btn" onclick="toggleCleanFullScreen()">
                    <i class="fa-solid fa-expand"></i>
                    <span>Full</span>
                </div>
                <div class="ctrl-btn danger" onclick="muteAllStudents()">
                    <i class="fa-solid fa-volume-xmark"></i>
                    <span>Mute All</span>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-koreksi" class="modal-overlay">
        <div class="bg-white w-full max-w-md rounded-3xl p-8 text-slate-800 shadow-2xl animate-[slideIn_0.3s_ease-out] border border-slate-200">
            <h3 class="text-xl font-black mb-1">Koreksi Nilai</h3>
            <p id="koreksi-nama" class="text-brand-600 text-sm font-bold mb-6 uppercase tracking-wider"></p>
            
            <label class="block text-[10px] font-bold uppercase text-slate-400 mb-2">Skor Baru</label>
            <input type="number" id="input-skor-baru" class="input-calm p-4 font-bold text-xl mb-5 text-center bg-slate-50 border-slate-200">
            
            <label class="block text-[10px] font-bold uppercase text-slate-400 mb-2">Feedback Guru</label>
            <textarea id="input-catatan-baru" class="input-calm p-4 text-sm h-28 resize-none bg-slate-50 border-slate-200 mb-8"></textarea>
            
            <div class="flex gap-3">
                <button onclick="tutupKoreksi()" class="flex-1 py-3 text-slate-500 font-bold text-sm hover:bg-slate-100 rounded-xl transition border border-transparent hover:border-slate-200">Batal</button>
                <button onclick="simpanKoreksi()" class="flex-1 py-3 bg-brand-600 text-white font-bold text-sm rounded-xl hover:bg-brand-500 shadow-lg transition">Simpan</button>
            </div>
        </div>
    </div>

    <div id="customAlert" class="fixed top-8 left-1/2 -translate-x-1/2 z-[2000] bg-white text-slate-800 pl-4 pr-6 py-3 rounded-full border border-slate-200 shadow-xl flex items-center gap-3 transition-all duration-300 opacity-0 pointer-events-none translate-y-[-20px]">
        <div id="alertIcon" class="text-lg animate-bounce">üí°</div>
        <div id="alertMsg" class="text-xs font-bold tracking-wide">Alert message</div>
    </div>

    <script>
        // --- JAVASCRIPT LOGIC (SAMA PERSIS DENGAN SEBELUMNYA) ---
        const socket = io();
        const namaGuru = "<%= nama_guru %>";
        const kodeSekolah = "<%= kode %>";
        
        let currentRoom = kodeSekolah;
        let lastGeneratedData = null;
        let allScores = [];
        let isPresentationMode = false;
        let isMuted = false;
        let isCamOff = false;

        socket.on('connect', () => {
            socket.emit('join-room', { room: currentRoom, nama: namaGuru, role: 'Guru' });
            loadKelas();
        });

        socket.on('chat-message', (data) => {
            const container = document.getElementById('chat-container');
            const isMe = data.user === namaGuru;
            const align = isMe ? 'chat-out' : 'chat-in';
            const meta = isMe ? 'Anda' : data.user;
            
            if (!isMe && !document.getElementById('panel-chat').classList.contains('active')) {
                document.querySelectorAll('.tab-btn')[2].classList.add('text-brand-600', 'animate-pulse');
            }

            container.innerHTML += `
                <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} animate-[fadeIn_0.3s]">
                    <span class="text-[9px] text-slate-400 mb-1 ml-1 font-bold">${meta}</span>
                    <div class="chat-bubble ${align}">${data.msg}</div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
        });

        function kirimChat(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;
            
            socket.emit('chat-message', {
                room: currentRoom,
                user: namaGuru,
                msg: msg,
                role: 'Guru'
            });
            input.value = '';
        }

        socket.on('score-updated-live', (data) => {
            const ex = allScores.findIndex(s => s.name === data.nama_siswa);
            if(ex > -1) { allScores[ex] = { ...allScores[ex], ...data }; } 
            else { allScores.push({ name: data.nama_siswa, score: data.skor, feedback: data.umpan_balik }); }
            renderScoreboardMini();
            showAlert(`${data.nama_siswa} selesai! Skor: ${data.skor}`, "‚úÖ");
        });

        function renderScoreboardMini() {
            const container = document.getElementById('live-score-body');
            allScores.sort((a,b) => b.score - a.score);
            
            if(allScores.length === 0) {
                 container.innerHTML = '<div class="text-center text-[10px] text-slate-400 font-medium py-4">Belum ada nilai masuk</div>';
                 return;
            }

            container.innerHTML = allScores.map((s, i) => `
                <div class="bg-white p-2 rounded-xl flex items-center justify-between border border-slate-100 hover:border-brand-300 transition cursor-pointer mb-1 shadow-sm" onclick="bukaKoreksi('${s.name}', ${s.score}, '${s.feedback}')">
                    <div class="flex items-center gap-3">
                        <span class="font-black text-slate-400 text-[10px] w-4">#${i+1}</span>
                        <div>
                            <div class="text-[11px] font-bold text-slate-700">${s.name}</div>
                            <div class="text-[9px] text-slate-400 truncate w-24">${s.feedback || '...'}</div>
                        </div>
                    </div>
                    <span class="bg-brand-50 text-brand-600 border border-brand-100 text-[10px] font-bold px-2 py-1 rounded-lg">${s.score}</span>
                </div>
            `).join('');
        }
        
        async function generate() {
            const btn = document.getElementById('btnGen');
            const promptVal = document.getElementById('prompt').value;
            if(!promptVal) return showAlert("Isi topik materi dulu!", "‚ö†Ô∏è");

            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Sedang Berpikir...'; btn.disabled = true;
            try {
                const res = await fetch('/api/generate', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ instruksi: promptVal }) 
                });
                lastGeneratedData = await res.json();
                
                document.getElementById('preview-actions').classList.remove('hidden');
                document.getElementById('mini-judul').innerText = lastGeneratedData.judul;
                document.getElementById('slide-judul').innerText = lastGeneratedData.judul;
                document.getElementById('slide-konten').innerHTML = lastGeneratedData.html;
                
                showAlert("Materi berhasil dibuat!", "‚ú®");
            } catch (e) { showAlert("Gagal membuat materi", "‚ùå"); }
            btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Buat Materi & Soal'; btn.disabled = false;
        }

        function mulaiKuisAI() {
            if (!lastGeneratedData) return showAlert("Buat materi dulu!", "‚ö†Ô∏è");
            socket.emit('start-quiz', { room: currentRoom, fullData: lastGeneratedData });
            allScores = []; renderScoreboardMini();
            showAlert("Kuis dikirim ke Siswa!", "üöÄ");
        }

        function publishToStudents() {
            if (!lastGeneratedData) return;
            socket.emit('new-materi', { ...lastGeneratedData, room: currentRoom });
            showAlert("Materi disiarkan!", "üì°");
        }

        // --- UI UTILITY ---
        function switchTab(panelName, btn) {
            document.querySelectorAll('.panel-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.getElementById(`panel-${panelName}`).classList.add('active');
            btn.classList.add('active');
            if(panelName === 'chat') btn.classList.remove('text-brand-600', 'animate-pulse');
        }

        function openSidebarTab(panelName) {
            const tabs = document.querySelectorAll('.tab-btn');
            const map = {'ai': 0, 'participants': 1, 'chat': 2};
            if(tabs[map[panelName]]) tabs[map[panelName]].click();
            if(window.innerWidth <= 1024) document.getElementById('left-sidebar').classList.add('sidebar-active');
        }

        function toggleSidebarMenu() {
            document.getElementById('left-sidebar').classList.toggle('sidebar-active');
        }

        function switchDisplayMode() {
            if(!lastGeneratedData) return showAlert("Belum ada materi!", "‚ö†Ô∏è");
            isPresentationMode = !isPresentationMode;
            const stage = document.getElementById('presentation-stage');
            const video = document.getElementById('guru-live-cam');
            if(isPresentationMode) { stage.style.display = 'block'; video.style.opacity = '0.05'; } 
            else { stage.style.display = 'none'; video.style.opacity = '1'; }
        }

        async function initCameras() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('guru-live-cam').srcObject = stream;
                
                const canvas = document.createElement('canvas'); 
                const ctx = canvas.getContext('2d');
                canvas.width = 480; canvas.height = 360;
                
                setInterval(() => {
                    if(!isCamOff) {
                        ctx.drawImage(document.getElementById('guru-live-cam'), 0, 0, canvas.width, canvas.height);
                        socket.emit('update-frame', { room: currentRoom, image: canvas.toDataURL('image/jpeg', 0.5) });
                    }
                }, 200);
            } catch (e) { showAlert("Kamera tidak terdeteksi", "‚ùå"); }
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('btn-mic');
            const track = document.getElementById('guru-live-cam').srcObject.getAudioTracks()[0];
            if(track) track.enabled = !isMuted;
            if(isMuted) { btn.classList.add('danger'); btn.querySelector('span').innerText = "Unmute"; btn.querySelector('i').className = "fa-solid fa-microphone-slash"; }
            else { btn.classList.remove('danger'); btn.querySelector('span').innerText = "Mute"; btn.querySelector('i').className = "fa-solid fa-microphone"; }
        }

        function toggleVideo() {
            isCamOff = !isCamOff;
            const btn = document.getElementById('btn-cam');
            const track = document.getElementById('guru-live-cam').srcObject.getVideoTracks()[0];
            if(track) track.enabled = !isCamOff;
            if(isCamOff) { btn.classList.add('danger'); btn.querySelector('span').innerText = "Start Cam"; btn.querySelector('i').className = "fa-solid fa-video-slash"; }
            else { btn.classList.remove('danger'); btn.querySelector('span').innerText = "Stop Cam"; btn.querySelector('i').className = "fa-solid fa-video"; }
        }

        async function loadKelas() {
            const res = await fetch(`/api/kelas/${kodeSekolah}`);
            const data = await res.json();
            const sel = document.getElementById('select-kelas');
            sel.innerHTML = '<option value="">UMUM (Semua)</option>';
            data.forEach(k => sel.innerHTML += `<option value="${k.nama_kelas}">${k.nama_kelas}</option>`);
        }

        function pindahKelas() {
            const k = document.getElementById('select-kelas').value;
            const newRoom = k ? `${kodeSekolah}-${k}` : kodeSekolah;
            socket.emit('switch-room', { oldRoom: currentRoom, newRoom: newRoom });
            currentRoom = newRoom;
            document.getElementById('current-room-label').innerText = k || "Umum";
            document.getElementById('chat-container').innerHTML = '<div class="text-center text-[10px] text-slate-400 my-4 bg-white border border-slate-200 inline-block px-3 py-1 rounded-full mx-auto self-center">-- Room Baru --</div>';
            allScores = []; renderScoreboardMini();
            showAlert(`Pindah ke ${k || 'Umum'}`, "üì°");
        }

        async function tambahKelas() {
            const n = prompt("Nama Kelas Baru:");
            if(!n) return;
            await fetch('/api/kelas', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ kode_sekolah: kodeSekolah, nama_kelas: n }) });
            loadKelas();
        }

        socket.on('update-attendance', (listSiswa) => {
            document.getElementById('count-absen-badge').innerText = listSiswa.length;
            const listUI = document.getElementById('list-absen');
            listUI.innerHTML = listSiswa.length === 0 ? '<li class="text-center text-[10px] text-slate-400 italic mt-10">Menunggu siswa bergabung...</li>' : "";
            listSiswa.forEach(s => {
                listUI.innerHTML += `
                    <li class="flex items-center gap-3 bg-white p-2.5 rounded-xl border border-slate-100 hover:border-brand-200 transition shadow-sm">
                        <div class="w-2 h-2 bg-emerald-500 rounded-full shadow-[0_0_8px_rgba(16,185,129,0.3)]"></div>
                        <span class="text-xs font-bold text-slate-700 tracking-wide">${s.name || s}</span>
                    </li>`;
            });
        });
        
        socket.on('join-live', (data) => {
            const grid = document.getElementById('students-live-grid');
            const safeId = data.name.replace(/\s+/g, '-');
            if (!document.getElementById(`tile-${safeId}`)) {
                const t = document.createElement('div');
                t.id = `tile-${safeId}`; t.className = "student-tile cursor-pointer";
                t.onclick = () => fokusKeMurid(data.image, data.name);
                t.innerHTML = `<img id="img-tile-${safeId}" class="w-full h-full object-cover opacity-90 hover:opacity-100 transition duration-300">
                               <div class="absolute bottom-1 left-1 bg-white/90 backdrop-blur-sm text-[8px] px-2 py-0.5 rounded-md text-slate-800 font-bold tracking-wide shadow-sm border border-slate-200">${data.name}</div>`;
                grid.appendChild(t);
            }
        });
        
        socket.on('receive-frame', (data) => {
            const img = document.getElementById(`img-tile-${data.name.replace(/\s+/g, '-')}`);
            if (img) img.src = data.image;
        });

        function fokusKeMurid(img, nama) {
            const view = document.getElementById('fokus-murid-view');
            if(view.classList.contains('hidden')) {
                view.src = img || '';
                view.classList.remove('hidden');
                showAlert(`Memantau: ${nama}`, "üëÄ");
            } else { view.classList.add('hidden'); }
        }
        
        function showAlert(msg, icon = 'üí°') {
            const a = document.getElementById('customAlert');
            document.getElementById('alertMsg').innerText = msg;
            document.getElementById('alertIcon').innerText = icon;
            a.style.opacity = '1'; a.style.transform = 'translate(-50%, 0)';
            setTimeout(() => { a.style.opacity = '0'; a.style.transform = 'translate(-50%, -20px)'; }, 3000);
        }

        function toggleCleanFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        function muteAllStudents() { socket.emit('mute-all', { room: currentRoom }); showAlert("Semua mic siswa dimatikan", "üîá"); }
        function exportAbsensi(t) { showAlert("Mempersiapkan PDF...", "print"); }
        function exportLaporan(t) { showAlert("Mendownload Excel...", "print"); }
        
        let targetMuridKoreksi = "";
        function bukaKoreksi(n, s, f) { 
            targetMuridKoreksi = n; 
            document.getElementById('koreksi-nama').innerText = n; 
            document.getElementById('input-skor-baru').value = s; 
            document.getElementById('input-catatan-baru').value = f; 
            document.getElementById('modal-koreksi').classList.add('modal-active'); 
        }
        function tutupKoreksi() { document.getElementById('modal-koreksi').classList.remove('modal-active'); }
        function simpanKoreksi() {
            tutupKoreksi(); showAlert("Nilai berhasil diperbarui!", "‚úÖ");
        }

        window.onload = initCameras;
    </script>
</body>
</html>
