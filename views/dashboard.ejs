<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Portal - Elegant Edition</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #1e293b; }
        .sidebar { background: #0f172a; }
        .card-elegant { background: white; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); transition: all 0.3s ease; }
        
        @keyframes shimmer { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .loading-state { animation: shimmer 1.5s infinite; }

        .alert-elegant {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
            color: white; padding: 1rem 2rem; border-radius: 1rem;
            border-left: 4px solid #6366f1; transform: translateX(120%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .alert-show { transform: translateX(0); }
        
        #teacher-cam, #guru-live-cam, #guru-pip-cam { transform: scaleX(-1); object-fit: cover; }
        .scroll-custom::-webkit-scrollbar { width: 4px; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        /* --- STYLING KHUSUS LIVE MODE --- */
        .live-stage { background: #020617; border: 4px solid #4f46e5; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .student-tile { background: #1e293b; border-radius: 0.75rem; overflow: hidden; position: relative; aspect-ratio: 4/3; }
        .student-tile video { width: 100%; height: 100%; object-fit: cover; }

        @media (max-width: 1023px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            aside { width: 100% !important; height: auto !important; padding: 1rem !important; position: sticky; top: 0; z-index: 100; }
            .sidebar-hide-mobile { display: none; }
            aside h1 { font-size: 1.25rem; }
            main { padding: 1.25rem !important; height: auto !important; overflow: visible !important; }
            header { flex-direction: column; align-items: flex-start !important; gap: 1rem; margin-bottom: 2rem !important; }
            #chat-panel { width: 90% !important; right: 5% !important; top: 15% !important; }
            .card-elegant { padding: 1.5rem !important; }
            #result-container { padding: 1.5rem !important; border-radius: 2rem !important; }
            #empty-state { height: 300px !important; }
            #teacher-cam-container { height: 80px !important; width: 120px !important; margin-bottom: 0 !important; }
            .sidebar-header { flex-direction: row !important; align-items: center; justify-content: space-between; width: 100%; }
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="customAlert" class="alert-elegant flex items-center gap-3">
        <span id="alertIcon">‚ú®</span>
        <span id="alertMsg" class="font-bold text-sm"></span>
    </div>

    <aside class="w-64 sidebar h-full text-white flex flex-col p-6 shadow-2xl">
        <div class="sidebar-header flex flex-col">
            <div class="mb-4 lg:mb-10">
                <h1 class="text-xl font-extrabold text-indigo-400 tracking-tighter italic">GLOBAL AI</h1>
                <p class="text-[9px] text-slate-500 font-mono tracking-widest mt-1 sidebar-hide-mobile">GURU PANEL v2.0</p>
            </div>

            <div class="mb-6 p-4 rounded-2xl bg-white/5 border border-white/10 sidebar-hide-mobile">
                <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-1">Pengajar</p>
                <h3 class="text-sm font-bold truncate"><%= nama_guru %></h3>
            </div>
            
            <div id="teacher-cam-container" class="mb-6 overflow-hidden rounded-2xl bg-slate-800 h-32 border border-white/10 relative">
                <video id="teacher-cam" class="w-full h-full absolute inset-0 bg-black" autoplay playsinline></video>
                <div class="absolute bottom-2 left-2 flex items-center gap-1">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <span class="text-[8px] font-bold uppercase tracking-widest">Live Cam</span>
                </div>
            </div>
        </div>

        <div class="mb-6 flex-1 flex flex-col min-h-0 sidebar-hide-mobile">
            <div class="flex justify-between items-center mb-3">
                <p class="text-[10px] font-black text-emerald-400 uppercase tracking-widest">Absensi Hadir</p>
                <span id="count-absen" class="bg-emerald-500 text-[9px] px-2 py-0.5 rounded-full text-white">0</span>
            </div>
            <div class="flex-1 bg-white/5 border border-white/10 rounded-2xl p-3 overflow-hidden flex flex-col">
                <ul id="list-absen" class="space-y-2 overflow-y-auto scroll-custom text-[11px] font-bold text-slate-400 max-h-40">
                    <li class="italic text-slate-600 font-normal">Menunggu kelas...</li>
                </ul>
                <div class="mt-4 pt-4 border-t border-white/10 grid grid-cols-3 gap-1">
                    <button onclick="exportLaporan('pdf')" class="p-2 bg-slate-800 hover:bg-red-500/20 text-[8px] rounded-lg transition-all">PDF</button>
                    <button onclick="exportLaporan('excel')" class="p-2 bg-slate-800 hover:bg-emerald-500/20 text-[8px] rounded-lg transition-all">XLS</button>
                    <button onclick="exportLaporan('word')" class="p-2 bg-slate-800 hover:bg-blue-500/20 text-[8px] rounded-lg transition-all">DOC</button>
                </div>
            </div>
        </div>
        
        <div class="pt-6 border-t border-slate-800 sidebar-hide-mobile">
            <a href="/logout" class="text-xs font-bold text-red-400 flex items-center gap-2 hover:opacity-70 transition-all">üö™ LOGOUT</a>
        </div>
    </aside>

    <main class="flex-1 h-full overflow-y-auto p-8 lg:p-12 relative">
        <header class="flex justify-between items-end mb-12">
            <div>
                <h2 class="text-2xl lg:text-3xl font-extrabold text-slate-800 leading-tight">Halo, Guru <%= nama_guru %>!</h2>
                <p class="text-slate-500 text-[10px] lg:text-sm mt-1 uppercase tracking-widest font-bold">üè´ <%= instansi %> ‚Ä¢ ID: <%= kode %></p>
            </div>
            <div>
                <div class="card-elegant px-4 py-2 rounded-2xl flex items-center gap-4">
                    <div class="flex flex-col">
                        <span class="text-[8px] font-black text-indigo-400 uppercase">Ruang Kelas</span>
                        <select id="select-kelas" onchange="pindahKelas()" class="text-[11px] font-bold text-slate-700 bg-transparent outline-none">
                            <option value="">-- Pilih Kelas --</option>
                        </select>
                    </div>
                    <button onclick="tambahKelas()" class="w-8 h-8 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center">Ôºã</button>
                </div>
            </div>
        </header>

        <section id="live-classroom" class="mb-12">
            <div class="live-stage p-6 rounded-[2.5rem] shadow-2xl">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <div class="flex items-center gap-3">
                        <span class="px-3 py-1 bg-red-600 text-white text-[10px] font-bold rounded-full animate-pulse">LIVE CLASS</span>
                        <p class="text-white text-xs font-bold uppercase tracking-widest">Mode: <span id="current-mode-label" class="text-indigo-400">Wajah Guru</span></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="switchDisplayMode()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] font-bold hover:bg-indigo-500 transition-all">üîÑ GANTI KE MATERI</button>
                        <button onclick="muteAllStudents()" class="bg-amber-500 text-white px-4 py-2 rounded-xl text-[10px] font-bold hover:bg-amber-400">üîá MUTE SEMUA</button>
                    </div>
                </div>

                <div id="main-stage" class="relative w-full h-[300px] lg:h-[500px] bg-black rounded-3xl overflow-hidden mb-6 shadow-2xl">
                    <video id="guru-live-cam" class="w-full h-full object-cover" autoplay playsinline muted></video>
                    
                    <div id="presentation-stage" class="hidden absolute inset-0 bg-white p-10 overflow-y-auto prose prose-slate max-w-none">
                        <h1 id="slide-judul" class="text-indigo-600 font-extrabold"></h1>
                        <div id="slide-konten"></div>
                    </div>

                    <div id="mini-guru-cam" class="hidden absolute bottom-6 right-6 w-44 h-32 bg-black rounded-2xl border-2 border-indigo-500 overflow-hidden z-20 shadow-2xl">
                        <video id="guru-pip-cam" class="w-full h-full object-cover" autoplay playsinline muted></video>
                    </div>
                </div>

                <div class="mt-8 border-t border-white/10 pt-6 mb-8">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4 gap-4">
                        <div>
                            <p class="text-slate-400 text-[10px] font-black uppercase tracking-[0.2em]">Live Scoreboard & Ranking</p>
                            <p id="active-quiz-title" class="text-indigo-400 text-xs font-bold italic mt-1">Belum ada kuis aktif</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="exportFullData('excel')" class="bg-emerald-600/20 text-emerald-400 border border-emerald-500/30 px-4 py-2 rounded-xl text-[10px] font-bold hover:bg-emerald-600 hover:text-white transition-all">EXPORT EXCEL</button>
                            <button onclick="exportFullData('pdf')" class="bg-red-600/20 text-red-400 border border-red-500/30 px-4 py-2 rounded-xl text-[10px] font-bold hover:bg-red-600 hover:text-white transition-all">EXPORT PDF</button>
                        </div>
                    </div>
                    <div class="overflow-hidden rounded-2xl border border-white/5 bg-white/5 backdrop-blur-sm">
                        <table class="w-full text-left text-[11px] text-slate-300">
                            <thead class="bg-slate-800 text-slate-400 uppercase text-[9px] font-black">
                                <tr>
                                    <th class="p-4">Rank</th>
                                    <th class="p-4">Nama Murid</th>
                                    <th class="p-4">Skor</th>
                                    <th class="p-4">Analisis AI / Jawaban</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="live-score-body">
                                <tr id="empty-score-row">
                                    <td colspan="6" class="p-10 text-center text-slate-600 italic">Menunggu murid menyelesaikan kuis...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="border-t border-white/10 pt-6">
                    <p class="text-slate-500 text-[10px] font-bold mb-4 uppercase tracking-widest">Grid Peserta Didik</p>
                    <div id="students-live-grid" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-10 gap-3"></div>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            <div class="lg:col-span-4">
                <div class="card-elegant p-8 rounded-[2rem]">
                    <div class="flex items-center gap-2 mb-6">
                        <div class="w-1 h-6 bg-indigo-500 rounded-full"></div>
                        <h3 class="font-black text-slate-700 uppercase text-xs tracking-widest">Instruksi AI</h3>
                    </div>
                    <textarea id="prompt" class="w-full h-40 lg:h-56 bg-slate-50 border border-slate-200 rounded-2xl p-5 outline-none text-slate-700 resize-none" placeholder="Contoh: Buatkan materi sejarah..."></textarea>
                    <button id="btnGen" onclick="generate()" class="w-full mt-6 bg-slate-900 text-white py-5 rounded-2xl font-black shadow-xl shadow-slate-200 transition-all hover:scale-[1.02] flex justify-center items-center gap-3">
                        <span id="btnIcon">üöÄ</span> <span id="btnText">PRODUKSI SEKARANG</span>
                    </button>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div id="preview-area" class="hidden">
                    <div class="flex flex-col lg:flex-row justify-between lg:items-center mb-6 gap-3">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em]">Materi Terbuat</span>
                        <div class="flex gap-2">
                            <button onclick="publishToStudents()" class="bg-indigo-600 text-white px-6 py-3 rounded-full text-[10px] font-black hover:bg-indigo-500 transition-all uppercase">Kirim Materi</button>
                            <button onclick="publishQuiz()" class="bg-amber-500 text-white px-6 py-3 rounded-full text-[10px] font-black hover:bg-amber-400 transition-all uppercase">üéØ Kuis Live</button>
                        </div>
                    </div>
                    <div id="result-container" class="card-elegant p-12 rounded-[3rem] prose prose-slate max-w-none border-t-8 border-indigo-500 overflow-x-auto">
                        <h1 id="res-judul" class="text-slate-800 font-extrabold text-xl lg:text-3xl"></h1>
                        <div id="res-html" class="text-slate-600 leading-relaxed text-sm lg:text-base"></div>
                    </div>
                </div>
                <div id="empty-state" class="card-elegant h-[500px] rounded-[3rem] flex flex-col items-center justify-center border-dashed border-2 border-slate-200 opacity-60">
                    <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center text-3xl mb-4">‚úçÔ∏è</div>
                    <p class="text-slate-400 font-bold uppercase text-xs tracking-widest">Menunggu Input Instruksi Guru</p>
                </div>
            </div>
        </section>

        <section class="mt-20 pt-10 border-t border-slate-200">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-end mb-8 gap-4">
                <div>
                    <h3 class="text-2xl font-extrabold text-slate-800 tracking-tight">Pusat Evaluasi & Analitik</h3>
                    <p class="text-slate-500 text-sm mt-1">Data riwayat kuis dan grafik performa dari PostgreSQL</p>
                </div>
                <button onclick="muatRiwayat()" class="bg-slate-900 text-white px-6 py-3 rounded-2xl text-[10px] font-black hover:bg-slate-800 shadow-lg shadow-slate-200 transition-all uppercase tracking-widest flex items-center gap-2">
                    üîÑ <span>Update Data Database</span>
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
                <div class="card-elegant p-6 rounded-[2rem] border-l-4 border-indigo-500">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Rata-rata Kelas</p>
                    <h4 id="avg-score" class="text-3xl font-black text-slate-800 mt-2">-</h4>
                    <p class="text-[10px] text-slate-400 font-bold mt-1">Kalkulasi Semua Kuis</p>
                </div>
                <div class="card-elegant p-6 rounded-[2rem] border-l-4 border-emerald-500">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Lulus KKM (>75)</p>
                    <h4 id="pass-count" class="text-3xl font-black text-slate-800 mt-2">-</h4>
                    <p class="text-[10px] text-emerald-500 font-bold mt-1">Siswa Berprestasi</p>
                </div>
                <div class="card-elegant p-6 rounded-[2rem] border-l-4 border-amber-500">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Sesi</p>
                    <h4 id="quiz-count" class="text-3xl font-black text-slate-800 mt-2">-</h4>
                    <p class="text-[10px] text-slate-400 font-bold mt-1">Materi Tersimpan</p>
                </div>
            </div>

            <div class="card-elegant rounded-[2.5rem] overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-slate-50 text-slate-400 uppercase text-[9px] font-black">
                            <tr>
                                <th class="p-6">Waktu & Sesi</th>
                                <th class="p-6">Nama Murid</th>
                                <th class="p-6">Grafik Performa</th>
                                <th class="p-6">Skor</th>
                                <th class="p-6 text-right">Status DB</th>
                            </tr>
                        </thead>
                        <tbody id="history-body" class="divide-y divide-slate-100">
                            <tr>
                                <td colspan="5" class="p-20 text-center">
                                    <div class="flex flex-col items-center opacity-40">
                                        <span class="text-4xl mb-4">üìÇ</span>
                                        <p class="font-bold uppercase tracking-widest">Klik "Update Data" untuk memuat riwayat</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        <div id="chat-panel" class="hidden absolute right-8 top-32 w-80 bg-white border border-slate-200 rounded-3xl shadow-2xl z-50 flex flex-col overflow-hidden animate-pop">
            <div class="p-4 bg-indigo-600 text-white font-bold text-xs flex justify-between items-center">
                <span>CHAT KELAS LIVE</span>
                <button onclick="toggleChat()">‚úï</button>
            </div>
            <div id="chat-box" class="h-80 overflow-y-auto p-4 space-y-3 text-[11px]"></div>
            <div class="p-3 border-t border-slate-100 flex gap-2">
                <input id="chat-input" type="text" placeholder="Ketik pesan..." class="flex-1 bg-slate-50 p-2 rounded-xl text-xs outline-none">
                <button onclick="sendChat()" class="text-lg">üöÄ</button>
            </div>
        </div>

        <button onclick="toggleChat()" class="lg:hidden fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-2xl flex items-center justify-center text-xl z-50">üí¨</button>
    </main>

    <script>
        const socket = io();
        const namaGuru = "<%= nama_guru %>";
        const kodeSekolah = "<%= kode %>";
        const instansi = "<%= instansi %>";
        let lastGeneratedData = null;
        let currentRoom = null;
        let currentAbsen = [];
        let isPresentationMode = false;
        let allScores = [];

        // --- KAMERA & STREAMING ---
        async function initLiveCameras() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 }, 
                    audio: true 
                });
                document.getElementById('teacher-cam').srcObject = stream;
                document.getElementById('guru-live-cam').srcObject = stream;
                document.getElementById('guru-pip-cam').srcObject = stream;
                startStreamingToStudents();
            } catch (err) { 
                console.warn("Akses kamera ditolak", err);
                showAlert("Kamera tidak aktif!", "‚ùå");
            }
        }

        function startStreamingToStudents() {
            const video = document.getElementById('guru-live-cam');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 300;
            function broadcastFrame() {
                if (video.paused || video.ended) return;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const frameData = canvas.toDataURL('image/jpeg', 0.5);
                socket.emit('update-frame', { room: currentRoom || kodeSekolah, image: frameData });
                requestAnimationFrame(broadcastFrame);
            }
            video.onplay = () => broadcastFrame();
        }

        function switchDisplayMode() {
            if(!lastGeneratedData) return showAlert("Buat materi dulu dengan AI!", "‚ö†Ô∏è");
            isPresentationMode = !isPresentationMode;
            const stage = document.getElementById('presentation-stage');
            const mainCam = document.getElementById('guru-live-cam');
            const miniCam = document.getElementById('mini-guru-cam');
            const label = document.getElementById('current-mode-label');

            if(isPresentationMode) {
                stage.classList.remove('hidden');
                mainCam.classList.add('opacity-0');
                miniCam.classList.remove('hidden');
                label.innerText = "Materi Pembelajaran";
                document.getElementById('slide-judul').innerText = lastGeneratedData.judul;
                document.getElementById('slide-konten').innerHTML = lastGeneratedData.html;
                socket.emit('change-view-mode', { mode: 'presentation', room: currentRoom || kodeSekolah });
            } else {
                stage.classList.add('hidden');
                mainCam.classList.remove('opacity-0');
                miniCam.classList.add('hidden');
                label.innerText = "Wajah Guru";
                socket.emit('change-view-mode', { mode: 'teacher', room: currentRoom || kodeSekolah });
            }
        }

        function muteAllStudents() {
            socket.emit('mute-all-request', { room: currentRoom || kodeSekolah });
            showAlert("Semua audio murid dimatikan!", "üîá");
        }

        socket.on('join-live', (data) => {
            const grid = document.getElementById('students-live-grid');
            const tile = document.createElement('div');
            tile.className = "student-tile shadow-lg animate-pop";
            tile.innerHTML = `<div class="absolute bottom-1 left-1 bg-black/50 text-[8px] text-white px-2 py-0.5 rounded">${data.name}</div>`;
            grid.appendChild(tile);
        });

        socket.on('update-score-guru', (data) => {
            const existing = allScores.findIndex(s => s.name === data.name);
            if(existing > -1) allScores[existing] = data;
            else allScores.push(data);
            renderScoreboard();
            showAlert(`Nilai baru dari ${data.name}!`, 'üìä');
        });

        function renderScoreboard() {
            const tbody = document.getElementById('live-score-body');
            const empty = document.getElementById('empty-score-row');
            if(empty) empty.remove();
            allScores.sort((a, b) => b.score - a.score);
            tbody.innerHTML = '';
            allScores.forEach((s, i) => {
                const isTop = i === 0;
                tbody.innerHTML += `
                    <tr class="border-t border-white/5 hover:bg-white/5 transition-all animate-pop">
                        <td class="p-4 font-black ${isTop ? 'text-amber-400' : 'text-slate-500'} text-lg">${isTop ? 'üëë 1' : i+1}</td>
                        <td class="p-4 font-bold text-white">${s.name}</td>
                        <td class="p-4"><span class="px-3 py-1 rounded-lg bg-indigo-500/20 text-indigo-400 font-mono font-bold">${s.score}</span></td>
                        <td class="p-4 text-slate-400 italic text-[10px] max-w-xs truncate">${s.feedback || 'Selesai'}</td>
                        <td class="p-4"><div class="w-2 h-2 bg-emerald-500 rounded-full inline-block animate-pulse"></div></td>
                        <td class="p-4 text-right">
                             <button onclick="bukaKoreksi('${s.name}', ${s.score})" class="bg-amber-500/20 text-amber-400 border border-amber-500/30 px-3 py-1 rounded-xl text-[9px] font-black hover:bg-amber-500 hover:text-white transition-all">üìù KOREKSI</button>
                        </td>
                    </tr>`;
            });
        }

        function exportFullData(tipe) {
            if(allScores.length === 0) return showAlert("Belum ada data nilai!", "‚ö†Ô∏è");
            const header = [["Rank", "Nama Murid", "Skor", "Feedback AI", "Waktu"]];
            const body = allScores.map((s, i) => [i + 1, s.name, s.score, s.feedback, new Date().toLocaleString()]);
            if (tipe === 'excel') {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([[`REKAP NILAI: ${lastGeneratedData?.judul || 'Live Class'}`], [], ...header, ...body]);
                XLSX.utils.book_append_sheet(wb, ws, "Nilai");
                XLSX.writeFile(wb, `Rekap_Nilai_${new Date().getTime()}.xlsx`);
            } else {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                doc.text(`REKAP NILAI - ${instansi}`, 14, 15);
                doc.autoTable({ head: header, body: body, startY: 25 });
                doc.save(`Rekap_Nilai_${new Date().getTime()}.pdf`);
            }
            showAlert(`Export ${tipe.toUpperCase()} berhasil!`, '‚úÖ');
        }

        socket.on('update-absen', (daftarMurid) => {
            currentAbsen = daftarMurid;
            const list = document.getElementById('list-absen');
            const count = document.getElementById('count-absen');
            count.innerText = daftarMurid.length;
            list.innerHTML = "";
            if (daftarMurid.length === 0) { list.innerHTML = '<li class="italic text-slate-600 font-normal">Menunggu kelas...</li>'; return; }
            daftarMurid.forEach(nama => { list.innerHTML += `<li class="flex items-center gap-2 text-white/80 animate-pop"><div class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div>${nama}</li>`; });
        });

        function exportLaporan(tipe) {
            if(currentAbsen.length === 0) return showAlert("Belum ada data murid!", "‚ö†Ô∏è");
            const timestamp = new Date().toLocaleString('id-ID');
            const dataHeader = [["No", "Nama Siswa", "Waktu Absen"]];
            const dataBody = currentAbsen.map((nama, i) => [i + 1, nama, timestamp]);
            if (tipe === 'excel') {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([[`LAPORAN ABSENSI - ${instansi}`], [`Kelas: ${document.getElementById('select-kelas').value || 'Umum'}`], [], ...dataHeader, ...dataBody]);
                XLSX.utils.book_append_sheet(wb, ws, "Absensi");
                XLSX.writeFile(wb, `Absensi_${new Date().getTime()}.xlsx`);
            } else if (tipe === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text(`LAPORAN ABSENSI - ${instansi}`, 14, 15);
                doc.autoTable({ head: dataHeader, body: dataBody, startY: 30 });
                doc.save(`Absensi_${new Date().getTime()}.pdf`);
            } else if (tipe === 'word') {
                let content = `LAPORAN ABSENSI - ${instansi}\n\n`;
                currentAbsen.forEach((n, i) => content += `${i+1}. ${n}\n`);
                const blob = new Blob([content], {type: 'application/msword'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Absensi_${new Date().getTime()}.doc`;
                link.click();
            }
            showAlert(`Laporan ${tipe.toUpperCase()} berhasil diunduh!`, 'üìÑ');
        }

        socket.emit('join-room', kodeSekolah);

        async function loadKelas() {
            try {
                const res = await fetch(`/api/kelas/${kodeSekolah}`);
                const data = await res.json();
                const select = document.getElementById('select-kelas');
                select.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                data.forEach(k => { select.innerHTML += `<option value="${k.nama_kelas}">${k.nama_kelas}</option>`; });
            } catch (e) { console.error("Gagal muat kelas"); }
        }

        async function tambahKelas() {
            const nama = prompt("Masukkan Nama Kelas:");
            if(nama) {
                await fetch('/api/kelas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ kode_sekolah: kodeSekolah, nama_kelas: nama })
                });
                loadKelas();
                showAlert(`Kelas ${nama} Berhasil Dibuat!`, 'üè´');
            }
        }

        function pindahKelas() {
            const kelasSelected = document.getElementById('select-kelas').value;
            const newRoom = kelasSelected ? `${kodeSekolah}-${kelasSelected}` : kodeSekolah;
            socket.emit('switch-room', { oldRoom: currentRoom || kodeSekolah, newRoom: newRoom });
            currentRoom = newRoom;
            document.getElementById('chat-box').innerHTML = '';
            showAlert(`Masuk ke Kelas: ${kelasSelected || 'Umum'}`, 'üì°');
        }

        async function generate() {
            const btn = document.getElementById('btnGen');
            const btnText = document.getElementById('btnText');
            const promptValue = document.getElementById('prompt').value;
            if(!promptValue) return showAlert('Harap isi instruksi dulu!', '‚ö†Ô∏è');
            btn.disabled = true; btnText.innerText = "MERACIK...";
            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ instruksi: promptValue })
                });
                const data = await res.json();
                lastGeneratedData = data; 
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('preview-area').classList.remove('hidden');
                document.getElementById('res-judul').innerText = data.judul;
                document.getElementById('res-html').innerHTML = data.html;
                document.getElementById('active-quiz-title').innerText = "Kuis Aktif: " + data.judul;
                showAlert('Materi Selesai!', '‚úÖ');
            } catch (e) { showAlert('Gagal AI.', '‚ùå'); } finally {
                btn.disabled = false; btnText.innerText = "PRODUKSI SEKARANG";
            }
        }

        function publishToStudents() {
            if(!lastGeneratedData) return;
            socket.emit('new-materi', { ...lastGeneratedData, room: currentRoom || kodeSekolah });
            showAlert('Materi Terkirim!', 'üöÄ');
        }

        function publishQuiz() {
            if(!lastGeneratedData) return;
            socket.emit('start-quiz', { room: currentRoom || kodeSekolah, judul: lastGeneratedData.judul, soal: lastGeneratedData.soal });
            showAlert('Kuis Dimulai!', 'üéØ');
        }

        function toggleChat() { document.getElementById('chat-panel').classList.toggle('hidden'); }

        function sendChat() {
            const input = document.getElementById('chat-input');
            if(input.value.trim()) {
                socket.emit('chat-message', { user: namaGuru, msg: input.value, room: currentRoom || kodeSekolah, role: 'Guru' });
                input.value = '';
            }
        }

        socket.on('chat-message', (data) => {
            const chatBox = document.getElementById('chat-box');
            const isMe = data.user === namaGuru;
            chatBox.innerHTML += `<div class="${isMe ? 'text-right' : 'text-left'} mb-2"><span class="font-black text-[9px] block text-slate-400 uppercase">${data.user}</span><div class="inline-block p-2 rounded-2xl ${isMe ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-700'} mt-1">${data.msg}</div></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        function showAlert(msg, icon = '‚ú®') {
            const alert = document.getElementById('customAlert');
            document.getElementById('alertMsg').innerText = msg;
            document.getElementById('alertIcon').innerText = icon;
            alert.classList.add('alert-show');
            setTimeout(() => alert.classList.remove('alert-show'), 3000);
        }

        async function bukaKoreksi(namaSiswa, skorLama) {
            const judulMateri = lastGeneratedData ? lastGeneratedData.judul : "Live Quiz";
            const skorBaru = prompt(`Koreksi nilai untuk: ${namaSiswa}\nSkor AI saat ini: ${skorLama}\n\nMasukkan nilai baru (0-100):`, skorLama);
            
            if (skorBaru !== null && skorBaru !== "" && !isNaN(skorBaru)) {
                try {
                    const response = await fetch('/api/koreksi-nilai', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nama_siswa: namaSiswa, materi: judulMateri, skor_baru: parseInt(skorBaru), kode_sekolah: kodeSekolah })
                    });
                    const hasil = await response.json();
                    if (hasil.success) {
                        showAlert(`Nilai ${namaSiswa} berhasil diupdate!`, '‚úÖ');
                        const idx = allScores.findIndex(s => s.name === namaSiswa);
                        if(idx > -1) { allScores[idx].score = parseInt(skorBaru); renderScoreboard(); }
                        // Jika riwayat sedang terbuka, refresh juga
                        muatRiwayat();
                    } else { showAlert("Gagal simpan ke database.", "‚ùå"); }
                } catch (err) { showAlert("Masalah koneksi server.", "‚ùå"); }
            }
        }

        socket.on('score-updated-live', (data) => {
            const idx = allScores.findIndex(s => s.name === data.nama_siswa);
            if(idx > -1) { allScores[idx].score = data.skor; renderScoreboard(); showAlert(`Skor ${data.nama_siswa} dikoreksi Guru!`, '‚úèÔ∏è'); }
        });

        // ============================================
        // LOGIKA BARU: RIWAYAT & ANALITIK (DATABASE)
        // ============================================
        async function muatRiwayat() {
            const body = document.getElementById('history-body');
            const avgEl = document.getElementById('avg-score');
            const passEl = document.getElementById('pass-count');
            const quizCountEl = document.getElementById('quiz-count');
            
            body.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-slate-400 italic">Sedang memuat data dari database...</td></tr>';

            try {
                // Memanggil endpoint backend yang tersambung PostgreSQL
                const res = await fetch(`/api/riwayat-nilai/${kodeSekolah}`);
                const data = await res.json();

                if(!data || data.length === 0) {
                    body.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-slate-400 italic">Belum ada riwayat tersimpan di database.</td></tr>';
                    avgEl.innerText = "-"; passEl.innerText = "-"; quizCountEl.innerText = "-";
                    return;
                }

                let totalSkor = 0;
                let lulus = 0;
                const materiUnik = new Set();

                body.innerHTML = '';
                data.forEach(item => {
                    totalSkor += item.skor;
                    if(item.skor >= 75) lulus++;
                    materiUnik.add(item.materi);

                    const tgl = new Date(item.created_at).toLocaleDateString('id-ID', {day:'2-digit', month:'short'});
                    const barColor = item.skor >= 75 ? 'bg-emerald-500' : 'bg-amber-500';

                    body.innerHTML += `
                        <tr class="hover:bg-slate-50/50 transition-all group">
                            <td class="p-6">
                                <div class="font-black text-slate-800">${item.materi}</div>
                                <div class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter">${tgl}</div>
                            </td>
                            <td class="p-6 font-bold text-slate-700">${item.nama_siswa}</td>
                            <td class="p-6 w-48">
                                <div class="flex items-center gap-3">
                                    <div class="flex-1 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                        <div class="${barColor} h-full" style="width: ${item.skor}%"></div>
                                    </div>
                                    <span class="text-[9px] font-black text-slate-400">${item.skor}%</span>
                                </div>
                            </td>
                            <td class="p-6">
                                <span class="px-3 py-1 rounded-full ${item.skor >= 75 ? 'bg-emerald-50 text-emerald-600' : 'bg-amber-50 text-amber-600'} font-black text-xs">
                                    ${item.skor}
                                </span>
                            </td>
                            <td class="p-6 text-right">
                                <span class="text-[9px] font-bold text-slate-300 uppercase">TERSIMPAN</span>
                            </td>
                        </tr>`;
                });

                // Update Angka Analitik
                avgEl.innerText = Math.round(totalSkor / data.length);
                passEl.innerText = lulus;
                quizCountEl.innerText = materiUnik.size;
                showAlert("Data Riwayat Terkini!", "üìä");

            } catch (err) {
                console.error(err);
                body.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-red-400 italic">Gagal terhubung ke database. Pastikan backend server aktif.</td></tr>';
            }
        }

        window.onload = () => { 
            initLiveCameras(); 
            loadKelas();
            muatRiwayat(); // Memuat riwayat otomatis saat halaman dibuka
        };
    </script>
</body>
</html>
