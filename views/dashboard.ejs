<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Teacher Studio - Live Command</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0f172a; color: white; overflow: hidden; height: 100vh; }
        
        /* Layout Utama Zoom-like */
        .app-container { display: flex; height: 100vh; width: 100vw; }
        .main-stage { flex: 1; position: relative; display: flex; flex-direction: column; background: #000; justify-content: center; align-items: center; }
        .sidebar-panel { width: 350px; background: #1e293b; border-left: 1px solid #334155; display: flex; flex-direction: column; transition: transform 0.3s ease; }
        
        /* Mobile Responsiveness */
        @media (max-width: 1024px) {
            .sidebar-panel { position: absolute; right: 0; top: 0; bottom: 0; z-index: 50; transform: translateX(100%); width: 100%; max-width: 400px; }
            .sidebar-active { transform: translateX(0); }
        }

        /* Video Area */
        #video-container { width: 100%; height: 100%; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #guru-live-cam { height: 100%; width: 100%; object-fit: contain; transform: scaleX(-1); } /* Mirror effect like Zoom */
        
        /* Control Bar (Zoom Style) */
        .control-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px);
            padding: 10px 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; gap: 15px; z-index: 40; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .ctrl-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 60px; height: 60px; border-radius: 12px; color: #94a3b8;
            transition: all 0.2s; cursor: pointer; font-size: 10px; font-weight: 600; gap: 4px;
        }
        .ctrl-btn:hover { background: rgba(255,255,255,0.1); color: white; transform: translateY(-3px); }
        .ctrl-btn.active { color: #818cf8; background: rgba(99, 102, 241, 0.1); }
        .ctrl-btn.danger { color: #f43f5e; }
        .ctrl-btn.danger:hover { background: #f43f5e; color: white; }
        .ctrl-btn i { font-size: 20px; }

        /* Tabs di Sidebar */
        .tab-group { display: flex; padding: 10px; gap: 5px; background: #0f172a; }
        .tab-btn { flex: 1; padding: 10px; font-size: 11px; font-weight: bold; text-align: center; border-radius: 8px; color: #64748b; cursor: pointer; transition: 0.2s; text-transform: uppercase; tracking: wider; }
        .tab-btn.active { background: #334155; color: white; }

        /* Content Areas */
        .panel-content { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .panel-content.active { display: block; }

        /* Chat Styling */
        .chat-bubble { padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.4; max-width: 85%; margin-bottom: 10px; word-wrap: break-word; }
        .chat-in { background: #334155; color: white; align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-out { background: #4f46e5; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }

        /* Animations */
        .live-badge { position: absolute; top: 20px; left: 20px; background: rgba(220, 38, 38, 0.9); padding: 5px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; display: flex; align-items: center; gap: 6px; z-index: 20; }
        .blink-dot { width: 8px; height: 8px; background: white; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* Modal & Overlays */
        #presentation-stage { position: absolute; inset: 0; background: white; color: #1e293b; z-index: 10; padding: 40px; overflow-y: auto; display: none; }
        .modal-overlay { background: rgba(0,0,0,0.8); position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-active { display: flex !important; }

        /* Student Tiles (Small) */
        .student-grid-mini { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .student-tile { aspect-ratio: 16/9; background: #000; border-radius: 8px; overflow: hidden; position: relative; border: 1px solid #334155; }
    </style>
</head>
<body>

    <div class="app-container">
        <main class="main-stage">
            <div class="live-badge">
                <div class="blink-dot"></div>
                <span>LIVE ‚Ä¢ <span id="current-room-label">Umum</span></span>
            </div>

            <div id="video-container">
                <video id="guru-live-cam" autoplay playsinline muted></video>
                <img id="fokus-murid-view" class="hidden w-full h-full object-contain bg-black z-20 absolute inset-0">
                
                <div id="presentation-stage" class="prose max-w-none">
                    <button onclick="switchDisplayMode()" class="fixed top-5 right-5 bg-red-500 text-white px-4 py-2 rounded-full font-bold shadow-lg hover:bg-red-600 transition z-50">
                        <i class="fa-solid fa-xmark"></i> Tutup Materi
                    </button>
                    <h1 id="slide-judul" class="text-4xl font-black text-indigo-600 mb-6 border-b pb-4"></h1>
                    <div id="slide-konten" class="text-xl text-slate-700 leading-relaxed"></div>
                </div>
            </div>

            <div class="control-bar">
                <div class="ctrl-btn" onclick="toggleMute()" id="btn-mic">
                    <i class="fa-solid fa-microphone"></i>
                    <span>Mute</span>
                </div>
                <div class="ctrl-btn" onclick="toggleVideo()" id="btn-cam">
                    <i class="fa-solid fa-video"></i>
                    <span>Stop Cam</span>
                </div>
                
                <div class="w-px h-10 bg-slate-700 mx-2"></div>

                <div class="ctrl-btn" onclick="togglePanel('ai')">
                    <i class="fa-solid fa-wand-magic-sparkles text-indigo-400"></i>
                    <span>Materi AI</span>
                </div>
                <div class="ctrl-btn" onclick="togglePanel('participants')">
                    <i class="fa-solid fa-users"></i>
                    <span>Siswa <span id="count-absen-badge" class="bg-indigo-600 px-1.5 rounded-full text-[9px]">0</span></span>
                </div>
                <div class="ctrl-btn" onclick="togglePanel('chat')">
                    <i class="fa-solid fa-message"></i>
                    <span>Chat</span>
                </div>
                
                <div class="w-px h-10 bg-slate-700 mx-2"></div>

                <div class="ctrl-btn" onclick="toggleCleanFullScreen()">
                    <i class="fa-solid fa-expand"></i>
                    <span>Full</span>
                </div>
                <div class="ctrl-btn danger" onclick="muteAllStudents()">
                    <i class="fa-solid fa-volume-xmark"></i>
                    <span>Mute All</span>
                </div>
            </div>
        </main>

        <aside id="right-sidebar" class="sidebar-panel">
            <div class="tab-group">
                <div class="tab-btn active" onclick="switchTab('ai', this)">‚ú® AI Tools</div>
                <div class="tab-btn" onclick="switchTab('participants', this)">üë• Absen</div>
                <div class="tab-btn" onclick="switchTab('chat', this)">üí¨ Chat</div>
            </div>

            <div id="panel-ai" class="panel-content active">
                <div class="mb-6">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">Pilih Kelas</label>
                    <div class="flex gap-2">
                        <select id="select-kelas" onchange="pindahKelas()" class="w-full bg-slate-800 text-sm p-3 rounded-xl outline-none border border-slate-700 focus:border-indigo-500"></select>
                        <button onclick="tambahKelas()" class="bg-indigo-600 w-12 rounded-xl text-white hover:bg-indigo-500">+</button>
                    </div>
                </div>

                <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 mb-6">
                    <label class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-3 block">Generator Materi</label>
                    <textarea id="prompt" class="w-full h-24 bg-slate-900 border border-slate-700 rounded-xl p-3 text-xs mb-3 focus:border-indigo-500 outline-none resize-none" placeholder="Topik: Sejarah Kemerdekaan..."></textarea>
                    <button id="btnGen" onclick="generate()" class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl font-bold text-xs uppercase hover:opacity-90 transition">Buat Materi & Soal</button>
                </div>

                <div id="preview-actions" class="hidden space-y-3">
                    <div class="p-3 bg-green-900/20 border border-green-500/30 rounded-xl">
                        <p class="text-[10px] text-green-400 font-bold mb-1">Materi Siap!</p>
                        <h4 id="mini-judul" class="font-bold text-sm truncate">...</h4>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="publishToStudents()" class="py-3 bg-slate-700 rounded-xl text-[10px] font-bold uppercase hover:bg-slate-600">üì° Siarkan Materi</button>
                        <button onclick="mulaiKuisAI()" class="py-3 bg-amber-600 rounded-xl text-[10px] font-bold uppercase hover:bg-amber-500">üöÄ Mulai Kuis</button>
                    </div>
                    <button onclick="switchDisplayMode()" class="w-full py-3 bg-indigo-600/30 border border-indigo-500 text-indigo-300 rounded-xl text-[10px] font-bold uppercase hover:bg-indigo-600 hover:text-white transition">üì∫ Tampilkan di Layar Utama</button>
                </div>

                <div class="mt-8 pt-6 border-t border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xs font-black uppercase text-slate-400">Live Score</span>
                        <div class="flex gap-1">
                            <button onclick="exportLaporan('excel')" class="text-[9px] bg-slate-800 px-2 py-1 rounded">XLS</button>
                        </div>
                    </div>
                    <div class="space-y-2" id="live-score-body">
                        <div class="text-center text-[10px] text-slate-600 italic py-4">Belum ada nilai masuk</div>
                    </div>
                </div>
            </div>

            <div id="panel-participants" class="panel-content">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xs font-bold text-slate-400">DAFTAR SISWA</span>
                    <button onclick="exportAbsensi('pdf')" class="text-[9px] text-indigo-400 hover:underline">Download PDF</button>
                </div>
                <ul id="list-absen" class="space-y-2 mb-6">
                    <li class="text-center text-[10px] text-slate-600 italic">Menunggu siswa...</li>
                </ul>
                
                <div class="border-t border-slate-700 pt-4 mt-4">
                    <span class="text-xs font-bold text-slate-400 block mb-3">VIDEO FEED SISWA</span>
                    <div id="students-live-grid" class="student-grid-mini"></div>
                </div>
            </div>

            <div id="panel-chat" class="panel-content flex flex-col h-full !p-0">
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-900/50">
                    <div class="text-center text-[10px] text-slate-600 my-4">-- Awal Percakapan --</div>
                </div>
                <div class="p-3 bg-slate-800 border-t border-slate-700">
                    <form onsubmit="kirimChat(event)" class="flex gap-2">
                        <input type="text" id="chat-input" class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-xs focus:border-indigo-500 outline-none" placeholder="Tulis pesan..." autocomplete="off">
                        <button type="submit" class="bg-indigo-600 text-white w-10 rounded-lg flex items-center justify-center hover:bg-indigo-500">
                            <i class="fa-solid fa-paper-plane text-xs"></i>
                        </button>
                    </form>
                </div>
            </div>
        </aside>
    </div>

    <div id="modal-koreksi" class="modal-overlay">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 text-slate-800 shadow-2xl animate-[slideIn_0.3s_ease-out]">
            <h3 class="text-xl font-black mb-1">Koreksi Nilai</h3>
            <p id="koreksi-nama" class="text-indigo-600 text-sm font-bold mb-6 uppercase"></p>
            
            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Skor Baru</label>
            <input type="number" id="input-skor-baru" class="w-full bg-slate-100 border p-3 rounded-xl font-bold text-lg mb-4 outline-none focus:border-indigo-500">
            
            <label class="block text-xs font-bold uppercase text-slate-400 mb-1">Feedback Guru</label>
            <textarea id="input-catatan-baru" class="w-full bg-slate-100 border p-3 rounded-xl text-sm h-24 resize-none outline-none focus:border-indigo-500 mb-6"></textarea>
            
            <div class="flex gap-3">
                <button onclick="tutupKoreksi()" class="flex-1 py-3 text-slate-500 font-bold text-sm hover:bg-slate-100 rounded-xl">Batal</button>
                <button onclick="simpanKoreksi()" class="flex-1 py-3 bg-indigo-600 text-white font-bold text-sm rounded-xl hover:bg-indigo-700 shadow-lg">Simpan Perubahan</button>
            </div>
        </div>
    </div>

    <div id="customAlert" class="fixed top-5 left-1/2 -translate-x-1/2 z-[2000] bg-slate-800 text-white px-6 py-3 rounded-full border border-slate-600 shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 pointer-events-none translate-y-[-20px]">
        <div id="alertIcon" class="text-lg">üí°</div>
        <div id="alertMsg" class="text-sm font-bold">Alert message</div>
    </div>

    <script>
        const socket = io();
        const namaGuru = "<%= nama_guru %>";
        const kodeSekolah = "<%= kode %>";
        
        let currentRoom = kodeSekolah;
        let lastGeneratedData = null;
        let allScores = [];
        let isPresentationMode = false;
        let isMuted = false;
        let isCamOff = false;

        // --- 1. LOGIKA UTAMA & SOCKET ---

        socket.on('connect', () => {
            socket.emit('join-room', { room: currentRoom, nama: namaGuru, role: 'Guru' });
            loadKelas();
        });

        // Chat Listener (Dua Arah)
        socket.on('chat-message', (data) => {
            const container = document.getElementById('chat-container');
            const isMe = data.user === namaGuru;
            const align = isMe ? 'chat-out' : 'chat-in';
            const meta = isMe ? 'Anda' : data.user;
            
            // Auto open panel chat jika ada pesan baru dari siswa dan panel sedang tertutup
            if (!isMe && !document.getElementById('panel-chat').classList.contains('active')) {
                const badge = document.querySelector('.ctrl-btn .fa-message');
                badge.classList.add('text-yellow-400', 'animate-pulse');
            }

            container.innerHTML += `
                <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} animate-[fadeIn_0.3s]">
                    <span class="text-[9px] text-slate-500 mb-1 ml-1">${meta}</span>
                    <div class="chat-bubble ${align}">${data.msg}</div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
        });

        function kirimChat(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;
            
            socket.emit('chat-message', {
                room: currentRoom,
                user: namaGuru,
                msg: msg,
                role: 'Guru'
            });
            input.value = '';
        }

        // Live Score Listener
        socket.on('score-updated-live', (data) => {
            // Update Data
            const ex = allScores.findIndex(s => s.name === data.nama_siswa);
            if(ex > -1) { allScores[ex] = { ...allScores[ex], ...data }; } 
            else { allScores.push({ name: data.nama_siswa, score: data.skor, feedback: data.umpan_balik }); }

            renderScoreboardMini();
            showAlert(`${data.nama_siswa} selesai mengerjakan! Skor: ${data.skor}`, "‚úÖ");
        });

        function renderScoreboardMini() {
            const container = document.getElementById('live-score-body');
            allScores.sort((a,b) => b.score - a.score);
            
            container.innerHTML = allScores.map((s, i) => `
                <div class="bg-slate-700/50 p-2 rounded-lg flex items-center justify-between border border-slate-600 hover:border-indigo-500 transition cursor-pointer" onclick="bukaKoreksi('${s.name}', ${s.score}, '${s.feedback}')">
                    <div class="flex items-center gap-3">
                        <span class="font-black text-slate-500 text-xs w-4">#${i+1}</span>
                        <div>
                            <div class="text-xs font-bold text-white">${s.name}</div>
                            <div class="text-[9px] text-slate-400 truncate w-24">${s.feedback || '...'}</div>
                        </div>
                    </div>
                    <span class="bg-indigo-600 text-white text-[10px] font-bold px-2 py-1 rounded">${s.score}</span>
                </div>
            `).join('');
        }

        // --- 2. LOGIKA KUIS AI (CRITICAL FIX) ---
        
        async function generate() {
            const btn = document.getElementById('btnGen');
            const promptVal = document.getElementById('prompt').value;
            if(!promptVal) return showAlert("Isi topik materi dulu!", "‚ö†Ô∏è");

            btn.innerText = "‚è≥ Sedang Berpikir..."; btn.disabled = true;
            try {
                const res = await fetch('/api/generate', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ instruksi: promptVal }) 
                });
                lastGeneratedData = await res.json();
                
                // Update UI Sidebar
                document.getElementById('preview-actions').classList.remove('hidden');
                document.getElementById('mini-judul').innerText = lastGeneratedData.judul;
                
                // Update UI Presentasi (Hidden first)
                document.getElementById('slide-judul').innerText = lastGeneratedData.judul;
                document.getElementById('slide-konten').innerHTML = lastGeneratedData.html;
                
                showAlert("Materi berhasil dibuat!", "‚ú®");
            } catch (e) { showAlert("Gagal membuat materi", "‚ùå"); }
            btn.innerText = "BUAT MATERI & SOAL"; btn.disabled = false;
        }

        function mulaiKuisAI() {
            if (!lastGeneratedData) return showAlert("Buat materi dulu!", "‚ö†Ô∏è");

            // CRITICAL FIX: Kirim paket lengkap (termasuk kunci) ke server
            // Server akan menyimpan kunci di memori, lalu memfilter kunci sebelum kirim ke murid
            socket.emit('start-quiz', { 
                room: currentRoom, 
                fullData: lastGeneratedData 
            });

            // Reset Skor UI
            allScores = []; 
            renderScoreboardMini();
            showAlert("Kuis dikirim ke Siswa! AI siap menilai.", "üöÄ");
        }

        function publishToStudents() {
            if (!lastGeneratedData) return;
            socket.emit('new-materi', { ...lastGeneratedData, room: currentRoom });
            showAlert("Materi dikirim ke layar siswa", "üì°");
        }

        // --- 3. UI & MEDIA CONTROL ---

        function togglePanel(panelName) {
            // Sidebar Logic
            const sidebar = document.getElementById('right-sidebar');
            const panels = document.querySelectorAll('.panel-content');
            const tabs = document.querySelectorAll('.tab-btn');
            const isMobile = window.innerWidth <= 1024;

            // Reset active tabs
            panels.forEach(p => p.classList.remove('active'));
            tabs.forEach(t => t.classList.remove('active'));

            if (panelName === 'active-current') {
                // Just toggle visibility sidebar on mobile
                 sidebar.classList.toggle('sidebar-active');
                 return;
            }

            // Set content
            document.getElementById(`panel-${panelName}`).classList.add('active');
            // Set Tab Style (Manual lookup based on order is lazy, better via ID but let's select by text/logic)
            // Simple approach: activate corresponding tab
            const tabMap = { 'ai': 0, 'participants': 1, 'chat': 2 };
            if(tabs[tabMap[panelName]]) tabs[tabMap[panelName]].classList.add('active');

            // Open Sidebar
            sidebar.classList.add('sidebar-active');
        }

        function switchTab(panelName, btn) {
            const panels = document.querySelectorAll('.panel-content');
            const tabs = document.querySelectorAll('.tab-btn');
            
            panels.forEach(p => p.classList.remove('active'));
            tabs.forEach(t => t.classList.remove('active'));
            
            document.getElementById(`panel-${panelName}`).classList.add('active');
            btn.classList.add('active');
        }

        function switchDisplayMode() {
            if(!lastGeneratedData) return showAlert("Belum ada materi!", "‚ö†Ô∏è");
            isPresentationMode = !isPresentationMode;
            
            const stage = document.getElementById('presentation-stage');
            const video = document.getElementById('guru-live-cam');
            
            if(isPresentationMode) {
                stage.style.display = 'block';
                video.style.opacity = '0.1'; // Dim video
            } else {
                stage.style.display = 'none';
                video.style.opacity = '1';
            }
        }

        async function initCameras() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('guru-live-cam').srcObject = stream;
                
                // Stream ke socket (Low FPS for performance)
                const canvas = document.createElement('canvas'); 
                const ctx = canvas.getContext('2d');
                canvas.width = 480; canvas.height = 360;
                
                setInterval(() => {
                    if(!isCamOff) {
                        ctx.drawImage(document.getElementById('guru-live-cam'), 0, 0, canvas.width, canvas.height);
                        socket.emit('update-frame', { room: currentRoom, image: canvas.toDataURL('image/jpeg', 0.5) });
                    }
                }, 200);
            } catch (e) { showAlert("Kamera tidak terdeteksi", "‚ùå"); }
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('btn-mic');
            const track = document.getElementById('guru-live-cam').srcObject.getAudioTracks()[0];
            if(track) track.enabled = !isMuted;
            
            if(isMuted) { btn.classList.add('danger'); btn.querySelector('span').innerText = "Unmute"; btn.querySelector('i').className = "fa-solid fa-microphone-slash"; }
            else { btn.classList.remove('danger'); btn.querySelector('span').innerText = "Mute"; btn.querySelector('i').className = "fa-solid fa-microphone"; }
        }

        function toggleVideo() {
            isCamOff = !isCamOff;
            const btn = document.getElementById('btn-cam');
            const track = document.getElementById('guru-live-cam').srcObject.getVideoTracks()[0];
            if(track) track.enabled = !isCamOff;

            if(isCamOff) { btn.classList.add('danger'); btn.querySelector('span').innerText = "Start Cam"; btn.querySelector('i').className = "fa-solid fa-video-slash"; }
            else { btn.classList.remove('danger'); btn.querySelector('span').innerText = "Stop Cam"; btn.querySelector('i').className = "fa-solid fa-video"; }
        }

        // --- 4. DATA & HELPERS ---

        async function loadKelas() {
            const res = await fetch(`/api/kelas/${kodeSekolah}`);
            const data = await res.json();
            const sel = document.getElementById('select-kelas');
            sel.innerHTML = '<option value="">UMUM (Semua)</option>';
            data.forEach(k => sel.innerHTML += `<option value="${k.nama_kelas}">${k.nama_kelas}</option>`);
        }

        function pindahKelas() {
            const k = document.getElementById('select-kelas').value;
            const newRoom = k ? `${kodeSekolah}-${k}` : kodeSekolah;
            
            // Emit switch logic
            socket.emit('switch-room', { oldRoom: currentRoom, newRoom: newRoom });
            currentRoom = newRoom;
            
            document.getElementById('current-room-label').innerText = k || "Umum";
            // Clear chats & scores when switching room
            document.getElementById('chat-container').innerHTML = '<div class="text-center text-[10px] text-slate-600 my-4">-- Room Baru --</div>';
            allScores = []; renderScoreboardMini();
            
            showAlert(`Pindah ke ${k || 'Umum'}`, "üì°");
        }

        async function tambahKelas() {
            const n = prompt("Nama Kelas Baru:");
            if(!n) return;
            await fetch('/api/kelas', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ kode_sekolah: kodeSekolah, nama_kelas: n }) });
            loadKelas();
        }

        socket.on('update-attendance', (listSiswa) => {
            document.getElementById('count-absen-badge').innerText = listSiswa.length;
            const listUI = document.getElementById('list-absen');
            listUI.innerHTML = listSiswa.length === 0 ? '<li class="text-center text-[10px] text-slate-600 italic">Menunggu siswa...</li>' : "";
            listSiswa.forEach(s => {
                listUI.innerHTML += `
                    <li class="flex items-center gap-2 bg-slate-800 p-2 rounded border border-slate-700">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-xs font-bold text-slate-300">${s.name || s}</span>
                    </li>`;
            });
        });
        
        // Video Murid Grid
        socket.on('join-live', (data) => {
            const grid = document.getElementById('students-live-grid');
            const safeId = data.name.replace(/\s+/g, '-');
            if (!document.getElementById(`tile-${safeId}`)) {
                const t = document.createElement('div');
                t.id = `tile-${safeId}`; t.className = "student-tile cursor-pointer border hover:border-indigo-500 transition";
                t.onclick = () => fokusKeMurid(data.image, data.name);
                t.innerHTML = `<img id="img-tile-${safeId}" class="w-full h-full object-cover opacity-80 hover:opacity-100">
                               <div class="absolute bottom-1 left-1 bg-black/60 text-[8px] px-2 rounded text-white">${data.name}</div>`;
                grid.appendChild(t);
            }
        });
        
        socket.on('receive-frame', (data) => {
            const img = document.getElementById(`img-tile-${data.name.replace(/\s+/g, '-')}`);
            if (img) img.src = data.image;
        });

        function fokusKeMurid(img, nama) {
            const view = document.getElementById('fokus-murid-view');
            if(view.classList.contains('hidden')) {
                view.src = img || '';
                view.classList.remove('hidden');
                showAlert(`Fokus: ${nama}`, "üëÄ");
            } else {
                view.classList.add('hidden');
            }
        }
        
        function resetFokusVideo() {
            document.getElementById('fokus-murid-view').classList.add('hidden');
        }

        function showAlert(msg, icon = 'üí°') {
            const a = document.getElementById('customAlert');
            document.getElementById('alertMsg').innerText = msg;
            document.getElementById('alertIcon').innerText = icon;
            a.style.opacity = '1'; a.style.transform = 'translate(-50%, 0)';
            setTimeout(() => { a.style.opacity = '0'; a.style.transform = 'translate(-50%, -20px)'; }, 3000);
        }

        function toggleCleanFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        function muteAllStudents() { socket.emit('mute-all', { room: currentRoom }); showAlert("Semua mic siswa dimatikan", "üîá"); }
        function exportAbsensi(t) { showAlert("Fitur export sedang diproses...", "print"); }
        function exportLaporan(t) { showAlert("Mendownload rekap nilai...", "print"); }
        
        // Modal Koreksi
        let targetMuridKoreksi = "";
        function bukaKoreksi(n, s, f) { 
            targetMuridKoreksi = n; 
            document.getElementById('koreksi-nama').innerText = n; 
            document.getElementById('input-skor-baru').value = s; 
            document.getElementById('input-catatan-baru').value = f; 
            document.getElementById('modal-koreksi').classList.add('modal-active'); 
        }
        function tutupKoreksi() { document.getElementById('modal-koreksi').classList.remove('modal-active'); }
        function simpanKoreksi() {
            tutupKoreksi(); showAlert("Nilai berhasil diperbarui!", "‚úÖ");
            // Logika simpan ke DB bisa ditambahkan di sini
        }

        window.onload = initCameras;
    </script>
</body>
</html>
