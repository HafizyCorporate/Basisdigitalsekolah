<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Student Space - Ramadan Ceria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- TEMA RAMADAN CERIA (KID FRIENDLY) --- */
        body { 
            font-family: 'Quicksand', sans-serif; 
            /* Ganti hitam kaku dengan gradasi Malam Berbintang */
            background: radial-gradient(circle at top, #1e1b4b, #0f172a, #020617);
            background-attachment: fixed;
            color: #e2e8f0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }

        /* Pattern Bintang Samar-samar di Background */
        body::before {
            content: "";
            position: absolute; inset: 0; z-index: -1;
            background-image: radial-gradient(white 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.1;
        }
        
        /* --- ANIMASI ORNAMEN --- */
        @keyframes sway {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .ornament { animation: sway 4s infinite ease-in-out; transform-origin: top center; }
        .floating { animation: float 3s infinite ease-in-out; }

        /* --- LAYOUT UTAMA --- */
        .main-layout {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 320px; 
            gap: 1rem;
            padding: 1rem;
            overflow: hidden; 
            position: relative;
            z-index: 10; /* Di atas background pattern */
        }

        /* --- RESPONSIF HP --- */
        @media (max-width: 1024px) {
            body { height: auto; overflow-y: auto; }
            .main-layout {
                display: flex;
                flex-direction: column;
                padding: 0.8rem;
                gap: 1rem;
                overflow: visible;
                height: auto;
            }
            #sidebar-col {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-bottom: 2rem;
            }
        }

        /* --- STAGE VIDEO (Frame Emas) --- */
        #main-stage { 
            position: relative; 
            background: #000; 
            border-radius: 1.5rem; 
            overflow: hidden; 
            border: 2px solid #475569; /* Default border */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            display: flex; flex-direction: column; justify-content: center;
            width: 100%;
            min-height: 250px;
        }

        @media (max-width: 1024px) {
            #main-stage { aspect-ratio: 16/9; flex-shrink: 0; }
        }
        
        #teacher-video-stream { width: 100%; height: 100%; object-fit: contain; background: #000; }
        
        /* PIP (Kamera Siswa) */
        #student-pip-wrapper {
            position: absolute; z-index: 20; background: #0f172a;
            border-radius: 1rem; overflow: hidden; 
            border: 3px solid #fbbf24; /* Border Emas Tebal */
            bottom: 5rem; right: 1rem; width: 140px; aspect-ratio: 4/3;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        @media (max-width: 768px) {
            #student-pip-wrapper { width: 100px; bottom: 4rem; right: 0.5rem; }
        }

        #video-element { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        /* CONTROLS */
        .video-controls {
            position: absolute; bottom: 0; left: 0; right: 0; padding: 1rem;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            display: flex; align-items: center; justify-content: space-between; gap: 1rem; z-index: 30;
        }

        .ctrl-btn {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; cursor: pointer;
            background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(5px); 
            border: 1px solid rgba(255,255,255,0.3);
            transition: transform 0.1s;
        }
        .ctrl-btn:active { transform: scale(0.9); }

        /* --- SIDEBAR STYLE --- */
        #sidebar-col { height: 100%; overflow: hidden; display: flex; flex-direction: column; gap: 10px; }
        @media (max-width: 1024px) { #sidebar-col { height: auto; overflow: visible; } }

        .glass-panel { 
            background: rgba(15, 23, 42, 0.8); /* Semi transparan */
            backdrop-filter: blur(10px);
            border-radius: 1.5rem; 
            border: 1px solid rgba(255,255,255,0.1); 
            overflow: hidden; 
            display: flex; flex-direction: column; 
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        
        .msg-status { font-size: 10px; margin-left: 6px; vertical-align: middle; }

    </style>
</head>
<body>

    <nav class="h-[70px] flex-none flex justify-between items-center px-4 md:px-6 bg-slate-900/80 border-b border-white/10 z-50 backdrop-blur-md sticky top-0">
        
        <div class="absolute top-0 left-10 hidden md:flex gap-4">
            <div class="flex flex-col items-center ornament" style="animation-delay: 0s;">
                <div class="h-8 w-0.5 bg-amber-400/50"></div>
                <i class="fa-solid fa-star text-amber-400 text-xl drop-shadow-[0_0_10px_rgba(251,191,36,0.8)]"></i>
            </div>
            <div class="flex flex-col items-center ornament" style="animation-delay: 1s;">
                <div class="h-12 w-0.5 bg-amber-400/50"></div>
                <i class="fa-solid fa-moon text-amber-200 text-2xl drop-shadow-[0_0_10px_rgba(251,191,36,0.8)]"></i>
            </div>
        </div>

        <div class="flex items-center gap-3 z-10 pl-0 md:pl-20"> <div class="relative group cursor-pointer">
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-emerald-500 to-teal-400 flex items-center justify-center text-white text-sm shadow-lg border-2 border-white/20">
                    <i class="fa-solid fa-user-astronaut"></i>
                </div>
                <div class="absolute -bottom-1 -right-1 bg-amber-400 text-amber-900 text-[10px] rounded-full w-4 h-4 flex items-center justify-center font-bold border border-white">‚ú®</div>
            </div>
            <div class="flex flex-col justify-center">
                <h1 class="font-bold text-white text-sm leading-tight">Halo, <%= nama_siswa.split(' ')[0] %>! üëã</h1>
                <p class="text-[10px] text-emerald-300 font-semibold bg-emerald-900/50 px-2 py-0.5 rounded-full inline-block mt-0.5 w-fit">Siap Belajar üöÄ</p>
            </div>
        </div>
        
        <div class="flex items-center gap-2 z-10">
            <div class="relative">
                <select id="select-kelas-murid" onchange="muridPindahKelas()" class="appearance-none bg-slate-800 border border-slate-600 text-white text-xs rounded-xl py-2 pl-3 pr-8 outline-none focus:border-amber-400 focus:ring-1 focus:ring-amber-400 transition-all cursor-pointer shadow-lg">
                    <option value="">-- Pilih Kelas --</option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-400 pointer-events-none"></i>
            </div>
            <div id="status-live-indicator" class="hidden px-3 py-1 bg-red-500 text-white rounded-full text-[10px] font-bold shadow-lg flex items-center gap-1.5 animate-pulse">
                <i class="fa-solid fa-circle text-[6px]"></i> LIVE
            </div>
        </div>
    </nav>

    <div id="cuteAlert" class="fixed -top-20 left-1/2 -translate-x-1/2 bg-gradient-to-r from-emerald-500 to-teal-600 text-white px-6 py-3 rounded-full font-bold text-sm shadow-[0_10px_20px_rgba(16,185,129,0.4)] z-[60] transition-all duration-300 flex items-center gap-3 border-2 border-white/20">
        <span id="cuteIcon" class="text-xl">üïå</span> <span id="cuteMsg">Info</span>
    </div>

    <div class="main-layout">
        
        <div id="main-stage">
            
            <div class="absolute top-4 left-4 z-10 flex items-center gap-3 bg-slate-900/60 backdrop-blur-md border border-amber-400/30 rounded-2xl p-2 pr-4 shadow-lg floating">
                <div class="w-10 h-10 bg-gradient-to-br from-amber-300 to-orange-400 rounded-full flex items-center justify-center shadow-inner">
                    <i class="fa-solid fa-mosque text-white text-lg drop-shadow-md"></i>
                </div>
                <div>
                    <p class="text-[9px] text-amber-300 font-bold uppercase tracking-wider mb-0.5">Ramadan Ceria</p>
                    <p class="text-xs text-white font-bold leading-none">Selamat Menunaikan<br>Ibadah Puasa ‚ú®</p>
                </div>
            </div>
            <img id="teacher-video-stream" src="" class="opacity-0 transition-opacity duration-500">
            
            <div id="video-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 bg-slate-950 z-0">
                <div class="relative mb-4">
                    <div class="w-20 h-20 rounded-full bg-slate-900 flex items-center justify-center border-2 border-slate-700 animate-pulse">
                        <i class="fa-solid fa-chalkboard-user text-3xl text-slate-600"></i>
                    </div>
                    <i class="fa-solid fa-star text-amber-400 absolute -top-1 -right-1 text-xl animate-bounce"></i>
                </div>
                <p class="font-bold text-sm">Menunggu Guru Hadir...</p>
                <p class="text-xs opacity-60 mt-1">Siapkan buku catatanmu ya! üìö</p>
            </div>
            
            <div id="student-pip-wrapper">
                <div id="cam-container" class="w-full h-full bg-slate-900 flex items-center justify-center">
                    <div class="flex flex-col items-center text-slate-500">
                        <i class="fa-solid fa-video-slash mb-1"></i>
                        <span class="text-[8px] font-bold uppercase">Kamera Mati</span>
                    </div>
                </div>
            </div>

            <div class="video-controls">
                <div class="flex gap-3">
                    <button id="btn-mic" onclick="toggleMic()" class="ctrl-btn text-white hover:bg-white/10" title="Mic"><i id="icon-mic" class="fa-solid fa-microphone-slash"></i></button>
                    <button id="btn-cam" onclick="toggleCamera()" class="ctrl-btn text-white hover:bg-white/10" title="Kamera"><i id="icon-cam" class="fa-solid fa-video-slash"></i></button>
                </div>
                <span id="my-status-text" class="text-[10px] bg-black/60 px-3 py-1.5 rounded-full text-white backdrop-blur-md border border-white/10 font-semibold shadow-sm">
                    <i class="fa-solid fa-pause mr-1 text-amber-400"></i> Siap Belajar
                </span>
                <button onclick="toggleFullscreen()" class="ctrl-btn text-white hover:bg-white/10" title="Layar Penuh"><i id="icon-fullscreen" class="fa-solid fa-expand"></i></button>
            </div>
        </div>

        <div id="sidebar-col">
            
            <div class="glass-panel flex-1 min-h-[400px] shadow-[0_0_20px_rgba(0,0,0,0.2)] relative group border-t-4 border-t-amber-400">
                <div class="p-4 bg-slate-900/50 border-b border-white/5 flex justify-between items-center">
                    <h3 class="font-bold text-white text-sm flex items-center gap-2">
                        <i class="fa-solid fa-file-pen text-amber-400"></i> Lembar Jawab
                    </h3>
                    <span id="quiz-timer" class="text-[10px] font-bold text-emerald-300 bg-emerald-900/30 px-2 py-1 rounded-lg border border-emerald-500/30">
                        <i class="fa-regular fa-clock mr-1"></i> Menunggu Soal
                    </span>
                </div>
                
                <div id="quiz-panel-content" class="flex-1 overflow-y-auto p-5 space-y-4">
                    <div class="flex flex-col items-center justify-center h-full text-slate-400 opacity-60">
                        <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-3">
                            <i class="fa-solid fa-book-open text-2xl text-slate-500"></i>
                        </div>
                        <p class="text-sm font-semibold">Belum ada kuis.</p>
                        <p class="text-xs">Soal dari guru akan muncul di sini.</p>
                    </div>
                </div>

                <div id="quiz-action-bar" class="hidden p-4 bg-slate-900/80 border-t border-white/5 backdrop-blur-sm">
                    <button onclick="finishQuiz()" class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-emerald-500/20 transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                        Kirim Jawaban <i class="fa-solid fa-paper-plane ml-2"></i>
                    </button>
                </div>
            </div>

            <div class="glass-panel h-[220px] flex-none"> 
                <div class="px-4 py-3 bg-slate-900/50 border-b border-white/5 flex justify-between items-center">
                    <span class="text-xs font-bold text-white uppercase tracking-wider flex items-center gap-2">
                        <i class="fa-regular fa-comments text-blue-400"></i> Obrolan Kelas
                    </span>
                    <div class="flex items-center gap-1.5">
                        <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                        </span>
                        <span class="text-[9px] text-emerald-400 font-bold">Online</span>
                    </div>
                </div>
                
                <div id="chat-box" class="flex-1 overflow-y-auto p-3 space-y-2 text-xs text-slate-200"></div>

                <div class="p-2 bg-slate-900/50 border-t border-white/5">
                    <div class="flex gap-2 relative">
                        <input id="chat-input" type="text" placeholder="Tulis pesan..." class="w-full bg-slate-800 border border-slate-600 text-white rounded-xl px-3 py-2 text-xs focus:border-blue-400 focus:ring-1 focus:ring-blue-400 outline-none placeholder-slate-500 transition-all pl-3">
                        <button onclick="sendChat()" class="bg-blue-600 hover:bg-blue-500 text-white w-9 rounded-xl flex items-center justify-center shadow-lg transition-all active:scale-95">
                            <i class="fa-solid fa-paper-plane text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <canvas id="hidden-canvas" class="hidden" width="240" height="180"></canvas>

    <script>
        const socket = io();
        const namaSiswa = "<%= typeof nama_siswa !== 'undefined' ? nama_siswa : 'Siswa' %>";
        const emailSiswa = "<%= typeof email_siswa !== 'undefined' ? email_siswa : 'email@test.com' %>"; 
        const kodeSekolah = "<%= typeof kode_sekolah !== 'undefined' ? kode_sekolah : 'SCH' %>";
        let kelasTersimpan = "<%= typeof kelas_siswa !== 'undefined' ? kelas_siswa : '' %>"; 
        
        let currentRoom = kodeSekolah;
        let myStream = null;
        let currentQuizData = null; 
        let isCameraOn = false;

        // --- 1. KONEKSI & ROOM ---
        async function initKelasMurid() {
            try {
                const select = document.getElementById('select-kelas-murid');
                const res = await fetch(`/api/kelas/${kodeSekolah}`);
                if(res.ok) {
                    const data = await res.json();
                    select.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                    data.forEach(k => {
                        const isSelected = (k.nama_kelas === kelasTersimpan) ? 'selected' : '';
                        select.innerHTML += `<option value="${k.nama_kelas}" ${isSelected}>${k.nama_kelas}</option>`;
                    });
                }
                if(kelasTersimpan) joinRoomSiswa(kelasTersimpan);
            } catch (e) { console.log("Mode Offline / UI Only"); }
        }

        function muridPindahKelas() {
            const kelasBaru = document.getElementById('select-kelas-murid').value;
            if(!kelasBaru) return;
            fetch('/api/update-kelas-siswa', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: emailSiswa, kelas: kelasBaru }) }).catch(()=>{});
            kelasTersimpan = kelasBaru;
            joinRoomSiswa(kelasBaru);
            showCuteAlert(`Masuk ke ${kelasBaru}`, 'üöÄ');
        }

        function joinRoomSiswa(namaKelas) {
            currentRoom = `${kodeSekolah}-${namaKelas}`;
            socket.emit('join-room', { room: currentRoom, nama: namaSiswa, role: 'Siswa' });
            if(isCameraOn) socket.emit('join-live', { room: currentRoom, nama: namaSiswa });
            document.getElementById('chat-box').innerHTML = '<div class="text-center text-[10px] text-slate-500 my-2 italic">Bergabung ke obrolan kelas...</div>';
        }

        window.onload = initKelasMurid;

        // --- 2. LOGIKA CHAT (OPTIMISTIC UI & PRIVACY) ---
        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;

            // 1. TAMPILKAN LANGSUNG (Optimistic UI)
            appendMessageToUI(namaSiswa, msg, true, 'Siswa');

            // 2. KIRIM KE SERVER
            if(socket.connected) {
                socket.emit('chat-message', { user: namaSiswa, msg: msg, room: currentRoom, role: 'Siswa' });
            } 
            
            input.value = '';
            input.focus();
        }

        // Fungsi Render Pesan
        function appendMessageToUI(user, msg, isMe, role) {
            const chatBox = document.getElementById('chat-box');
            
            const align = isMe ? 'justify-end' : 'justify-start';
            const bubbleColor = isMe 
                ? 'bg-blue-600 text-white rounded-tr-none shadow-blue-500/20' 
                : (role === 'Guru' ? 'bg-amber-500/20 text-amber-100 border border-amber-500/40' : 'bg-slate-700/50 text-slate-200'); // Guru beda warna
            
            // Label Nama
            let userLabel = '';
            if(!isMe) {
                if(role === 'Guru') userLabel = `<span class="text-[10px] font-bold text-amber-400 block mb-0.5 ml-1"><i class="fa-solid fa-chalkboard-user mr-1"></i>${user}</span>`;
                else userLabel = `<span class="text-[10px] font-bold text-slate-400 block mb-0.5 ml-1">${user}</span>`;
            }
            
            // Icon status (Hanya untuk saya)
            const statusIcon = isMe ? `<i class="fa-solid fa-check text-blue-300 ml-1 text-[10px]"></i>` : '';

            const html = `
                <div class="flex ${align} mb-2 animate-fade-in-up">
                    <div class="max-w-[85%]">
                        ${userLabel}
                        <div class="px-3 py-2 rounded-2xl text-xs leading-relaxed shadow-sm ${bubbleColor} break-words">
                            ${msg} ${statusIcon}
                        </div>
                    </div>
                </div>`;
            
            chatBox.insertAdjacentHTML('beforeend', html);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Menerima Pesan (Filter Privasi)
        socket.on('chat-message', (data) => {
            if (data.user === namaSiswa) return; // Skip punya sendiri (sudah tampil via optimistic)
            
            // Filter: Hanya tampilkan pesan Guru
            if (data.role === 'Guru') {
                appendMessageToUI(data.user, data.msg, false, 'Guru');
            }
            // Pesan murid lain di-ignore (Ghosting) agar privat
        });

        document.getElementById('chat-input').addEventListener('keypress', (e) => { 
            if(e.key === 'Enter') sendChat(); 
        });

        // --- 3. KAMERA & VIDEO ---
        async function startCamera() {
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                setupVideoElement(myStream);
                isCameraOn = true;
                socket.emit('join-live', { room: currentRoom, nama: namaSiswa });
                sendFrameToGuru();
                updateControlUI();
                showCuteAlert('Kamera Aktif', 'üìπ');
            } catch (err) { showCuteAlert('Gagal Akses Kamera', '‚ùå'); }
        }

        function setupVideoElement(stream) {
            const container = document.getElementById('cam-container');
            container.innerHTML = '';
            const video = document.createElement('video');
            video.id = 'video-element'; video.srcObject = stream; video.autoplay = true; video.muted = true; video.setAttribute('playsinline', 'true');
            container.appendChild(video);
        }

        function toggleMic() {
            if (!myStream) { showCuteAlert('Nyalakan kamera dulu!', '‚ö†Ô∏è'); return; }
            const track = myStream.getAudioTracks()[0];
            if (track) { track.enabled = !track.enabled; showCuteAlert(track.enabled ? 'Mic Nyala' : 'Mic Mati', track.enabled ? 'üé§' : 'üîá'); }
        }

        function toggleCamera() {
            if (!myStream) { startCamera(); return; }
            const track = myStream.getVideoTracks()[0];
            if (track) {
                track.enabled = !track.enabled;
                isCameraOn = track.enabled;
                if(!isCameraOn) document.getElementById('cam-container').innerHTML = `<div class="flex flex-col items-center text-slate-500"><i class="fa-solid fa-video-slash mb-1"></i><span class="text-[8px] font-bold uppercase">Kamera Mati</span></div>`;
                else setupVideoElement(myStream);
                updateControlUI();
            }
        }

        function updateControlUI() {
            const btnCam = document.getElementById('btn-cam');
            const statusText = document.getElementById('my-status-text');
            if (isCameraOn) {
                btnCam.className = "ctrl-btn bg-emerald-500 text-white border-transparent";
                statusText.innerHTML = `<i class="fa-solid fa-video mr-1 text-emerald-400"></i> Kamera ON`;
            } else {
                btnCam.className = "ctrl-btn bg-rose-500 text-white border-transparent";
                statusText.innerHTML = `<i class="fa-solid fa-pause mr-1 text-amber-400"></i> Siap Belajar`;
            }
        }

        function sendFrameToGuru() {
            if(!isCameraOn || !myStream) { setTimeout(sendFrameToGuru, 1000); return; }
            const video = document.getElementById('video-element');
            const canvas = document.getElementById('hidden-canvas');
            const ctx = canvas.getContext('2d');
            if (video && video.readyState === video.HAVE_ENOUGH_DATA) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                socket.emit('stream-frame', { room: currentRoom, image: canvas.toDataURL('image/jpeg', 0.4) });
            }
            setTimeout(sendFrameToGuru, 250); 
        }

        socket.on('stream-frame', (data) => {
            const img = document.getElementById('teacher-video-stream');
            if(img && data.role === 'Guru') {
                img.src = data.image; img.classList.remove('opacity-0');
                document.getElementById('video-placeholder').classList.add('hidden');
                document.getElementById('status-live-indicator').classList.remove('hidden');
            }
        });

        // --- 4. KUIS & ALERT ---
        socket.on('start-quiz', (data) => {
            currentQuizData = data; 
            showCuteAlert('Asyik, Kuis Dimulai!', 'üìù');
            const contentDiv = document.getElementById('quiz-panel-content');
            const timerDiv = document.getElementById('quiz-timer');
            const btnBar = document.getElementById('quiz-action-bar');
            
            timerDiv.innerHTML = `<i class="fa-solid fa-pen-nib mr-1"></i> ${data.judul}`; 
            btnBar.classList.remove('hidden'); 

            let html = "";
            if(data.soal_pg && data.soal_pg.length > 0) {
                html += `<div class="mb-6"><h4 class="text-xs font-bold text-amber-300 uppercase mb-3 border-b border-white/10 pb-2">A. Pilihan Ganda</h4>`;
                html += data.soal_pg.map((s, idx) => `
                    <div class="pg-item mb-5" data-index="${idx}">
                        <p class="font-bold text-slate-200 mb-2 text-xs leading-relaxed"><span class="text-amber-400 mr-1">${idx + 1}.</span> ${s.q}</p>
                        <div class="grid gap-2">
                            ${s.a.map(opsi => `<button onclick="selectOption(this)" class="option-btn w-full text-left p-3 bg-slate-800/50 rounded-xl border border-slate-700 hover:bg-blue-600 hover:border-blue-400 hover:text-white transition-all text-xs text-slate-300 font-medium">${opsi}</button>`).join('')}
                        </div>
                    </div>`).join('');
                html += `</div>`;
            }
            if(data.soal_essay && data.soal_essay.length > 0) {
                html += `<div class="mb-2"><h4 class="text-xs font-bold text-purple-300 uppercase mb-3 border-b border-white/10 pb-2">B. Essay</h4>`;
                html += data.soal_essay.map((e, idx) => `
                    <div class="essay-item mb-5">
                        <p class="font-bold text-slate-200 mb-2 text-xs"><span class="text-purple-400 mr-1">${idx + 1}.</span> ${e.q}</p>
                        <textarea class="essay-ans w-full p-3 rounded-xl bg-slate-800/50 border border-slate-700 text-white text-xs h-24 focus:border-purple-400 focus:ring-1 focus:ring-purple-400 outline-none resize-none placeholder-slate-500 transition-all" placeholder="Tulis jawabanmu di sini ya..."></textarea>
                    </div>`).join('');
                html += `</div>`;
            }
            contentDiv.innerHTML = html;
        });

        function selectOption(btn) {
            btn.closest('.pg-item').querySelectorAll('.option-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white', 'border-blue-400', 'option-selected', 'shadow-lg');
                b.classList.add('bg-slate-800/50', 'text-slate-300');
            });
            btn.classList.remove('bg-slate-800/50', 'text-slate-300');
            btn.classList.add('bg-blue-600', 'text-white', 'border-blue-400', 'option-selected', 'shadow-lg');
        }

        function finishQuiz() {
            const pgAnswers = [];
            document.querySelectorAll('.pg-item').forEach(item => {
                const selected = item.querySelector('.option-selected');
                pgAnswers.push(selected ? selected.innerText.trim() : "");
            });
            const essayAnswers = [];
            document.querySelectorAll('.essay-ans').forEach(txt => {
                essayAnswers.push(txt.value.trim());
            });

            const contentDiv = document.getElementById('quiz-panel-content');
            const btnBar = document.getElementById('quiz-action-bar');
            
            btnBar.classList.add('hidden');
            contentDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full space-y-4 animate-fade-in-up"><div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div><p class="text-sm font-bold text-slate-300">Sedang mengirim jawaban...</p></div>`;
            
            socket.emit('submit-jawaban-siswa', {
                name: namaSiswa, email: emailSiswa, kelas: kelasTersimpan || 'Umum', room: currentRoom,
                materi_judul: currentQuizData ? currentQuizData.judul : "Kuis Live",
                jawabanMurid: { pg: pgAnswers, essay: essayAnswers }
            });
        }
        
        socket.on('score-updated-live', (data) => {
            if(data.nama_siswa === namaSiswa) {
                const contentDiv = document.getElementById('quiz-panel-content');
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center p-6 animate-fade-in-up">
                        <div class="text-5xl mb-4 drop-shadow-lg">üåü</div>
                        <h3 class="font-bold text-amber-400 text-lg mb-2">Hebat!</h3>
                        <div class="bg-slate-800/60 p-4 rounded-2xl border border-white/10 w-full backdrop-blur-sm">
                            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Skor Kamu</p>
                            <div class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-teal-300 drop-shadow-sm">${data.skor}</div>
                            <div class="mt-3 text-xs text-slate-300 italic border-t border-white/10 pt-3">
                                "${data.umpan_balik || "Terus semangat belajar ya!"}"
                            </div>
                        </div>
                    </div>`;
            }
        });

        function toggleFullscreen() {
            const stage = document.getElementById('main-stage');
            if (!document.fullscreenElement) stage.requestFullscreen().catch(()=>{});
            else document.exitFullscreen();
        }
        function showCuteAlert(msg, icon) {
            const alert = document.getElementById('cuteAlert');
            document.getElementById('cuteMsg').innerText = msg;
            document.getElementById('cuteIcon').innerText = icon;
            alert.style.top = "20px";
            setTimeout(() => alert.style.top = "-100px", 3000);
        }
    </script>
</body>
</html>
