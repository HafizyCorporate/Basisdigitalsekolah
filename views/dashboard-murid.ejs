<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Student Space - Ramadan Ceria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- TEMA RAMADAN CERIA (KID FRIENDLY) --- */
        body { 
            font-family: 'Quicksand', sans-serif; 
            background: radial-gradient(circle at top, #1e1b4b, #0f172a, #020617);
            background-attachment: fixed;
            color: #e2e8f0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }

        /* Pattern Bintang Samar-samar */
        body::before {
            content: "";
            position: absolute; inset: 0; z-index: -1;
            background-image: radial-gradient(white 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.1;
        }
        
        /* Ornamen Animasi */
        @keyframes sway { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .ornament { animation: sway 4s infinite ease-in-out; transform-origin: top center; }

        /* LAYOUT */
        .main-layout {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 320px; 
            gap: 1rem;
            padding: 1rem;
            overflow: hidden; 
            position: relative;
            z-index: 10; 
        }

        /* VIDEO STAGE */
        #main-stage { 
            position: relative; 
            background: #000; 
            border-radius: 1.5rem; 
            overflow: hidden; 
            border: 2px solid #475569; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            display: flex; flex-direction: column; justify-content: center;
            width: 100%;
            min-height: 250px;
        }

        /* VIDEO GURU (UTAMA) */
        #teacher-video-stream { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            background: #000; 
        }
        
        /* PIP (KAMERA MURID) */
        #student-pip-wrapper {
            position: absolute; z-index: 20; background: #0f172a;
            border-radius: 1rem; overflow: hidden; 
            border: 3px solid #fbbf24; /* Border Emas */
            bottom: 5rem; right: 1rem; width: 140px; aspect-ratio: 4/3;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        #local-video {
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);
        }

        /* CONTROLS */
        .video-controls {
            position: absolute; bottom: 0; left: 0; right: 0; padding: 1rem;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            display: flex; align-items: center; justify-content: space-between; gap: 1rem; z-index: 30;
        }

        .ctrl-btn {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; cursor: pointer;
            background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(5px); 
            border: 1px solid rgba(255,255,255,0.3);
            transition: transform 0.1s;
        }
        .ctrl-btn.active { background: #10b981; border-color: #10b981; } /* Hijau saat nyala */
        .ctrl-btn.danger { background: #ef4444; border-color: #ef4444; }

        /* SIDEBAR CHAT */
        #sidebar-col { 
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px);
            border-radius: 1.5rem; border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden; display: flex; flex-direction: column; 
        }

        /* Responsive */
        @media (max-width: 1024px) {
            body { height: auto; overflow-y: auto; }
            .main-layout { display: flex; flex-direction: column; padding: 0.8rem; gap: 1rem; height: auto; }
            #sidebar-col { min-height: 400px; margin-bottom: 2rem; }
            #main-stage { aspect-ratio: 16/9; flex-shrink: 0; }
        }
        
        #customAlert { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); transition: top 0.5s; z-index: 100; background: white; color: black; padding: 10px 20px; rounded-full; font-weight: bold; border: 2px solid #e2e8f0; display: flex; align-items: center; gap: 8px; }
        .alert-active { top: 30px !important; }
    </style>
</head>
<body>

    <div id="customAlert">
        <span id="alertIcon" class="text-xl"></span>
        <span id="alertMsg">Info</span>
    </div>

    <nav class="h-[70px] flex-none flex justify-between items-center px-4 md:px-6 bg-slate-900/80 border-b border-white/10 z-50 backdrop-blur-md sticky top-0">
        
        <div class="absolute top-0 left-10 hidden md:flex gap-4">
            <div class="flex flex-col items-center ornament"><div class="h-8 w-0.5 bg-amber-400/50"></div><i class="fa-solid fa-star text-amber-400 text-xl"></i></div>
        </div>

        <div class="flex items-center gap-3 z-10 pl-0 md:pl-20"> 
            <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-emerald-500 to-teal-400 flex items-center justify-center text-white text-sm shadow-lg border-2 border-white/20">
                <i class="fa-solid fa-user-astronaut"></i>
            </div>
            <div class="flex flex-col justify-center">
                <h1 class="font-bold text-white text-sm leading-tight">Halo, <%= nama_siswa.split(' ')[0] %>! üëã</h1>
                <p class="text-[10px] text-emerald-300 font-semibold bg-emerald-900/50 px-2 py-0.5 rounded-full inline-block mt-0.5 w-fit">Siap Belajar üöÄ</p>
            </div>
        </div>
        
        <div class="flex items-center gap-2 z-10">
            <select id="select-kelas-murid" onchange="muridPindahKelas()" class="bg-slate-800 border border-slate-600 text-white text-xs rounded-xl py-2 pl-3 pr-8 outline-none focus:border-amber-400">
                <option value="">-- Pilih Kelas --</option>
            </select>
        </div>
    </nav>

    <div class="main-layout">
        
        <div id="main-stage">
            
            <video id="teacher-video-stream" autoplay playsinline></video>
            
            <div id="video-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 bg-slate-950 z-0">
                <div class="relative mb-4">
                    <div class="w-20 h-20 rounded-full bg-slate-900 flex items-center justify-center border-2 border-slate-700 animate-pulse">
                        <i class="fa-solid fa-chalkboard-user text-3xl text-slate-600"></i>
                    </div>
                </div>
                <p class="font-bold text-sm">Menunggu Guru...</p>
                <p class="text-xs opacity-60 mt-1">Pastikan kamu di kelas yang benar</p>
            </div>
            
            <div id="student-pip-wrapper">
                <video id="local-video" autoplay playsinline muted></video>
            </div>

            <div class="video-controls">
                <div class="flex gap-3">
                    <button id="btn-mic" onclick="toggleMic()" class="ctrl-btn text-white hover:bg-white/10" title="Mic">
                        <i id="icon-mic" class="fa-solid fa-microphone-slash"></i>
                    </button>
                    <button id="btn-cam" onclick="toggleCamera()" class="ctrl-btn text-white hover:bg-white/10" title="Kamera">
                        <i id="icon-cam" class="fa-solid fa-video-slash"></i>
                    </button>
                </div>
                <span id="my-status-text" class="text-[10px] bg-black/60 px-3 py-1.5 rounded-full text-white backdrop-blur-md border border-white/10 font-semibold shadow-sm">
                    Kamera Off
                </span>
                <button onclick="toggleFullscreen()" class="ctrl-btn text-white hover:bg-white/10"><i class="fa-solid fa-expand"></i></button>
            </div>
        </div>

        <div id="sidebar-col">
            <div id="quiz-panel" class="hidden p-4 bg-slate-900/50 border-b border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-amber-400 text-xs"><i class="fa-solid fa-star mr-1"></i> Kuis Aktif</h3>
                    <button onclick="closeQuizPanel()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div id="quiz-content" class="text-xs text-slate-300 max-h-40 overflow-y-auto space-y-2"></div>
                <button onclick="finishQuiz()" class="w-full mt-3 bg-emerald-600 text-white py-2 rounded-lg text-xs font-bold shadow hover:bg-emerald-500">Kirim Jawaban</button>
            </div>

            <div class="flex-1 flex flex-col min-h-0">
                <div class="px-4 py-3 border-b border-white/5 flex justify-between items-center">
                    <span class="text-xs font-bold text-white uppercase tracking-wider flex items-center gap-2">
                        <i class="fa-regular fa-comments text-blue-400"></i> Obrolan
                    </span>
                    <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span class="text-[9px] text-emerald-400 font-bold">Online</span>
                    </div>
                </div>
                
                <div id="chat-box" class="flex-1 overflow-y-auto p-3 space-y-2 text-xs text-slate-200">
                    <div class="text-center text-[10px] text-slate-500 italic py-4">Belum ada pesan.</div>
                </div>

                <div class="p-2 border-t border-white/5 bg-black/20">
                    <div class="flex gap-2">
                        <input id="chat-input" type="text" placeholder="Tanya guru..." class="w-full bg-slate-800 border border-slate-600 text-white rounded-xl px-3 py-2 text-xs outline-none focus:border-blue-400">
                        <button onclick="sendChat()" class="bg-blue-600 text-white w-9 rounded-xl flex items-center justify-center shadow-lg active:scale-95">
                            <i class="fa-solid fa-paper-plane text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const namaSiswa = "<%= typeof nama_siswa !== 'undefined' ? nama_siswa : 'Siswa' %>";
        const emailSiswa = "<%= typeof email_siswa !== 'undefined' ? email_siswa : 'email@test.com' %>"; 
        const kodeSekolah = "<%= typeof kode_sekolah !== 'undefined' ? kode_sekolah : 'SCH' %>";
        let kelasTersimpan = "<%= typeof kelas_siswa !== 'undefined' ? kelas_siswa : '' %>"; 
        
        let currentRoom = kodeSekolah; 
        let isCameraOn = false;
        let isMuted = true;
        let localStream;
        let peerGuru; // Koneksi WebRTC ke Guru
        let currentQuizData = null;

        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // --- 1. SETUP AWAL ---
        async function init() {
            try {
                // Ambil daftar kelas
                const res = await fetch(`/api/kelas/${kodeSekolah}`);
                const data = await res.json();
                document.getElementById('select-kelas-murid').innerHTML = '<option value="">-- Pilih Kelas --</option>' + 
                    data.map(k => `<option value="${k.nama_kelas}">${k.nama_kelas}</option>`).join('');
                
                if(kelasTersimpan) {
                    document.getElementById('select-kelas-murid').value = kelasTersimpan;
                    joinRoom(kelasTersimpan);
                }
                
                // Nyalakan kamera otomatis saat masuk (Muted by default)
                await startCamera();
            } catch(e) { console.log("Init Error:", e); }
        }

        function muridPindahKelas() {
            const k = document.getElementById('select-kelas-murid').value;
            if(k) {
                fetch('/api/update-kelas-siswa', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: emailSiswa, kelas: k }) }).catch(()=>{});
                joinRoom(k);
            }
        }

        function joinRoom(namaKelas) {
            currentRoom = `${kodeSekolah}-${namaKelas}`;
            socket.emit('join-room', { roomID: currentRoom, userName: namaSiswa, role: 'Siswa' });
            
            // Reset koneksi jika pindah kelas
            if(peerGuru) {
                peerGuru.close();
                peerGuru = null;
            }
            
            document.getElementById('chat-box').innerHTML = '<div class="text-center text-[10px] text-slate-500 italic py-4">Masuk ke kelas baru...</div>';
            showAlert(`Bergabung ke ${namaKelas}`, "üè´");
        }

        // --- 2. WEBRTC SIGNALING (VIDEO & AUDIO) ---

        // Fungsi membuat Peer Connection
        function createPeer(teacherId) {
            console.log("Creating Peer to Guru:", teacherId);
            peerGuru = new RTCPeerConnection(rtcConfig);
            
            // Tambahkan Stream Lokal (Video/Audio Murid) ke koneksi
            if(localStream) {
                localStream.getTracks().forEach(track => peerGuru.addTrack(track, localStream));
            }

            // Saat Video/Audio Guru masuk
            peerGuru.ontrack = (event) => {
                console.log("Stream Guru Masuk!");
                const vid = document.getElementById('teacher-video-stream');
                vid.srcObject = event.streams[0];
                document.getElementById('video-placeholder').classList.add('hidden');
            };

            // ICE Candidate
            peerGuru.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('student-signal', { targetId: teacherId, signal: { candidate: event.candidate } });
                }
            };
        }

        // Skenario 1: Guru memanggil (karena guru sudah ada di room)
        socket.on('teacher-signal', async (data) => {
            // data.signal bisa berupa offer, answer, atau candidate
            
            if (data.signal.type === 'offer') {
                // Guru menginisiasi panggilan
                createPeer(data.senderId);
                await peerGuru.setRemoteDescription(new RTCSessionDescription(data.signal));
                const answer = await peerGuru.createAnswer();
                await peerGuru.setLocalDescription(answer);
                socket.emit('student-signal', { targetId: data.senderId, signal: answer });
            } 
            else if (data.signal.type === 'answer') {
                // Jawaban dari Guru (jika murid yang inisiasi)
                if(peerGuru) await peerGuru.setRemoteDescription(new RTCSessionDescription(data.signal));
            }
            else if (data.signal.candidate) {
                // Kandidat Jaringan
                if(peerGuru) await peerGuru.addIceCandidate(new RTCIceCandidate(data.signal.candidate));
            }
        });

        // Skenario 2: Guru baru masuk/refresh (Broadcast 'teacher-ready')
        socket.on('teacher-ready', async (data) => {
            console.log("Guru Ready, initiating call...");
            createPeer(data.teacherId);
            const offer = await peerGuru.createOffer();
            await peerGuru.setLocalDescription(offer);
            socket.emit('student-signal', { targetId: data.teacherId, signal: offer });
        });


        // --- 3. KAMERA & MIC ---
        async function startCamera() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('local-video').srcObject = localStream;
                
                // Default: Kamera Nyala, Mic Mati (biar gak berisik)
                isCameraOn = true;
                isMuted = true;
                localStream.getAudioTracks()[0].enabled = false; 
                
                updateControlUI();
            } catch(e) { 
                console.error(e);
                showAlert("Gagal akses kamera", "‚ùå");
            }
        }

        function toggleMic() {
            if(!localStream) return;
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            isMuted = !track.enabled;
            updateControlUI();
            showAlert(isMuted ? "Mic Mati" : "Mic Nyala", isMuted ? "üîá" : "üéôÔ∏è");
        }

        function toggleCamera() {
            if(!localStream) return;
            const track = localStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            isCameraOn = track.enabled;
            updateControlUI();
            
            // UI Feedback di PIP
            const pip = document.getElementById('student-pip-wrapper');
            if(!isCameraOn) pip.innerHTML = '<div class="w-full h-full bg-slate-900 flex items-center justify-center text-[8px] text-slate-500 font-bold">OFF</div>';
            else {
                pip.innerHTML = '';
                const v = document.createElement('video');
                v.id = 'local-video'; v.autoplay = true; v.playsInline = true; v.muted = true;
                v.srcObject = localStream;
                pip.appendChild(v);
            }
        }

        function updateControlUI() {
            const btnCam = document.getElementById('btn-cam');
            const btnMic = document.getElementById('btn-mic');
            const iconCam = btnCam.querySelector('i');
            const iconMic = btnMic.querySelector('i');
            const status = document.getElementById('my-status-text');

            if(isCameraOn) {
                btnCam.classList.add('active');
                iconCam.className = "fa-solid fa-video";
            } else {
                btnCam.classList.remove('active');
                iconCam.className = "fa-solid fa-video-slash";
            }

            if(!isMuted) {
                btnMic.classList.add('active');
                iconMic.className = "fa-solid fa-microphone";
            } else {
                btnMic.classList.remove('active');
                iconMic.className = "fa-solid fa-microphone-slash";
            }
            
            status.innerText = isCameraOn ? "Kamera ON" : "Kamera OFF";
        }

        // --- 4. CHAT (OPTIMISTIC UI & PRIVACY) ---
        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(msg) {
                addChatBubble(namaSiswa, msg, true); // Tampil langsung
                socket.emit('chat-message', { room: currentRoom, user: namaSiswa, msg: msg, role: 'Siswa' });
                input.value = '';
            }
        }

        socket.on('chat-message', (data) => {
            if(data.user === namaSiswa) return; // Skip punya sendiri
            
            // Murid hanya melihat pesan Guru (Privacy)
            if(data.role === 'Guru') {
                addChatBubble(data.user, data.msg, false, true);
            }
        });

        function addChatBubble(user, msg, isMe, isGuru = false) {
            const box = document.getElementById('chat-box');
            if(box.innerText.includes('Belum ada')) box.innerHTML = '';

            const align = isMe ? 'items-end' : 'items-start';
            const bg = isMe 
                ? 'bg-blue-600 text-white rounded-tr-none' 
                : (isGuru ? 'bg-amber-600 text-white border border-amber-400' : 'bg-slate-700 text-slate-300');
            
            const html = `
                <div class="flex flex-col ${align} animate-[fadeIn_0.3s]">
                    <span class="text-[9px] text-slate-400 mb-1 font-bold ml-1">${user}</span>
                    <div class="${bg} px-3 py-2 rounded-2xl ${isMe ? 'rounded-tr-none' : 'rounded-tl-none'} text-xs max-w-[90%] shadow-sm leading-relaxed">${msg}</div>
                </div>`;
            box.insertAdjacentHTML('beforeend', html);
            box.scrollTop = box.scrollHeight;
        }

        // --- 5. KUIS ---
        socket.on('start-quiz', (data) => {
            currentQuizData = data;
            const panel = document.getElementById('quiz-panel');
            const content = document.getElementById('quiz-content');
            panel.classList.remove('hidden');
            
            let html = `<div class="font-bold text-amber-300 mb-2">${data.judul || 'Kuis Baru'}</div>`;
            
            if(data.soal_pg) {
                html += data.soal_pg.map((s,i) => `
                    <div class="mb-3 pg-item">
                        <p class="mb-1">${i+1}. ${s.q}</p>
                        ${s.a.map(opt => `<button onclick="selectOpt(this)" class="opt-btn w-full text-left p-2 bg-slate-800 border border-slate-700 rounded hover:bg-blue-600 transition mb-1">${opt}</button>`).join('')}
                    </div>`).join('');
            }
            if(data.soal_essay) {
                html += data.soal_essay.map((s,i) => `
                    <div class="mb-3">
                        <p class="mb-1">Essay: ${s.q}</p>
                        <textarea class="essay-ans w-full bg-slate-800 border border-slate-700 rounded p-2 text-white h-20"></textarea>
                    </div>`).join('');
            }
            content.innerHTML = html;
            showAlert("Kuis dimulai!", "üìù");
        });

        function selectOpt(btn) {
            const parent = btn.parentElement;
            parent.querySelectorAll('.opt-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'border-blue-400', 'selected');
                b.classList.add('bg-slate-800');
            });
            btn.classList.remove('bg-slate-800');
            btn.classList.add('bg-blue-600', 'border-blue-400', 'selected');
        }

        function finishQuiz() {
            const pgAnswers = [];
            document.querySelectorAll('.pg-item').forEach(div => {
                const sel = div.querySelector('.selected');
                pgAnswers.push(sel ? sel.innerText : "");
            });
            const essayAnswers = [];
            document.querySelectorAll('.essay-ans').forEach(txt => essayAnswers.push(txt.value));

            socket.emit('submit-jawaban-siswa', {
                name: namaSiswa, email: emailSiswa, kelas: kelasTersimpan || 'Umum', room: currentRoom,
                materi_judul: currentQuizData ? currentQuizData.judul : "Kuis Live",
                jawabanMurid: { pg: pgAnswers, essay: essayAnswers }
            });
            
            document.getElementById('quiz-content').innerHTML = '<div class="text-center text-green-400 font-bold py-4">Jawaban Terkirim!</div>';
            setTimeout(() => document.getElementById('quiz-panel').classList.add('hidden'), 2000);
        }

        socket.on('score-updated-live', (data) => {
            if(data.nama_siswa === namaSiswa) {
                showAlert(`Nilai Kamu: ${data.skor}`, "‚≠ê");
                addChatBubble("Sistem", `Hasil Kuis: Skor ${data.skor}. ${data.umpan_balik}`, false, true);
            }
        });

        // Utils
        function closeQuizPanel() { document.getElementById('quiz-panel').classList.add('hidden'); }
        function toggleFullscreen() {
            const stage = document.getElementById('main-stage');
            if (!document.fullscreenElement) stage.requestFullscreen().catch(()=>{});
            else document.exitFullscreen();
        }
        function showAlert(msg, icon) {
            const el = document.getElementById('customAlert');
            document.getElementById('alertMsg').innerText = msg;
            document.getElementById('alertIcon').innerText = icon;
            el.classList.add('alert-active');
            setTimeout(() => el.classList.remove('alert-active'), 3000);
        }
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendChat(); });

        init();
    </script>
</body>
</html>
